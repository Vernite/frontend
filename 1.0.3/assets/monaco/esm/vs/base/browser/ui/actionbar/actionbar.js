var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import*as DOM from"../../dom.js";import{StandardKeyboardEvent}from"../../keyboardEvent.js";import{ActionViewItem,BaseActionViewItem}from"./actionViewItems.js";import{ActionRunner,Separator}from"../../../common/actions.js";import{Emitter}from"../../../common/event.js";import{Disposable,dispose}from"../../../common/lifecycle.js";import*as types from"../../../common/types.js";import"./actionbar.css";export class ActionBar extends Disposable{constructor(container,options={}){var _a,_b,_c,_d,_e,_f;let previousKeys,nextKeys;switch(super(),this.triggerKeyDown=!1,this.focusable=!0,this._onDidBlur=this._register(new Emitter),this.onDidBlur=this._onDidBlur.event,this._onDidCancel=this._register(new Emitter({onFirstListenerAdd:()=>this.cancelHasListener=!0})),this.onDidCancel=this._onDidCancel.event,this.cancelHasListener=!1,this._onDidRun=this._register(new Emitter),this.onDidRun=this._onDidRun.event,this._onBeforeRun=this._register(new Emitter),this.onBeforeRun=this._onBeforeRun.event,this.options=options,this._context=null!==(_a=options.context)&&void 0!==_a?_a:null,this._orientation=null!==(_b=this.options.orientation)&&void 0!==_b?_b:0,this._triggerKeys={keyDown:null!==(_d=null===(_c=this.options.triggerKeys)||void 0===_c?void 0:_c.keyDown)&&void 0!==_d&&_d,keys:null!==(_f=null===(_e=this.options.triggerKeys)||void 0===_e?void 0:_e.keys)&&void 0!==_f?_f:[3,10]},this.options.actionRunner?this._actionRunner=this.options.actionRunner:(this._actionRunner=new ActionRunner,this._register(this._actionRunner)),this._register(this._actionRunner.onDidRun((e=>this._onDidRun.fire(e)))),this._register(this._actionRunner.onBeforeRun((e=>this._onBeforeRun.fire(e)))),this._actionIds=[],this.viewItems=[],this.viewItemDisposables=new Map,this.focusedItem=void 0,this.domNode=document.createElement("div"),this.domNode.className="monaco-action-bar",!1!==options.animated&&this.domNode.classList.add("animated"),this._orientation){case 0:previousKeys=[15],nextKeys=[17];break;case 1:previousKeys=[16],nextKeys=[18],this.domNode.className+=" vertical"}this._register(DOM.addDisposableListener(this.domNode,DOM.EventType.KEY_DOWN,(e=>{const event=new StandardKeyboardEvent(e);let eventHandled=!0;const focusedItem="number"==typeof this.focusedItem?this.viewItems[this.focusedItem]:void 0;previousKeys&&(event.equals(previousKeys[0])||event.equals(previousKeys[1]))?eventHandled=this.focusPrevious():nextKeys&&(event.equals(nextKeys[0])||event.equals(nextKeys[1]))?eventHandled=this.focusNext():event.equals(9)&&this.cancelHasListener?this._onDidCancel.fire():event.equals(14)?eventHandled=this.focusFirst():event.equals(13)?eventHandled=this.focusLast():event.equals(2)&&focusedItem instanceof BaseActionViewItem&&focusedItem.trapsArrowNavigation?eventHandled=this.focusNext():this.isTriggerKeyEvent(event)?this._triggerKeys.keyDown?this.doTrigger(event):this.triggerKeyDown=!0:eventHandled=!1,eventHandled&&(event.preventDefault(),event.stopPropagation())}))),this._register(DOM.addDisposableListener(this.domNode,DOM.EventType.KEY_UP,(e=>{const event=new StandardKeyboardEvent(e);this.isTriggerKeyEvent(event)?(!this._triggerKeys.keyDown&&this.triggerKeyDown&&(this.triggerKeyDown=!1,this.doTrigger(event)),event.preventDefault(),event.stopPropagation()):(event.equals(2)||event.equals(1026))&&this.updateFocusedItem()}))),this.focusTracker=this._register(DOM.trackFocus(this.domNode)),this._register(this.focusTracker.onDidBlur((()=>{DOM.getActiveElement()!==this.domNode&&DOM.isAncestor(DOM.getActiveElement(),this.domNode)||(this._onDidBlur.fire(),this.focusedItem=void 0,this.previouslyFocusedItem=void 0,this.triggerKeyDown=!1)}))),this._register(this.focusTracker.onDidFocus((()=>this.updateFocusedItem()))),this.actionsList=document.createElement("ul"),this.actionsList.className="actions-container",this.actionsList.setAttribute("role",this.options.ariaRole||"toolbar"),this.options.ariaLabel&&this.actionsList.setAttribute("aria-label",this.options.ariaLabel),this.domNode.appendChild(this.actionsList),container.appendChild(this.domNode)}refreshRole(){this.length()>=2?this.actionsList.setAttribute("role",this.options.ariaRole||"toolbar"):this.actionsList.setAttribute("role","presentation")}setFocusable(focusable){if(this.focusable=focusable,this.focusable){const firstEnabled=this.viewItems.find((vi=>vi instanceof BaseActionViewItem&&vi.isEnabled()));firstEnabled instanceof BaseActionViewItem&&firstEnabled.setFocusable(!0)}else this.viewItems.forEach((vi=>{vi instanceof BaseActionViewItem&&vi.setFocusable(!1)}))}isTriggerKeyEvent(event){let ret=!1;return this._triggerKeys.keys.forEach((keyCode=>{ret=ret||event.equals(keyCode)})),ret}updateFocusedItem(){for(let i=0;i<this.actionsList.children.length;i++){const elem=this.actionsList.children[i];if(DOM.isAncestor(DOM.getActiveElement(),elem)){this.focusedItem=i;break}}}get context(){return this._context}set context(context){this._context=context,this.viewItems.forEach((i=>i.setActionContext(context)))}get actionRunner(){return this._actionRunner}set actionRunner(actionRunner){actionRunner&&(this._actionRunner=actionRunner,this.viewItems.forEach((item=>item.actionRunner=actionRunner)))}getContainer(){return this.domNode}push(arg,options={}){const actions=Array.isArray(arg)?arg:[arg];let index=types.isNumber(options.index)?options.index:null;actions.forEach((action=>{const actionViewItemElement=document.createElement("li");let item;actionViewItemElement.className="action-item",actionViewItemElement.setAttribute("role","presentation"),this.options.actionViewItemProvider&&(item=this.options.actionViewItemProvider(action)),item||(item=new ActionViewItem(this.context,action,Object.assign({hoverDelegate:this.options.hoverDelegate},options))),this.options.allowContextMenu||this.viewItemDisposables.set(item,DOM.addDisposableListener(actionViewItemElement,DOM.EventType.CONTEXT_MENU,(e=>{DOM.EventHelper.stop(e,!0)}))),item.actionRunner=this._actionRunner,item.setActionContext(this.context),item.render(actionViewItemElement),this.focusable&&item instanceof BaseActionViewItem&&0===this.viewItems.length&&item.setFocusable(!0),null===index||index<0||index>=this.actionsList.children.length?(this.actionsList.appendChild(actionViewItemElement),this.viewItems.push(item),this._actionIds.push(action.id)):(this.actionsList.insertBefore(actionViewItemElement,this.actionsList.children[index]),this.viewItems.splice(index,0,item),this._actionIds.splice(index,0,action.id),index++)})),"number"==typeof this.focusedItem&&this.focus(this.focusedItem),this.refreshRole()}clear(){dispose(this.viewItems),this.viewItemDisposables.forEach((d=>d.dispose())),this.viewItemDisposables.clear(),this.viewItems=[],this._actionIds=[],DOM.clearNode(this.actionsList),this.refreshRole()}length(){return this.viewItems.length}focus(arg){let index,selectFirst=!1;if(void 0===arg?selectFirst=!0:"number"==typeof arg?index=arg:"boolean"==typeof arg&&(selectFirst=arg),selectFirst&&void 0===this.focusedItem){const firstEnabled=this.viewItems.findIndex((item=>item.isEnabled()));this.focusedItem=-1===firstEnabled?void 0:firstEnabled,this.updateFocus(void 0,void 0,!0)}else void 0!==index&&(this.focusedItem=index),this.updateFocus(void 0,void 0,!0)}focusFirst(){return this.focusedItem=this.length()-1,this.focusNext(!0)}focusLast(){return this.focusedItem=0,this.focusPrevious(!0)}focusNext(forceLoop){if(void 0===this.focusedItem)this.focusedItem=this.viewItems.length-1;else if(this.viewItems.length<=1)return!1;const startIndex=this.focusedItem;let item;do{if(!forceLoop&&this.options.preventLoopNavigation&&this.focusedItem+1>=this.viewItems.length)return this.focusedItem=startIndex,!1;this.focusedItem=(this.focusedItem+1)%this.viewItems.length,item=this.viewItems[this.focusedItem]}while(this.focusedItem!==startIndex&&(this.options.focusOnlyEnabledItems&&!item.isEnabled()||item.action.id===Separator.ID));return this.updateFocus(),!0}focusPrevious(forceLoop){if(void 0===this.focusedItem)this.focusedItem=0;else if(this.viewItems.length<=1)return!1;const startIndex=this.focusedItem;let item;do{if(this.focusedItem=this.focusedItem-1,this.focusedItem<0){if(!forceLoop&&this.options.preventLoopNavigation)return this.focusedItem=startIndex,!1;this.focusedItem=this.viewItems.length-1}item=this.viewItems[this.focusedItem]}while(this.focusedItem!==startIndex&&(this.options.focusOnlyEnabledItems&&!item.isEnabled()||item.action.id===Separator.ID));return this.updateFocus(!0),!0}updateFocus(fromRight,preventScroll,forceFocus=!1){var _a;void 0===this.focusedItem&&this.actionsList.focus({preventScroll}),void 0!==this.previouslyFocusedItem&&this.previouslyFocusedItem!==this.focusedItem&&(null===(_a=this.viewItems[this.previouslyFocusedItem])||void 0===_a||_a.blur());const actionViewItem=void 0!==this.focusedItem&&this.viewItems[this.focusedItem];if(actionViewItem){let focusItem=!0;types.isFunction(actionViewItem.focus)||(focusItem=!1),this.options.focusOnlyEnabledItems&&types.isFunction(actionViewItem.isEnabled)&&!actionViewItem.isEnabled()&&(focusItem=!1),actionViewItem.action.id===Separator.ID&&(focusItem=!1),focusItem?(forceFocus||this.previouslyFocusedItem!==this.focusedItem)&&(actionViewItem.focus(fromRight),this.previouslyFocusedItem=this.focusedItem):(this.actionsList.focus({preventScroll}),this.previouslyFocusedItem=void 0)}}doTrigger(event){if(void 0===this.focusedItem)return;const actionViewItem=this.viewItems[this.focusedItem];if(actionViewItem instanceof BaseActionViewItem){const context=null===actionViewItem._context||void 0===actionViewItem._context?event:actionViewItem._context;this.run(actionViewItem._action,context)}}run(action,context){return __awaiter(this,void 0,void 0,(function*(){yield this._actionRunner.run(action,context)}))}dispose(){dispose(this.viewItems),this.viewItems=[],this._actionIds=[],this.getContainer().remove(),super.dispose()}}