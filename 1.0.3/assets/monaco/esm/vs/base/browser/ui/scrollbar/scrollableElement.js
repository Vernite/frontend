import{getZoomFactor}from"../../browser.js";import*as dom from"../../dom.js";import{createFastDomNode}from"../../fastDomNode.js";import{StandardWheelEvent}from"../../mouseEvent.js";import{HorizontalScrollbar}from"./horizontalScrollbar.js";import{VerticalScrollbar}from"./verticalScrollbar.js";import{Widget}from"../widget.js";import{TimeoutTimer}from"../../../common/async.js";import{Emitter}from"../../../common/event.js";import{dispose}from"../../../common/lifecycle.js";import*as platform from"../../../common/platform.js";import{Scrollable}from"../../../common/scrollable.js";import"./media/scrollbars.css";const HIDE_TIMEOUT=500,SCROLL_WHEEL_SENSITIVITY=50,SCROLL_WHEEL_SMOOTH_SCROLL_ENABLED=!0;class MouseWheelClassifierItem{constructor(timestamp,deltaX,deltaY){this.timestamp=timestamp,this.deltaX=deltaX,this.deltaY=deltaY,this.score=0}}export class MouseWheelClassifier{constructor(){this._capacity=5,this._memory=[],this._front=-1,this._rear=-1}isPhysicalMouseWheel(){if(-1===this._front&&-1===this._rear)return!1;let remainingInfluence=1,score=0,iteration=1,index=this._rear;for(;;){const influence=index===this._front?remainingInfluence:Math.pow(2,-iteration);if(remainingInfluence-=influence,score+=this._memory[index].score*influence,index===this._front)break;index=(this._capacity+index-1)%this._capacity,iteration++}return score<=.5}accept(timestamp,deltaX,deltaY){const item=new MouseWheelClassifierItem(timestamp,deltaX,deltaY);item.score=this._computeScore(item),-1===this._front&&-1===this._rear?(this._memory[0]=item,this._front=0,this._rear=0):(this._rear=(this._rear+1)%this._capacity,this._rear===this._front&&(this._front=(this._front+1)%this._capacity),this._memory[this._rear]=item)}_computeScore(item){if(Math.abs(item.deltaX)>0&&Math.abs(item.deltaY)>0)return 1;let score=.5;-1===this._front&&-1===this._rear||this._memory[this._rear];return this._isAlmostInt(item.deltaX)&&this._isAlmostInt(item.deltaY)||(score+=.25),Math.min(Math.max(score,0),1)}_isAlmostInt(value){return Math.abs(Math.round(value)-value)<.01}}MouseWheelClassifier.INSTANCE=new MouseWheelClassifier;export class AbstractScrollableElement extends Widget{constructor(element,options,scrollable){super(),this._onScroll=this._register(new Emitter),this.onScroll=this._onScroll.event,this._onWillScroll=this._register(new Emitter),element.style.overflow="hidden",this._options=resolveOptions(options),this._scrollable=scrollable,this._register(this._scrollable.onScroll((e=>{this._onWillScroll.fire(e),this._onDidScroll(e),this._onScroll.fire(e)})));const scrollbarHost={onMouseWheel:mouseWheelEvent=>this._onMouseWheel(mouseWheelEvent),onDragStart:()=>this._onDragStart(),onDragEnd:()=>this._onDragEnd()};this._verticalScrollbar=this._register(new VerticalScrollbar(this._scrollable,this._options,scrollbarHost)),this._horizontalScrollbar=this._register(new HorizontalScrollbar(this._scrollable,this._options,scrollbarHost)),this._domNode=document.createElement("div"),this._domNode.className="monaco-scrollable-element "+this._options.className,this._domNode.setAttribute("role","presentation"),this._domNode.style.position="relative",this._domNode.style.overflow="hidden",this._domNode.appendChild(element),this._domNode.appendChild(this._horizontalScrollbar.domNode.domNode),this._domNode.appendChild(this._verticalScrollbar.domNode.domNode),this._options.useShadows?(this._leftShadowDomNode=createFastDomNode(document.createElement("div")),this._leftShadowDomNode.setClassName("shadow"),this._domNode.appendChild(this._leftShadowDomNode.domNode),this._topShadowDomNode=createFastDomNode(document.createElement("div")),this._topShadowDomNode.setClassName("shadow"),this._domNode.appendChild(this._topShadowDomNode.domNode),this._topLeftShadowDomNode=createFastDomNode(document.createElement("div")),this._topLeftShadowDomNode.setClassName("shadow"),this._domNode.appendChild(this._topLeftShadowDomNode.domNode)):(this._leftShadowDomNode=null,this._topShadowDomNode=null,this._topLeftShadowDomNode=null),this._listenOnDomNode=this._options.listenOnDomNode||this._domNode,this._mouseWheelToDispose=[],this._setListeningToMouseWheel(this._options.handleMouseWheel),this.onmouseover(this._listenOnDomNode,(e=>this._onMouseOver(e))),this.onmouseleave(this._listenOnDomNode,(e=>this._onMouseLeave(e))),this._hideTimeout=this._register(new TimeoutTimer),this._isDragging=!1,this._mouseIsOver=!1,this._shouldRender=!0,this._revealOnScroll=!0}get options(){return this._options}dispose(){this._mouseWheelToDispose=dispose(this._mouseWheelToDispose),super.dispose()}getDomNode(){return this._domNode}getOverviewRulerLayoutInfo(){return{parent:this._domNode,insertBefore:this._verticalScrollbar.domNode.domNode}}delegateVerticalScrollbarPointerDown(browserEvent){this._verticalScrollbar.delegatePointerDown(browserEvent)}getScrollDimensions(){return this._scrollable.getScrollDimensions()}setScrollDimensions(dimensions){this._scrollable.setScrollDimensions(dimensions,!1)}updateClassName(newClassName){this._options.className=newClassName,platform.isMacintosh&&(this._options.className+=" mac"),this._domNode.className="monaco-scrollable-element "+this._options.className}updateOptions(newOptions){void 0!==newOptions.handleMouseWheel&&(this._options.handleMouseWheel=newOptions.handleMouseWheel,this._setListeningToMouseWheel(this._options.handleMouseWheel)),void 0!==newOptions.mouseWheelScrollSensitivity&&(this._options.mouseWheelScrollSensitivity=newOptions.mouseWheelScrollSensitivity),void 0!==newOptions.fastScrollSensitivity&&(this._options.fastScrollSensitivity=newOptions.fastScrollSensitivity),void 0!==newOptions.scrollPredominantAxis&&(this._options.scrollPredominantAxis=newOptions.scrollPredominantAxis),void 0!==newOptions.horizontal&&(this._options.horizontal=newOptions.horizontal),void 0!==newOptions.vertical&&(this._options.vertical=newOptions.vertical),void 0!==newOptions.horizontalScrollbarSize&&(this._options.horizontalScrollbarSize=newOptions.horizontalScrollbarSize),void 0!==newOptions.verticalScrollbarSize&&(this._options.verticalScrollbarSize=newOptions.verticalScrollbarSize),void 0!==newOptions.scrollByPage&&(this._options.scrollByPage=newOptions.scrollByPage),this._horizontalScrollbar.updateOptions(this._options),this._verticalScrollbar.updateOptions(this._options),this._options.lazyRender||this._render()}_setListeningToMouseWheel(shouldListen){if(this._mouseWheelToDispose.length>0!==shouldListen&&(this._mouseWheelToDispose=dispose(this._mouseWheelToDispose),shouldListen)){const onMouseWheel=browserEvent=>{this._onMouseWheel(new StandardWheelEvent(browserEvent))};this._mouseWheelToDispose.push(dom.addDisposableListener(this._listenOnDomNode,dom.EventType.MOUSE_WHEEL,onMouseWheel,{passive:!1}))}}_onMouseWheel(e){const classifier=MouseWheelClassifier.INSTANCE;{const osZoomFactor=window.devicePixelRatio/getZoomFactor();platform.isWindows||platform.isLinux?classifier.accept(Date.now(),e.deltaX/osZoomFactor,e.deltaY/osZoomFactor):classifier.accept(Date.now(),e.deltaX,e.deltaY)}let didScroll=!1;if(e.deltaY||e.deltaX){let deltaY=e.deltaY*this._options.mouseWheelScrollSensitivity,deltaX=e.deltaX*this._options.mouseWheelScrollSensitivity;this._options.scrollPredominantAxis&&(Math.abs(deltaY)>=Math.abs(deltaX)?deltaX=0:deltaY=0),this._options.flipAxes&&([deltaY,deltaX]=[deltaX,deltaY]);const shiftConvert=!platform.isMacintosh&&e.browserEvent&&e.browserEvent.shiftKey;!this._options.scrollYToX&&!shiftConvert||deltaX||(deltaX=deltaY,deltaY=0),e.browserEvent&&e.browserEvent.altKey&&(deltaX*=this._options.fastScrollSensitivity,deltaY*=this._options.fastScrollSensitivity);const futureScrollPosition=this._scrollable.getFutureScrollPosition();let desiredScrollPosition={};if(deltaY){const deltaScrollTop=50*deltaY,desiredScrollTop=futureScrollPosition.scrollTop-(deltaScrollTop<0?Math.floor(deltaScrollTop):Math.ceil(deltaScrollTop));this._verticalScrollbar.writeScrollPosition(desiredScrollPosition,desiredScrollTop)}if(deltaX){const deltaScrollLeft=50*deltaX,desiredScrollLeft=futureScrollPosition.scrollLeft-(deltaScrollLeft<0?Math.floor(deltaScrollLeft):Math.ceil(deltaScrollLeft));this._horizontalScrollbar.writeScrollPosition(desiredScrollPosition,desiredScrollLeft)}if(desiredScrollPosition=this._scrollable.validateScrollPosition(desiredScrollPosition),futureScrollPosition.scrollLeft!==desiredScrollPosition.scrollLeft||futureScrollPosition.scrollTop!==desiredScrollPosition.scrollTop){this._options.mouseWheelSmoothScroll&&classifier.isPhysicalMouseWheel()?this._scrollable.setScrollPositionSmooth(desiredScrollPosition):this._scrollable.setScrollPositionNow(desiredScrollPosition),didScroll=!0}}let consumeMouseWheel=didScroll;!consumeMouseWheel&&this._options.alwaysConsumeMouseWheel&&(consumeMouseWheel=!0),!consumeMouseWheel&&this._options.consumeMouseWheelIfScrollbarIsNeeded&&(this._verticalScrollbar.isNeeded()||this._horizontalScrollbar.isNeeded())&&(consumeMouseWheel=!0),consumeMouseWheel&&(e.preventDefault(),e.stopPropagation())}_onDidScroll(e){this._shouldRender=this._horizontalScrollbar.onDidScroll(e)||this._shouldRender,this._shouldRender=this._verticalScrollbar.onDidScroll(e)||this._shouldRender,this._options.useShadows&&(this._shouldRender=!0),this._revealOnScroll&&this._reveal(),this._options.lazyRender||this._render()}renderNow(){if(!this._options.lazyRender)throw new Error("Please use `lazyRender` together with `renderNow`!");this._render()}_render(){if(this._shouldRender&&(this._shouldRender=!1,this._horizontalScrollbar.render(),this._verticalScrollbar.render(),this._options.useShadows)){const scrollState=this._scrollable.getCurrentScrollPosition(),enableTop=scrollState.scrollTop>0,enableLeft=scrollState.scrollLeft>0,leftClassName=enableLeft?" left":"",topClassName=enableTop?" top":"",topLeftClassName=enableLeft||enableTop?" top-left-corner":"";this._leftShadowDomNode.setClassName(`shadow${leftClassName}`),this._topShadowDomNode.setClassName(`shadow${topClassName}`),this._topLeftShadowDomNode.setClassName(`shadow${topLeftClassName}${topClassName}${leftClassName}`)}}_onDragStart(){this._isDragging=!0,this._reveal()}_onDragEnd(){this._isDragging=!1,this._hide()}_onMouseLeave(e){this._mouseIsOver=!1,this._hide()}_onMouseOver(e){this._mouseIsOver=!0,this._reveal()}_reveal(){this._verticalScrollbar.beginReveal(),this._horizontalScrollbar.beginReveal(),this._scheduleHide()}_hide(){this._mouseIsOver||this._isDragging||(this._verticalScrollbar.beginHide(),this._horizontalScrollbar.beginHide())}_scheduleHide(){this._mouseIsOver||this._isDragging||this._hideTimeout.cancelAndSet((()=>this._hide()),500)}}export class ScrollableElement extends AbstractScrollableElement{constructor(element,options){(options=options||{}).mouseWheelSmoothScroll=!1;const scrollable=new Scrollable({forceIntegerValues:!0,smoothScrollDuration:0,scheduleAtNextAnimationFrame:callback=>dom.scheduleAtNextAnimationFrame(callback)});super(element,options,scrollable),this._register(scrollable)}setScrollPosition(update){this._scrollable.setScrollPositionNow(update)}}export class SmoothScrollableElement extends AbstractScrollableElement{constructor(element,options,scrollable){super(element,options,scrollable)}setScrollPosition(update){update.reuseAnimation?this._scrollable.setScrollPositionSmooth(update,update.reuseAnimation):this._scrollable.setScrollPositionNow(update)}getScrollPosition(){return this._scrollable.getCurrentScrollPosition()}}export class DomScrollableElement extends AbstractScrollableElement{constructor(element,options){(options=options||{}).mouseWheelSmoothScroll=!1;const scrollable=new Scrollable({forceIntegerValues:!1,smoothScrollDuration:0,scheduleAtNextAnimationFrame:callback=>dom.scheduleAtNextAnimationFrame(callback)});super(element,options,scrollable),this._register(scrollable),this._element=element,this.onScroll((e=>{e.scrollTopChanged&&(this._element.scrollTop=e.scrollTop),e.scrollLeftChanged&&(this._element.scrollLeft=e.scrollLeft)})),this.scanDomNode()}setScrollPosition(update){this._scrollable.setScrollPositionNow(update)}getScrollPosition(){return this._scrollable.getCurrentScrollPosition()}scanDomNode(){this.setScrollDimensions({width:this._element.clientWidth,scrollWidth:this._element.scrollWidth,height:this._element.clientHeight,scrollHeight:this._element.scrollHeight}),this.setScrollPosition({scrollLeft:this._element.scrollLeft,scrollTop:this._element.scrollTop})}}function resolveOptions(opts){const result={lazyRender:void 0!==opts.lazyRender&&opts.lazyRender,className:void 0!==opts.className?opts.className:"",useShadows:void 0===opts.useShadows||opts.useShadows,handleMouseWheel:void 0===opts.handleMouseWheel||opts.handleMouseWheel,flipAxes:void 0!==opts.flipAxes&&opts.flipAxes,consumeMouseWheelIfScrollbarIsNeeded:void 0!==opts.consumeMouseWheelIfScrollbarIsNeeded&&opts.consumeMouseWheelIfScrollbarIsNeeded,alwaysConsumeMouseWheel:void 0!==opts.alwaysConsumeMouseWheel&&opts.alwaysConsumeMouseWheel,scrollYToX:void 0!==opts.scrollYToX&&opts.scrollYToX,mouseWheelScrollSensitivity:void 0!==opts.mouseWheelScrollSensitivity?opts.mouseWheelScrollSensitivity:1,fastScrollSensitivity:void 0!==opts.fastScrollSensitivity?opts.fastScrollSensitivity:5,scrollPredominantAxis:void 0===opts.scrollPredominantAxis||opts.scrollPredominantAxis,mouseWheelSmoothScroll:void 0===opts.mouseWheelSmoothScroll||opts.mouseWheelSmoothScroll,arrowSize:void 0!==opts.arrowSize?opts.arrowSize:11,listenOnDomNode:void 0!==opts.listenOnDomNode?opts.listenOnDomNode:null,horizontal:void 0!==opts.horizontal?opts.horizontal:1,horizontalScrollbarSize:void 0!==opts.horizontalScrollbarSize?opts.horizontalScrollbarSize:10,horizontalSliderSize:void 0!==opts.horizontalSliderSize?opts.horizontalSliderSize:0,horizontalHasArrows:void 0!==opts.horizontalHasArrows&&opts.horizontalHasArrows,vertical:void 0!==opts.vertical?opts.vertical:1,verticalScrollbarSize:void 0!==opts.verticalScrollbarSize?opts.verticalScrollbarSize:10,verticalHasArrows:void 0!==opts.verticalHasArrows&&opts.verticalHasArrows,verticalSliderSize:void 0!==opts.verticalSliderSize?opts.verticalSliderSize:0,scrollByPage:void 0!==opts.scrollByPage&&opts.scrollByPage};return result.horizontalSliderSize=void 0!==opts.horizontalSliderSize?opts.horizontalSliderSize:result.horizontalScrollbarSize,result.verticalSliderSize=void 0!==opts.verticalSliderSize?opts.verticalSliderSize:result.verticalScrollbarSize,platform.isMacintosh&&(result.className+=" mac"),result}