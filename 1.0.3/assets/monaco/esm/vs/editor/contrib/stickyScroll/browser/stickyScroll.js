var _a,__decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{registerEditorContribution}from"../../../browser/editorExtensions.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{OutlineModel,OutlineElement}from"../../documentSymbols/browser/outlineModel.js";import{CancellationTokenSource}from"../../../../base/common/cancellation.js";import*as dom from"../../../../base/browser/dom.js";import{createStringBuilder}from"../../../common/core/stringBuilder.js";import{RenderLineInput,renderViewLine}from"../../../common/viewLayout/viewLineRenderer.js";import{LineDecoration}from"../../../common/viewLayout/lineDecorations.js";import{RunOnceScheduler}from"../../../../base/common/async.js";import{Position}from"../../../common/core/position.js";let StickyScrollController=class StickyScrollController extends Disposable{constructor(editor,_languageFeaturesService){super(),this._sessionStore=new DisposableStore,this._ranges=[],this._rangesVersionId=0,this._editor=editor,this._languageFeaturesService=_languageFeaturesService,this.stickyScrollWidget=new StickyScrollWidget(this._editor),this._register(this._editor.onDidChangeConfiguration((e=>{e.hasChanged(34)&&this.onConfigurationChange()}))),this._updateSoon=this._register(new RunOnceScheduler((()=>this._update(!0)),50)),this.onConfigurationChange()}onConfigurationChange(){if(!1===this._editor.getOption(34).stickyScroll.enabled)return this.stickyScrollWidget.emptyRootNode(),this._editor.removeOverlayWidget(this.stickyScrollWidget),void this._sessionStore.clear();this._editor.addOverlayWidget(this.stickyScrollWidget),this._sessionStore.add(this._editor.onDidChangeModel((()=>this._update(!0)))),this._sessionStore.add(this._editor.onDidScrollChange((()=>this._update(!1)))),this._sessionStore.add(this._editor.onDidChangeHiddenAreas((()=>this._update(!0)))),this._sessionStore.add(this._editor.onDidChangeModelTokens((e=>this._onTokensChange(e)))),this._sessionStore.add(this._editor.onDidChangeModelContent((()=>this._updateSoon.schedule()))),this._sessionStore.add(this._languageFeaturesService.documentSymbolProvider.onDidChange((()=>this._update(!0)))),this._update(!0)}_needsUpdate(event){const stickyLineNumbers=this.stickyScrollWidget.getCurrentLines();for(const stickyLineNumber of stickyLineNumbers)for(const range of event.ranges)if(stickyLineNumber>=range.fromLineNumber&&stickyLineNumber<=range.toLineNumber)return!0;return!1}_onTokensChange(event){this._needsUpdate(event)&&this._update(!1)}_update(updateOutline=!1){var _a,_b;return __awaiter(this,void 0,void 0,(function*(){updateOutline&&(null===(_a=this._cts)||void 0===_a||_a.dispose(!0),this._cts=new CancellationTokenSource,yield this._updateOutlineModel(this._cts.token));const hiddenRanges=null===(_b=this._editor._getViewModel())||void 0===_b?void 0:_b.getHiddenAreas();if(hiddenRanges)for(const hiddenRange of hiddenRanges)this._ranges=this._ranges.filter((range=>!(range[0]>=hiddenRange.startLineNumber&&range[1]<=hiddenRange.endLineNumber+1)));this._renderStickyScroll()}))}_findLineRanges(outlineElement,depth){if(null==outlineElement?void 0:outlineElement.children.size){let didRecursion=!1;for(const outline of null==outlineElement?void 0:outlineElement.children.values()){const kind=outline.symbol.kind;4!==kind&&8!==kind&&11!==kind&&10!==kind&&5!==kind&&1!==kind||(didRecursion=!0,this._findLineRanges(outline,depth+1))}didRecursion||this._addOutlineRanges(outlineElement,depth)}else this._addOutlineRanges(outlineElement,depth)}_addOutlineRanges(outlineElement,depth){let currentStartLine=0,currentEndLine=0;for(;outlineElement;){const kind=outlineElement.symbol.kind;if(4!==kind&&8!==kind&&11!==kind&&10!==kind&&5!==kind&&1!==kind||(currentStartLine=null==outlineElement?void 0:outlineElement.symbol.range.startLineNumber,currentEndLine=null==outlineElement?void 0:outlineElement.symbol.range.endLineNumber,this._ranges.push([currentStartLine,currentEndLine,depth]),depth--),!(outlineElement.parent instanceof OutlineElement))break;outlineElement=outlineElement.parent}}_updateOutlineModel(token){return __awaiter(this,void 0,void 0,(function*(){if(this._editor.hasModel()){const model=this._editor.getModel(),modelVersionId=model.getVersionId(),outlineModel=yield OutlineModel.create(this._languageFeaturesService.documentSymbolProvider,model,token);if(token.isCancellationRequested)return;this._ranges=[],this._rangesVersionId=modelVersionId;for(const outline of outlineModel.children.values()){if(outline instanceof OutlineElement){const kind=outline.symbol.kind;4===kind||8===kind||11===kind||10===kind||5===kind||1===kind?this._findLineRanges(outline,1):this._findLineRanges(outline,0)}this._ranges=this._ranges.sort((function(a,b){return a[0]!==b[0]?a[0]-b[0]:a[1]!==b[1]?b[1]-a[1]:a[2]-b[2]}));let previous=[];for(const[index,arr]of this._ranges.entries()){const[start,end,_depth]=arr;previous[0]===start&&previous[1]===end?this._ranges.splice(index,1):previous=arr}}}}))}_renderStickyScroll(){if(!this._editor.hasModel())return;const lineHeight=this._editor.getOption(61),model=this._editor.getModel();if(this._rangesVersionId!==model.getVersionId())return;const scrollTop=this._editor.getScrollTop();this.stickyScrollWidget.emptyRootNode();const beginningLinesConsidered=new Set;for(const[index,arr]of this._ranges.entries()){const[start,end,depth]=arr;if(end-start>0&&""!==model.getLineContent(start)){const topOfElementAtDepth=(depth-1)*lineHeight,bottomOfElementAtDepth=depth*lineHeight,bottomOfBeginningLine=this._editor.getBottomForLineNumber(start)-scrollTop,topOfEndLine=this._editor.getTopForLineNumber(end)-scrollTop,bottomOfEndLine=this._editor.getBottomForLineNumber(end)-scrollTop;if(beginningLinesConsidered.has(start))this._ranges.splice(index,1);else{if(topOfElementAtDepth>=topOfEndLine-1&&topOfElementAtDepth<bottomOfEndLine-2){beginningLinesConsidered.add(start),this.stickyScrollWidget.pushCodeLine(new StickyScrollCodeLine(start,depth,this._editor,-1,bottomOfEndLine-bottomOfElementAtDepth));break}bottomOfElementAtDepth>bottomOfBeginningLine&&bottomOfElementAtDepth<bottomOfEndLine-1&&(beginningLinesConsidered.add(start),this.stickyScrollWidget.pushCodeLine(new StickyScrollCodeLine(start,depth,this._editor,0,0)))}}}this.stickyScrollWidget.updateRootNode()}dispose(){super.dispose(),this._sessionStore.dispose()}};StickyScrollController.ID="store.contrib.stickyScrollController",StickyScrollController=__decorate([__param(1,ILanguageFeaturesService)],StickyScrollController);const _ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("stickyScrollViewLayer",{createHTML:value=>value});class StickyScrollCodeLine{constructor(_lineNumber,_depth,_editor,_zIndex,_relativePosition){this._lineNumber=_lineNumber,this._depth=_depth,this._editor=_editor,this._zIndex=_zIndex,this._relativePosition=_relativePosition,this.effectiveLineHeight=0,this.effectiveLineHeight=this._editor.getOption(61)+this._relativePosition}get lineNumber(){return this._lineNumber}getDomNode(){const root=document.createElement("div"),viewModel=this._editor._getViewModel(),viewLineNumber=viewModel.coordinatesConverter.convertModelPositionToViewPosition(new Position(this._lineNumber,1)).lineNumber,lineRenderingData=viewModel.getViewLineRenderingData(viewLineNumber);let actualInlineDecorations;try{actualInlineDecorations=LineDecoration.filter(lineRenderingData.inlineDecorations,viewLineNumber,lineRenderingData.minColumn,lineRenderingData.maxColumn)}catch(err){actualInlineDecorations=[]}const renderLineInput=new RenderLineInput(!0,!0,lineRenderingData.content,lineRenderingData.continuesWithWrappedLine,lineRenderingData.isBasicASCII,lineRenderingData.containsRTL,0,lineRenderingData.tokens,actualInlineDecorations,lineRenderingData.tabSize,lineRenderingData.startVisibleColumn,1,1,1,100,"none",!0,!0,null),sb=createStringBuilder(400);let newLine;renderViewLine(renderLineInput,sb),newLine=_ttPolicy?_ttPolicy.createHTML(sb.build()):sb.build();const lineHTMLNode=document.createElement("span");lineHTMLNode.style.backgroundColor="var(--vscode-editorStickyScroll-background)",lineHTMLNode.style.overflow="hidden",lineHTMLNode.style.whiteSpace="nowrap",lineHTMLNode.style.display="inline-block",lineHTMLNode.style.lineHeight=this._editor.getOption(61).toString()+"px",lineHTMLNode.innerHTML=newLine;const lineNumberHTMLNode=document.createElement("span");lineNumberHTMLNode.style.width=this._editor.getLayoutInfo().contentLeft.toString()+"px",lineNumberHTMLNode.style.backgroundColor="var(--vscode-editorStickyScroll-background)",lineNumberHTMLNode.style.color="var(--vscode-editorLineNumber-foreground)",lineNumberHTMLNode.style.display="inline-block",lineNumberHTMLNode.style.lineHeight=this._editor.getOption(61).toString()+"px";const innerLineNumberHTML=document.createElement("span");return innerLineNumberHTML.innerText=this._lineNumber.toString(),innerLineNumberHTML.style.paddingLeft=this._editor.getLayoutInfo().lineNumbersLeft.toString()+"px",innerLineNumberHTML.style.width=this._editor.getLayoutInfo().lineNumbersWidth.toString()+"px",innerLineNumberHTML.style.backgroundColor="var(--vscode-editorStickyScroll-background)",innerLineNumberHTML.style.textAlign="right",innerLineNumberHTML.style.float="left",innerLineNumberHTML.style.lineHeight=this._editor.getOption(61).toString()+"px",lineNumberHTMLNode.appendChild(innerLineNumberHTML),root.onclick=e=>{e.stopPropagation(),e.preventDefault(),this._editor.revealPosition({lineNumber:this._lineNumber-this._depth+1,column:1})},root.onmouseover=e=>{innerLineNumberHTML.style.background="var(--vscode-editorStickyScrollHover-background)",lineHTMLNode.style.backgroundColor="var(--vscode-editorStickyScrollHover-background)",lineNumberHTMLNode.style.backgroundColor="var(--vscode-editorStickyScrollHover-background)",root.style.backgroundColor="var(--vscode-editorStickyScrollHover-background)",innerLineNumberHTML.style.cursor="pointer",lineHTMLNode.style.cursor="pointer",root.style.cursor="pointer",lineNumberHTMLNode.style.cursor="pointer"},root.onmouseleave=e=>{innerLineNumberHTML.style.background="var(--vscode-editorStickyScroll-background)",lineHTMLNode.style.backgroundColor="var(--vscode-editorStickyScroll-background)",lineNumberHTMLNode.style.backgroundColor="var(--vscode-editorStickyScroll-background)",root.style.backgroundColor="var(--vscode-editorStickyScroll-background)"},this._editor.applyFontInfo(lineHTMLNode),this._editor.applyFontInfo(innerLineNumberHTML),root.appendChild(lineNumberHTMLNode),root.appendChild(lineHTMLNode),root.style.zIndex=this._zIndex.toString(),root.style.backgroundColor="var(--vscode-editorStickyScroll-background)",root.style.overflow="hidden",root.style.whiteSpace="nowrap",root.style.width="100%",root.style.lineHeight=this._editor.getOption(61).toString()+"px",root.style.height=this._editor.getOption(61).toString()+"px",this._relativePosition&&(root.style.position="relative",root.style.top=this._relativePosition+"px",root.style.width="100%"),root}}class StickyScrollWidget{constructor(_editor){this._editor=_editor,this.arrayOfCodeLines=[],this.rootDomNode=document.createElement("div"),this.rootDomNode=document.createElement("div"),this.rootDomNode.style.width="100%",this.rootDomNode.style.boxShadow="var(--vscode-scrollbar-shadow) 0 6px 6px -6px"}getCurrentLines(){const widgetLineRange=[];for(const codeLine of this.arrayOfCodeLines)widgetLineRange.push(codeLine.lineNumber);return widgetLineRange}pushCodeLine(codeLine){this.arrayOfCodeLines.push(codeLine)}updateRootNode(){let widgetHeight=0;for(const line of this.arrayOfCodeLines)widgetHeight+=line.effectiveLineHeight,this.rootDomNode.appendChild(line.getDomNode());this.rootDomNode.style.height=widgetHeight.toString()+"px"}emptyRootNode(){this.arrayOfCodeLines.length=0,dom.clearNode(this.rootDomNode)}getId(){return"editor.contrib.stickyScrollWidget"}getDomNode(){return this.rootDomNode.style.zIndex="2",this.rootDomNode.style.backgroundColor="var(--vscode-editorStickyScroll-background)",this.rootDomNode}getPosition(){return{preference:null}}}registerEditorContribution(StickyScrollController.ID,StickyScrollController);