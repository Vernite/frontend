var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{Codicon}from"../../../../base/common/codicons.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{EditorAction,EditorCommand,registerEditorAction,registerEditorCommand,registerEditorContribution}from"../../../browser/editorExtensions.js";import{ICodeEditorService}from"../../../browser/services/codeEditorService.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{IMarkerNavigationService}from"./markerNavigationService.js";import*as nls from"../../../../nls.js";import{MenuId}from"../../../../platform/actions/common/actions.js";import{IContextKeyService,RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{registerIcon}from"../../../../platform/theme/common/iconRegistry.js";import{MarkerNavigationWidget}from"./gotoErrorWidget.js";let MarkerController=class MarkerController{constructor(editor,_markerNavigationService,_contextKeyService,_editorService,_instantiationService){this._markerNavigationService=_markerNavigationService,this._contextKeyService=_contextKeyService,this._editorService=_editorService,this._instantiationService=_instantiationService,this._sessionDispoables=new DisposableStore,this._editor=editor,this._widgetVisible=CONTEXT_MARKERS_NAVIGATION_VISIBLE.bindTo(this._contextKeyService)}static get(editor){return editor.getContribution(MarkerController.ID)}dispose(){this._cleanUp(),this._sessionDispoables.dispose()}_cleanUp(){this._widgetVisible.reset(),this._sessionDispoables.clear(),this._widget=void 0,this._model=void 0}_getOrCreateModel(uri){if(this._model&&this._model.matches(uri))return this._model;let reusePosition=!1;return this._model&&(reusePosition=!0,this._cleanUp()),this._model=this._markerNavigationService.getMarkerList(uri),reusePosition&&this._model.move(!0,this._editor.getModel(),this._editor.getPosition()),this._widget=this._instantiationService.createInstance(MarkerNavigationWidget,this._editor),this._widget.onDidClose((()=>this.close()),this,this._sessionDispoables),this._widgetVisible.set(!0),this._sessionDispoables.add(this._model),this._sessionDispoables.add(this._widget),this._sessionDispoables.add(this._editor.onDidChangeCursorPosition((e=>{var _a,_b,_c;(null===(_a=this._model)||void 0===_a?void 0:_a.selected)&&Range.containsPosition(null===(_b=this._model)||void 0===_b?void 0:_b.selected.marker,e.position)||null===(_c=this._model)||void 0===_c||_c.resetIndex()}))),this._sessionDispoables.add(this._model.onDidChange((()=>{if(!this._widget||!this._widget.position||!this._model)return;const info=this._model.find(this._editor.getModel().uri,this._widget.position);info?this._widget.updateMarker(info.marker):this._widget.showStale()}))),this._sessionDispoables.add(this._widget.onDidSelectRelatedInformation((related=>{this._editorService.openCodeEditor({resource:related.resource,options:{pinned:!0,revealIfOpened:!0,selection:Range.lift(related).collapseToStart()}},this._editor),this.close(!1)}))),this._sessionDispoables.add(this._editor.onDidChangeModel((()=>this._cleanUp()))),this._model}close(focusEditor=!0){this._cleanUp(),focusEditor&&this._editor.focus()}showAtMarker(marker){if(this._editor.hasModel()){const model=this._getOrCreateModel(this._editor.getModel().uri);model.resetIndex(),model.move(!0,this._editor.getModel(),new Position(marker.startLineNumber,marker.startColumn)),model.selected&&this._widget.showAtMarker(model.selected.marker,model.selected.index,model.selected.total)}}nagivate(next,multiFile){var _a,_b;return __awaiter(this,void 0,void 0,(function*(){if(this._editor.hasModel()){const model=this._getOrCreateModel(multiFile?void 0:this._editor.getModel().uri);if(model.move(next,this._editor.getModel(),this._editor.getPosition()),!model.selected)return;if(model.selected.marker.resource.toString()!==this._editor.getModel().uri.toString()){this._cleanUp();const otherEditor=yield this._editorService.openCodeEditor({resource:model.selected.marker.resource,options:{pinned:!1,revealIfOpened:!0,selectionRevealType:2,selection:model.selected.marker}},this._editor);otherEditor&&(null===(_a=MarkerController.get(otherEditor))||void 0===_a||_a.close(),null===(_b=MarkerController.get(otherEditor))||void 0===_b||_b.nagivate(next,multiFile))}else this._widget.showAtMarker(model.selected.marker,model.selected.index,model.selected.total)}}))}};MarkerController.ID="editor.contrib.markerController",MarkerController=__decorate([__param(1,IMarkerNavigationService),__param(2,IContextKeyService),__param(3,ICodeEditorService),__param(4,IInstantiationService)],MarkerController);export{MarkerController};class MarkerNavigationAction extends EditorAction{constructor(_next,_multiFile,opts){super(opts),this._next=_next,this._multiFile=_multiFile}run(_accessor,editor){var _a;return __awaiter(this,void 0,void 0,(function*(){editor.hasModel()&&(null===(_a=MarkerController.get(editor))||void 0===_a||_a.nagivate(this._next,this._multiFile))}))}}export class NextMarkerAction extends MarkerNavigationAction{constructor(){super(!0,!1,{id:NextMarkerAction.ID,label:NextMarkerAction.LABEL,alias:"Go to Next Problem (Error, Warning, Info)",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.focus,primary:578,weight:100},menuOpts:{menuId:MarkerNavigationWidget.TitleMenu,title:NextMarkerAction.LABEL,icon:registerIcon("marker-navigation-next",Codicon.arrowDown,nls.localize("nextMarkerIcon","Icon for goto next marker.")),group:"navigation",order:1}})}}NextMarkerAction.ID="editor.action.marker.next",NextMarkerAction.LABEL=nls.localize("markerAction.next.label","Go to Next Problem (Error, Warning, Info)");class PrevMarkerAction extends MarkerNavigationAction{constructor(){super(!1,!1,{id:PrevMarkerAction.ID,label:PrevMarkerAction.LABEL,alias:"Go to Previous Problem (Error, Warning, Info)",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.focus,primary:1602,weight:100},menuOpts:{menuId:MarkerNavigationWidget.TitleMenu,title:PrevMarkerAction.LABEL,icon:registerIcon("marker-navigation-previous",Codicon.arrowUp,nls.localize("previousMarkerIcon","Icon for goto previous marker.")),group:"navigation",order:2}})}}PrevMarkerAction.ID="editor.action.marker.prev",PrevMarkerAction.LABEL=nls.localize("markerAction.previous.label","Go to Previous Problem (Error, Warning, Info)");class NextMarkerInFilesAction extends MarkerNavigationAction{constructor(){super(!0,!0,{id:"editor.action.marker.nextInFiles",label:nls.localize("markerAction.nextInFiles.label","Go to Next Problem in Files (Error, Warning, Info)"),alias:"Go to Next Problem in Files (Error, Warning, Info)",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.focus,primary:66,weight:100},menuOpts:{menuId:MenuId.MenubarGoMenu,title:nls.localize({key:"miGotoNextProblem",comment:["&& denotes a mnemonic"]},"Next &&Problem"),group:"6_problem_nav",order:1}})}}class PrevMarkerInFilesAction extends MarkerNavigationAction{constructor(){super(!1,!0,{id:"editor.action.marker.prevInFiles",label:nls.localize("markerAction.previousInFiles.label","Go to Previous Problem in Files (Error, Warning, Info)"),alias:"Go to Previous Problem in Files (Error, Warning, Info)",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.focus,primary:1090,weight:100},menuOpts:{menuId:MenuId.MenubarGoMenu,title:nls.localize({key:"miGotoPreviousProblem",comment:["&& denotes a mnemonic"]},"Previous &&Problem"),group:"6_problem_nav",order:2}})}}registerEditorContribution(MarkerController.ID,MarkerController),registerEditorAction(NextMarkerAction),registerEditorAction(PrevMarkerAction),registerEditorAction(NextMarkerInFilesAction),registerEditorAction(PrevMarkerInFilesAction);const CONTEXT_MARKERS_NAVIGATION_VISIBLE=new RawContextKey("markersNavigationVisible",!1),MarkerCommand=EditorCommand.bindToContribution(MarkerController.get);registerEditorCommand(new MarkerCommand({id:"closeMarkersNavigation",precondition:CONTEXT_MARKERS_NAVIGATION_VISIBLE,handler:x=>x.close(),kbOpts:{weight:150,kbExpr:EditorContextKeys.focus,primary:9,secondary:[1033]}}));