var _a;import{globals}from"../common/platform.js";import{logOnceWebWorkerWarning}from"../common/worker/simpleWorker.js";const ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("defaultWorkerFactory",{createScriptURL:value=>value});function getWorker(label){if(globals.MonacoEnvironment){if("function"==typeof globals.MonacoEnvironment.getWorker)return globals.MonacoEnvironment.getWorker("workerMain.js",label);if("function"==typeof globals.MonacoEnvironment.getWorkerUrl){const workerUrl=globals.MonacoEnvironment.getWorkerUrl("workerMain.js",label);return new Worker(ttPolicy?ttPolicy.createScriptURL(workerUrl):workerUrl,{name:label})}}throw new Error("You must define a function MonacoEnvironment.getWorkerUrl or MonacoEnvironment.getWorker")}function isPromiseLike(obj){return"function"==typeof obj.then}class WebWorker{constructor(moduleId,id,label,onMessageCallback,onErrorCallback){this.id=id;const workerOrPromise=getWorker(label);isPromiseLike(workerOrPromise)?this.worker=workerOrPromise:this.worker=Promise.resolve(workerOrPromise),this.postMessage(moduleId,[]),this.worker.then((w=>{w.onmessage=function(ev){onMessageCallback(ev.data)},w.onmessageerror=onErrorCallback,"function"==typeof w.addEventListener&&w.addEventListener("error",onErrorCallback)}))}getId(){return this.id}postMessage(message,transfer){var _a;null===(_a=this.worker)||void 0===_a||_a.then((w=>w.postMessage(message,transfer)))}dispose(){var _a;null===(_a=this.worker)||void 0===_a||_a.then((w=>w.terminate())),this.worker=null}}export class DefaultWorkerFactory{constructor(label){this._label=label,this._webWorkerFailedBeforeError=!1}create(moduleId,onMessageCallback,onErrorCallback){const workerId=++DefaultWorkerFactory.LAST_WORKER_ID;if(this._webWorkerFailedBeforeError)throw this._webWorkerFailedBeforeError;return new WebWorker(moduleId,workerId,this._label||"anonymous"+workerId,onMessageCallback,(err=>{logOnceWebWorkerWarning(err),this._webWorkerFailedBeforeError=err,onErrorCallback(err)}))}}DefaultWorkerFactory.LAST_WORKER_ID=0;