import"./lineNumbers.css";import*as platform from"../../../../base/common/platform.js";import{DynamicViewOverlay}from"../../view/dynamicViewOverlay.js";import{Position}from"../../../common/core/position.js";import{editorActiveLineNumber,editorLineNumbers}from"../../../common/core/editorColorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";export class LineNumbersOverlay extends DynamicViewOverlay{constructor(context){super(),this._context=context,this._readConfig(),this._lastCursorModelPosition=new Position(1,1),this._lastCursorViewPosition=new Position(1,1),this._renderResult=null,this._activeLineNumber=1,this._context.addEventHandler(this)}_readConfig(){const options=this._context.configuration.options;this._lineHeight=options.get(61);const lineNumbers=options.get(62);this._renderLineNumbers=lineNumbers.renderType,this._renderCustomLineNumbers=lineNumbers.renderFn,this._renderFinalNewline=options.get(86);const layoutInfo=options.get(133);this._lineNumbersLeft=layoutInfo.lineNumbersLeft,this._lineNumbersWidth=layoutInfo.lineNumbersWidth}dispose(){this._context.removeEventHandler(this),this._renderResult=null,super.dispose()}onConfigurationChanged(e){return this._readConfig(),!0}onCursorStateChanged(e){const primaryViewPosition=e.selections[0].getPosition();this._lastCursorViewPosition=primaryViewPosition,this._lastCursorModelPosition=this._context.viewModel.coordinatesConverter.convertViewPositionToModelPosition(primaryViewPosition);let shouldRender=!1;return this._activeLineNumber!==primaryViewPosition.lineNumber&&(this._activeLineNumber=primaryViewPosition.lineNumber,shouldRender=!0),2!==this._renderLineNumbers&&3!==this._renderLineNumbers||(shouldRender=!0),shouldRender}onFlushed(e){return!0}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return e.scrollTopChanged}onZonesChanged(e){return!0}_getLineRenderLineNumber(viewLineNumber){const modelPosition=this._context.viewModel.coordinatesConverter.convertViewPositionToModelPosition(new Position(viewLineNumber,1));if(1!==modelPosition.column)return"";const modelLineNumber=modelPosition.lineNumber;return this._renderCustomLineNumbers?this._renderCustomLineNumbers(modelLineNumber):3===this._renderLineNumbers?this._lastCursorModelPosition.lineNumber===modelLineNumber||modelLineNumber%10==0?String(modelLineNumber):"":String(modelLineNumber)}prepareRender(ctx){if(0===this._renderLineNumbers)return void(this._renderResult=null);const lineHeightClassName=platform.isLinux?this._lineHeight%2==0?" lh-even":" lh-odd":"",visibleStartLineNumber=ctx.visibleRange.startLineNumber,visibleEndLineNumber=ctx.visibleRange.endLineNumber,common='<div class="'+LineNumbersOverlay.CLASS_NAME+lineHeightClassName+'" style="left:'+this._lineNumbersLeft+"px;width:"+this._lineNumbersWidth+'px;">';let relativeLineNumbers=null;if(2===this._renderLineNumbers){relativeLineNumbers=new Array(visibleEndLineNumber-visibleStartLineNumber+1),this._lastCursorViewPosition.lineNumber>=visibleStartLineNumber&&this._lastCursorViewPosition.lineNumber<=visibleEndLineNumber&&(relativeLineNumbers[this._lastCursorViewPosition.lineNumber-visibleStartLineNumber]=this._lastCursorModelPosition.lineNumber);{let value=0;for(let lineNumber=this._lastCursorViewPosition.lineNumber+1;lineNumber<=visibleEndLineNumber;lineNumber++){const isWrappedLine=1!==this._context.viewModel.coordinatesConverter.convertViewPositionToModelPosition(new Position(lineNumber,1)).column;isWrappedLine||value++,lineNumber>=visibleStartLineNumber&&(relativeLineNumbers[lineNumber-visibleStartLineNumber]=isWrappedLine?0:value)}}{let value=0;for(let lineNumber=this._lastCursorViewPosition.lineNumber-1;lineNumber>=visibleStartLineNumber;lineNumber--){const isWrappedLine=1!==this._context.viewModel.coordinatesConverter.convertViewPositionToModelPosition(new Position(lineNumber,1)).column;isWrappedLine||value++,lineNumber<=visibleEndLineNumber&&(relativeLineNumbers[lineNumber-visibleStartLineNumber]=isWrappedLine?0:value)}}}const lineCount=this._context.viewModel.getLineCount(),output=[];for(let lineNumber=visibleStartLineNumber;lineNumber<=visibleEndLineNumber;lineNumber++){const lineIndex=lineNumber-visibleStartLineNumber;if(!this._renderFinalNewline&&lineNumber===lineCount&&0===this._context.viewModel.getLineLength(lineNumber)){output[lineIndex]="";continue}let renderLineNumber;if(relativeLineNumbers){const relativeLineNumber=relativeLineNumbers[lineIndex];renderLineNumber=this._lastCursorViewPosition.lineNumber===lineNumber?`<span class="relative-current-line-number">${relativeLineNumber}</span>`:relativeLineNumber?String(relativeLineNumber):""}else renderLineNumber=this._getLineRenderLineNumber(lineNumber);renderLineNumber?lineNumber===this._activeLineNumber?output[lineIndex]='<div class="active-line-number '+LineNumbersOverlay.CLASS_NAME+lineHeightClassName+'" style="left:'+this._lineNumbersLeft+"px;width:"+this._lineNumbersWidth+'px;">'+renderLineNumber+"</div>":output[lineIndex]=common+renderLineNumber+"</div>":output[lineIndex]=""}this._renderResult=output}render(startLineNumber,lineNumber){if(!this._renderResult)return"";const lineIndex=lineNumber-startLineNumber;return lineIndex<0||lineIndex>=this._renderResult.length?"":this._renderResult[lineIndex]}}LineNumbersOverlay.CLASS_NAME="line-numbers",registerThemingParticipant(((theme,collector)=>{const lineNumbers=theme.getColor(editorLineNumbers);lineNumbers&&collector.addRule(`.monaco-editor .line-numbers { color: ${lineNumbers}; }`);const activeLineNumber=theme.getColor(editorActiveLineNumber);activeLineNumber&&collector.addRule(`.monaco-editor .line-numbers.active-line-number { color: ${activeLineNumber}; }`)}));