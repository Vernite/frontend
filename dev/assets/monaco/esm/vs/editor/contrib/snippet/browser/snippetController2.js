var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import{DisposableStore}from"../../../../base/common/lifecycle.js";import{assertType}from"../../../../base/common/types.js";import{EditorCommand,registerEditorCommand,registerEditorContribution}from"../../../browser/editorExtensions.js";import{Position}from"../../../common/core/position.js";import{Selection}from"../../../common/core/selection.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{ILanguageConfigurationService}from"../../../common/languages/languageConfigurationRegistry.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{showSimpleSuggestions}from"../../suggest/browser/suggest.js";import{localize}from"../../../../nls.js";import{ContextKeyExpr,IContextKeyService,RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";import{ILogService}from"../../../../platform/log/common/log.js";import{SnippetSession}from"./snippetSession.js";const _defaultOptions={overwriteBefore:0,overwriteAfter:0,undoStopBefore:!0,undoStopAfter:!0,adjustWhitespace:!0,clipboardText:void 0,overtypingCapturer:void 0};let SnippetController2=class SnippetController2{constructor(_editor,_logService,_languageFeaturesService,contextKeyService,_languageConfigurationService){this._editor=_editor,this._logService=_logService,this._languageFeaturesService=_languageFeaturesService,this._languageConfigurationService=_languageConfigurationService,this._snippetListener=new DisposableStore,this._modelVersionId=-1,this._inSnippet=SnippetController2.InSnippetMode.bindTo(contextKeyService),this._hasNextTabstop=SnippetController2.HasNextTabstop.bindTo(contextKeyService),this._hasPrevTabstop=SnippetController2.HasPrevTabstop.bindTo(contextKeyService)}static get(editor){return editor.getContribution(SnippetController2.ID)}dispose(){var _a;this._inSnippet.reset(),this._hasPrevTabstop.reset(),this._hasNextTabstop.reset(),null===(_a=this._session)||void 0===_a||_a.dispose(),this._snippetListener.dispose()}apply(edits,opts){try{this._doInsert(edits,void 0===opts?_defaultOptions:Object.assign(Object.assign({},_defaultOptions),opts))}catch(e){this.cancel(),this._logService.error(e),this._logService.error("snippet_error"),this._logService.error("insert_edits=",edits),this._logService.error("existing_template=",this._session?this._session._logInfo():"<no_session>")}}insert(template,opts){try{this._doInsert(template,void 0===opts?_defaultOptions:Object.assign(Object.assign({},_defaultOptions),opts))}catch(e){this.cancel(),this._logService.error(e),this._logService.error("snippet_error"),this._logService.error("insert_template=",template),this._logService.error("existing_template=",this._session?this._session._logInfo():"<no_session>")}}_doInsert(template,opts){var _a;if(this._editor.hasModel()){if(this._snippetListener.clear(),opts.undoStopBefore&&this._editor.getModel().pushStackElement(),this._session&&"string"!=typeof template&&this.cancel(),this._session?(assertType("string"==typeof template),this._session.merge(template,opts)):(this._modelVersionId=this._editor.getModel().getAlternativeVersionId(),this._session=new SnippetSession(this._editor,template,opts,this._languageConfigurationService),this._session.insert()),opts.undoStopAfter&&this._editor.getModel().pushStackElement(),null===(_a=this._session)||void 0===_a?void 0:_a.hasChoice){this._choiceCompletionItemProvider={provideCompletionItems:(model,position)=>{if(!this._session||model!==this._editor.getModel()||!Position.equals(this._editor.getPosition(),position))return;const{activeChoice}=this._session;if(!activeChoice||0===activeChoice.choice.options.length)return;const word=model.getValueInRange(activeChoice.range),isAnyOfOptions=Boolean(activeChoice.choice.options.find((o=>o.value===word))),suggestions=[];for(let i=0;i<activeChoice.choice.options.length;i++){const option=activeChoice.choice.options[i];suggestions.push({kind:13,label:option.value,insertText:option.value,sortText:"a".repeat(i+1),range:activeChoice.range,filterText:isAnyOfOptions?`${word}_${option.value}`:void 0,command:{id:"jumpToNextSnippetPlaceholder",title:localize("next","Go to next placeholder...")}})}return{suggestions}}};const registration=this._languageFeaturesService.completionProvider.register({language:this._editor.getModel().getLanguageId(),pattern:this._editor.getModel().uri.fsPath,scheme:this._editor.getModel().uri.scheme},this._choiceCompletionItemProvider);this._snippetListener.add(registration)}this._updateState(),this._snippetListener.add(this._editor.onDidChangeModelContent((e=>e.isFlush&&this.cancel()))),this._snippetListener.add(this._editor.onDidChangeModel((()=>this.cancel()))),this._snippetListener.add(this._editor.onDidChangeCursorSelection((()=>this._updateState())))}}_updateState(){if(this._session&&this._editor.hasModel()){if(this._modelVersionId===this._editor.getModel().getAlternativeVersionId())return this.cancel();if(!this._session.hasPlaceholder)return this.cancel();if(this._session.isAtLastPlaceholder||!this._session.isSelectionWithinPlaceholders())return this._editor.getModel().pushStackElement(),this.cancel();this._inSnippet.set(!0),this._hasPrevTabstop.set(!this._session.isAtFirstPlaceholder),this._hasNextTabstop.set(!this._session.isAtLastPlaceholder),this._handleChoice()}}_handleChoice(){if(!this._session||!this._editor.hasModel())return void(this._currentChoice=void 0);const{activeChoice}=this._session;activeChoice&&this._choiceCompletionItemProvider?this._currentChoice!==activeChoice.choice&&(this._currentChoice=activeChoice.choice,queueMicrotask((()=>{showSimpleSuggestions(this._editor,this._choiceCompletionItemProvider)}))):this._currentChoice=void 0}finish(){for(;this._inSnippet.get();)this.next()}cancel(resetSelection=!1){var _a;this._inSnippet.reset(),this._hasPrevTabstop.reset(),this._hasNextTabstop.reset(),this._snippetListener.clear(),this._currentChoice=void 0,null===(_a=this._session)||void 0===_a||_a.dispose(),this._session=void 0,this._modelVersionId=-1,resetSelection&&this._editor.setSelections([this._editor.getSelection()])}prev(){this._session&&this._session.prev(),this._updateState()}next(){this._session&&this._session.next(),this._updateState()}isInSnippet(){return Boolean(this._inSnippet.get())}};SnippetController2.ID="snippetController2",SnippetController2.InSnippetMode=new RawContextKey("inSnippetMode",!1,localize("inSnippetMode","Whether the editor in current in snippet mode")),SnippetController2.HasNextTabstop=new RawContextKey("hasNextTabstop",!1,localize("hasNextTabstop","Whether there is a next tab stop when in snippet mode")),SnippetController2.HasPrevTabstop=new RawContextKey("hasPrevTabstop",!1,localize("hasPrevTabstop","Whether there is a previous tab stop when in snippet mode")),SnippetController2=__decorate([__param(1,ILogService),__param(2,ILanguageFeaturesService),__param(3,IContextKeyService),__param(4,ILanguageConfigurationService)],SnippetController2);export{SnippetController2};registerEditorContribution(SnippetController2.ID,SnippetController2);const CommandCtor=EditorCommand.bindToContribution(SnippetController2.get);registerEditorCommand(new CommandCtor({id:"jumpToNextSnippetPlaceholder",precondition:ContextKeyExpr.and(SnippetController2.InSnippetMode,SnippetController2.HasNextTabstop),handler:ctrl=>ctrl.next(),kbOpts:{weight:130,kbExpr:EditorContextKeys.editorTextFocus,primary:2}})),registerEditorCommand(new CommandCtor({id:"jumpToPrevSnippetPlaceholder",precondition:ContextKeyExpr.and(SnippetController2.InSnippetMode,SnippetController2.HasPrevTabstop),handler:ctrl=>ctrl.prev(),kbOpts:{weight:130,kbExpr:EditorContextKeys.editorTextFocus,primary:1026}})),registerEditorCommand(new CommandCtor({id:"leaveSnippet",precondition:SnippetController2.InSnippetMode,handler:ctrl=>ctrl.cancel(!0),kbOpts:{weight:130,kbExpr:EditorContextKeys.editorTextFocus,primary:9,secondary:[1033]}})),registerEditorCommand(new CommandCtor({id:"acceptSnippet",precondition:SnippetController2.InSnippetMode,handler:ctrl=>ctrl.finish()}));export function performSnippetEdit(editor,snippet,selections){const controller=SnippetController2.get(editor);return!!controller&&(editor.focus(),controller.apply(selections.map((selection=>({range:Selection.liftSelection(selection),template:snippet})))),controller.isInSnippet())}