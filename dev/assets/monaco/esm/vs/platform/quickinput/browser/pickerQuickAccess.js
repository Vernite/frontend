var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{timeout}from"../../../base/common/async.js";import{CancellationTokenSource}from"../../../base/common/cancellation.js";import{Disposable,DisposableStore,MutableDisposable}from"../../../base/common/lifecycle.js";export var TriggerAction;function isPicksWithActive(obj){const candidate=obj;return Array.isArray(candidate.items)}function isFastAndSlowPicks(obj){const candidate=obj;return!!candidate.picks&&candidate.additionalPicks instanceof Promise}!function(TriggerAction){TriggerAction[TriggerAction.NO_ACTION=0]="NO_ACTION",TriggerAction[TriggerAction.CLOSE_PICKER=1]="CLOSE_PICKER",TriggerAction[TriggerAction.REFRESH_PICKER=2]="REFRESH_PICKER",TriggerAction[TriggerAction.REMOVE_ITEM=3]="REMOVE_ITEM"}(TriggerAction||(TriggerAction={}));export class PickerQuickAccessProvider extends Disposable{constructor(prefix,options){super(),this.prefix=prefix,this.options=options}provide(picker,token){var _a;const disposables=new DisposableStore;let picksCts;picker.canAcceptInBackground=!!(null===(_a=this.options)||void 0===_a?void 0:_a.canAcceptInBackground),picker.matchOnLabel=picker.matchOnDescription=picker.matchOnDetail=picker.sortByLabel=!1;const picksDisposable=disposables.add(new MutableDisposable),updatePickerItems=()=>__awaiter(this,void 0,void 0,(function*(){const picksDisposables=picksDisposable.value=new DisposableStore;null==picksCts||picksCts.dispose(!0),picker.busy=!1,picksCts=new CancellationTokenSource(token);const picksToken=picksCts.token,picksFilter=picker.value.substr(this.prefix.length).trim(),providedPicks=this._getPicks(picksFilter,picksDisposables,picksToken),applyPicks=(picks,skipEmpty)=>{var _a;let items,activeItem;if(isPicksWithActive(picks)?(items=picks.items,activeItem=picks.active):items=picks,0===items.length){if(skipEmpty)return!1;picksFilter.length>0&&(null===(_a=this.options)||void 0===_a?void 0:_a.noResultsPick)&&(items=[this.options.noResultsPick])}return picker.items=items,activeItem&&(picker.activeItems=[activeItem]),!0};if(null===providedPicks);else if(isFastAndSlowPicks(providedPicks)){let fastPicksApplied=!1,slowPicksApplied=!1;yield Promise.all([(()=>__awaiter(this,void 0,void 0,(function*(){yield timeout(PickerQuickAccessProvider.FAST_PICKS_RACE_DELAY),picksToken.isCancellationRequested||slowPicksApplied||(fastPicksApplied=applyPicks(providedPicks.picks,!0))})))(),(()=>__awaiter(this,void 0,void 0,(function*(){picker.busy=!0;try{const awaitedAdditionalPicks=yield providedPicks.additionalPicks;if(picksToken.isCancellationRequested)return;let picks,activePick,additionalPicks,additionalActivePick;if(isPicksWithActive(providedPicks.picks)?(picks=providedPicks.picks.items,activePick=providedPicks.picks.active):picks=providedPicks.picks,isPicksWithActive(awaitedAdditionalPicks)?(additionalPicks=awaitedAdditionalPicks.items,additionalActivePick=awaitedAdditionalPicks.active):additionalPicks=awaitedAdditionalPicks,additionalPicks.length>0||!fastPicksApplied){let fallbackActivePick;if(!activePick&&!additionalActivePick){const fallbackActivePickCandidate=picker.activeItems[0];fallbackActivePickCandidate&&-1!==picks.indexOf(fallbackActivePickCandidate)&&(fallbackActivePick=fallbackActivePickCandidate)}applyPicks({items:[...picks,...additionalPicks],active:activePick||additionalActivePick||fallbackActivePick})}}finally{picksToken.isCancellationRequested||(picker.busy=!1),slowPicksApplied=!0}})))()])}else if(providedPicks instanceof Promise){picker.busy=!0;try{const awaitedPicks=yield providedPicks;if(picksToken.isCancellationRequested)return;applyPicks(awaitedPicks)}finally{picksToken.isCancellationRequested||(picker.busy=!1)}}else applyPicks(providedPicks)}));return disposables.add(picker.onDidChangeValue((()=>updatePickerItems()))),updatePickerItems(),disposables.add(picker.onDidAccept((event=>{const[item]=picker.selectedItems;"function"==typeof(null==item?void 0:item.accept)&&(event.inBackground||picker.hide(),item.accept(picker.keyMods,event))}))),disposables.add(picker.onDidTriggerItemButton((({button,item})=>__awaiter(this,void 0,void 0,(function*(){var _b,_c;if("function"==typeof item.trigger){const buttonIndex=null!==(_c=null===(_b=item.buttons)||void 0===_b?void 0:_b.indexOf(button))&&void 0!==_c?_c:-1;if(buttonIndex>=0){const result=item.trigger(buttonIndex,picker.keyMods),action="number"==typeof result?result:yield result;if(token.isCancellationRequested)return;switch(action){case TriggerAction.NO_ACTION:break;case TriggerAction.CLOSE_PICKER:picker.hide();break;case TriggerAction.REFRESH_PICKER:updatePickerItems();break;case TriggerAction.REMOVE_ITEM:{const index=picker.items.indexOf(item);if(-1!==index){const items=picker.items.slice(),removed=items.splice(index,1),activeItems=picker.activeItems.filter((activeItem=>activeItem!==removed[0])),keepScrollPositionBefore=picker.keepScrollPosition;picker.keepScrollPosition=!0,picker.items=items,activeItems&&(picker.activeItems=activeItems),picker.keepScrollPosition=keepScrollPositionBefore}break}}}}}))))),disposables}}PickerQuickAccessProvider.FAST_PICKS_RACE_DELAY=200;