import{lengthAdd,lengthZero,lengthLessThan}from"./length.js";export class NodeReader{constructor(node){this.lastOffset=lengthZero,this.nextNodes=[node],this.offsets=[lengthZero],this.idxs=[]}readLongestNodeAt(offset,predicate){if(lengthLessThan(offset,this.lastOffset))throw new Error("Invalid offset");for(this.lastOffset=offset;;){const curNode=lastOrUndefined(this.nextNodes);if(!curNode)return;const curNodeOffset=lastOrUndefined(this.offsets);if(lengthLessThan(offset,curNodeOffset))return;if(lengthLessThan(curNodeOffset,offset))if(lengthAdd(curNodeOffset,curNode.length)<=offset)this.nextNodeAfterCurrent();else{const nextChildIdx=getNextChildIdx(curNode);-1!==nextChildIdx?(this.nextNodes.push(curNode.getChild(nextChildIdx)),this.offsets.push(curNodeOffset),this.idxs.push(nextChildIdx)):this.nextNodeAfterCurrent()}else{if(predicate(curNode))return this.nextNodeAfterCurrent(),curNode;{const nextChildIdx=getNextChildIdx(curNode);if(-1===nextChildIdx)return void this.nextNodeAfterCurrent();this.nextNodes.push(curNode.getChild(nextChildIdx)),this.offsets.push(curNodeOffset),this.idxs.push(nextChildIdx)}}}}nextNodeAfterCurrent(){for(;;){const currentOffset=lastOrUndefined(this.offsets),currentNode=lastOrUndefined(this.nextNodes);if(this.nextNodes.pop(),this.offsets.pop(),0===this.idxs.length)break;const parent=lastOrUndefined(this.nextNodes),nextChildIdx=getNextChildIdx(parent,this.idxs[this.idxs.length-1]);if(-1!==nextChildIdx){this.nextNodes.push(parent.getChild(nextChildIdx)),this.offsets.push(lengthAdd(currentOffset,currentNode.length)),this.idxs[this.idxs.length-1]=nextChildIdx;break}this.idxs.pop()}}}function getNextChildIdx(node,curIdx=-1){for(;;){if(++curIdx>=node.childrenLength)return-1;if(node.getChild(curIdx))return curIdx}}function lastOrUndefined(arr){return arr.length>0?arr[arr.length-1]:void 0}