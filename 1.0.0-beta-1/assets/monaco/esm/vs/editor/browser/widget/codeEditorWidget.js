var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import"../services/markerDecorations.js";import"./media/editor.css";import*as nls from"../../../nls.js";import*as dom from"../../../base/browser/dom.js";import{onUnexpectedError}from"../../../base/common/errors.js";import{Emitter,EventDeliveryQueue}from"../../../base/common/event.js";import{Disposable,dispose}from"../../../base/common/lifecycle.js";import{Schemas}from"../../../base/common/network.js";import{EditorConfiguration}from"../config/editorConfiguration.js";import{EditorExtensionsRegistry}from"../editorExtensions.js";import{ICodeEditorService}from"../services/codeEditorService.js";import{View}from"../view.js";import{ViewUserInputEvents}from"../view/viewUserInputEvents.js";import{filterValidationDecorations}from"../../common/config/editorOptions.js";import{CursorsController}from"../../common/cursor/cursor.js";import{CursorColumns}from"../../common/core/cursorColumns.js";import{Position}from"../../common/core/position.js";import{Range}from"../../common/core/range.js";import{Selection}from"../../common/core/selection.js";import{InternalEditorAction}from"../../common/editorAction.js";import*as editorCommon from"../../common/editorCommon.js";import{EditorContextKeys}from"../../common/editorContextKeys.js";import{ModelDecorationOptions}from"../../common/model/textModel.js";import{editorUnnecessaryCodeBorder,editorUnnecessaryCodeOpacity}from"../../common/core/editorColorRegistry.js";import{editorErrorBorder,editorErrorForeground,editorHintBorder,editorHintForeground,editorInfoBorder,editorInfoForeground,editorWarningBorder,editorWarningForeground,editorForeground,editorErrorBackground,editorInfoBackground,editorWarningBackground}from"../../../platform/theme/common/colorRegistry.js";import{ViewModel}from"../../common/viewModel/viewModelImpl.js";import{ICommandService}from"../../../platform/commands/common/commands.js";import{IContextKeyService}from"../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../platform/instantiation/common/instantiation.js";import{ServiceCollection}from"../../../platform/instantiation/common/serviceCollection.js";import{INotificationService}from"../../../platform/notification/common/notification.js";import{IThemeService,registerThemingParticipant}from"../../../platform/theme/common/themeService.js";import{IAccessibilityService}from"../../../platform/accessibility/common/accessibility.js";import{withNullAsUndefined}from"../../../base/common/types.js";import{MonospaceLineBreaksComputerFactory}from"../../common/viewModel/monospaceLineBreaksComputer.js";import{DOMLineBreaksComputerFactory}from"../view/domLineBreaksComputer.js";import{WordOperations}from"../../common/cursor/cursorWordOperations.js";import{ILanguageConfigurationService}from"../../common/languages/languageConfigurationRegistry.js";import{applyFontInfo}from"../config/domFontInfo.js";import{ILanguageFeaturesService}from"../../common/services/languageFeatures.js";let EDITOR_ID=0;class ModelData{constructor(model,viewModel,view,hasRealView,listenersToRemove){this.model=model,this.viewModel=viewModel,this.view=view,this.hasRealView=hasRealView,this.listenersToRemove=listenersToRemove}dispose(){dispose(this.listenersToRemove),this.model.onBeforeDetached(),this.hasRealView&&this.view.dispose(),this.viewModel.dispose()}}let CodeEditorWidget=class CodeEditorWidget extends Disposable{constructor(domElement,_options,codeEditorWidgetOptions,instantiationService,codeEditorService,commandService,contextKeyService,themeService,notificationService,accessibilityService,languageConfigurationService,languageFeaturesService){super(),this.languageConfigurationService=languageConfigurationService,this._deliveryQueue=new EventDeliveryQueue,this._onDidDispose=this._register(new Emitter),this.onDidDispose=this._onDidDispose.event,this._onDidChangeModelContent=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeModelContent=this._onDidChangeModelContent.event,this._onDidChangeModelLanguage=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeModelLanguage=this._onDidChangeModelLanguage.event,this._onDidChangeModelLanguageConfiguration=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeModelLanguageConfiguration=this._onDidChangeModelLanguageConfiguration.event,this._onDidChangeModelOptions=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeModelOptions=this._onDidChangeModelOptions.event,this._onDidChangeModelDecorations=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeModelDecorations=this._onDidChangeModelDecorations.event,this._onDidChangeModelTokens=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeModelTokens=this._onDidChangeModelTokens.event,this._onDidChangeConfiguration=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeConfiguration=this._onDidChangeConfiguration.event,this._onDidChangeModel=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeModel=this._onDidChangeModel.event,this._onDidChangeCursorPosition=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeCursorPosition=this._onDidChangeCursorPosition.event,this._onDidChangeCursorSelection=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeCursorSelection=this._onDidChangeCursorSelection.event,this._onDidAttemptReadOnlyEdit=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidAttemptReadOnlyEdit=this._onDidAttemptReadOnlyEdit.event,this._onDidLayoutChange=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidLayoutChange=this._onDidLayoutChange.event,this._editorTextFocus=this._register(new BooleanEventEmitter({deliveryQueue:this._deliveryQueue})),this.onDidFocusEditorText=this._editorTextFocus.onDidChangeToTrue,this.onDidBlurEditorText=this._editorTextFocus.onDidChangeToFalse,this._editorWidgetFocus=this._register(new BooleanEventEmitter({deliveryQueue:this._deliveryQueue})),this.onDidFocusEditorWidget=this._editorWidgetFocus.onDidChangeToTrue,this.onDidBlurEditorWidget=this._editorWidgetFocus.onDidChangeToFalse,this._onWillType=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onWillType=this._onWillType.event,this._onDidType=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidType=this._onDidType.event,this._onDidCompositionStart=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidCompositionStart=this._onDidCompositionStart.event,this._onDidCompositionEnd=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidCompositionEnd=this._onDidCompositionEnd.event,this._onDidPaste=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidPaste=this._onDidPaste.event,this._onMouseUp=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onMouseUp=this._onMouseUp.event,this._onMouseDown=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onMouseDown=this._onMouseDown.event,this._onMouseDrag=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onMouseDrag=this._onMouseDrag.event,this._onMouseDrop=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onMouseDrop=this._onMouseDrop.event,this._onMouseDropCanceled=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onMouseDropCanceled=this._onMouseDropCanceled.event,this._onDropIntoEditor=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDropIntoEditor=this._onDropIntoEditor.event,this._onContextMenu=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onContextMenu=this._onContextMenu.event,this._onMouseMove=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onMouseMove=this._onMouseMove.event,this._onMouseLeave=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onMouseLeave=this._onMouseLeave.event,this._onMouseWheel=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onMouseWheel=this._onMouseWheel.event,this._onKeyUp=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onKeyUp=this._onKeyUp.event,this._onKeyDown=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onKeyDown=this._onKeyDown.event,this._onDidContentSizeChange=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidContentSizeChange=this._onDidContentSizeChange.event,this._onDidScrollChange=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidScrollChange=this._onDidScrollChange.event,this._onDidChangeViewZones=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeViewZones=this._onDidChangeViewZones.event,this._onDidChangeHiddenAreas=this._register(new Emitter({deliveryQueue:this._deliveryQueue})),this.onDidChangeHiddenAreas=this._onDidChangeHiddenAreas.event,this._bannerDomNode=null,this._dropIntoEditorDecorations=this.createDecorationsCollection();const options=Object.assign({},_options);let contributions;this._domElement=domElement,this._overflowWidgetsDomNode=options.overflowWidgetsDomNode,delete options.overflowWidgetsDomNode,this._id=++EDITOR_ID,this._decorationTypeKeysToIds={},this._decorationTypeSubtypes={},this._telemetryData=codeEditorWidgetOptions.telemetryData,this._configuration=this._register(this._createConfiguration(codeEditorWidgetOptions.isSimpleWidget||!1,options,accessibilityService)),this._register(this._configuration.onDidChange((e=>{this._onDidChangeConfiguration.fire(e);const options=this._configuration.options;if(e.hasChanged(133)){const layoutInfo=options.get(133);this._onDidLayoutChange.fire(layoutInfo)}}))),this._contextKeyService=this._register(contextKeyService.createScoped(this._domElement)),this._notificationService=notificationService,this._codeEditorService=codeEditorService,this._commandService=commandService,this._themeService=themeService,this._register(new EditorContextKeysManager(this,this._contextKeyService)),this._register(new EditorModeContext(this,this._contextKeyService,languageFeaturesService)),this._instantiationService=instantiationService.createChild(new ServiceCollection([IContextKeyService,this._contextKeyService])),this._modelData=null,this._contributions={},this._actions={},this._focusTracker=new CodeEditorWidgetFocusTracker(domElement),this._register(this._focusTracker.onChange((()=>{this._editorWidgetFocus.setValue(this._focusTracker.hasFocus())}))),this._contentWidgets={},this._overlayWidgets={},contributions=Array.isArray(codeEditorWidgetOptions.contributions)?codeEditorWidgetOptions.contributions:EditorExtensionsRegistry.getEditorContributions();for(const desc of contributions)if(this._contributions[desc.id])onUnexpectedError(new Error(`Cannot have two contributions with the same id ${desc.id}`));else try{const contribution=this._instantiationService.createInstance(desc.ctor,this);this._contributions[desc.id]=contribution}catch(err){onUnexpectedError(err)}EditorExtensionsRegistry.getEditorActions().forEach((action=>{if(this._actions[action.id])return void onUnexpectedError(new Error(`Cannot have two actions with the same id ${action.id}`));const internalAction=new InternalEditorAction(action.id,action.label,action.alias,withNullAsUndefined(action.precondition),(()=>this._instantiationService.invokeFunction((accessor=>Promise.resolve(action.runEditorCommand(accessor,this,null))))),this._contextKeyService);this._actions[internalAction.id]=internalAction}));const isDropIntoEnabled=()=>!this._configuration.options.get(83)&&this._configuration.options.get(32).enabled;this._register(new dom.DragAndDropObserver(this._domElement,{onDragEnter:()=>{},onDragOver:e=>{if(!isDropIntoEnabled())return;const target=this.getTargetAtClientPoint(e.clientX,e.clientY);(null==target?void 0:target.position)&&this.showDropIndicatorAt(target.position)},onDrop:e=>__awaiter(this,void 0,void 0,(function*(){if(!isDropIntoEnabled())return;if(this.removeDropIndicator(),!e.dataTransfer)return;const target=this.getTargetAtClientPoint(e.clientX,e.clientY);(null==target?void 0:target.position)&&this._onDropIntoEditor.fire({position:target.position,event:e})})),onDragLeave:()=>{this.removeDropIndicator()},onDragEnd:()=>{this.removeDropIndicator()}})),this._codeEditorService.addCodeEditor(this)}get isSimpleWidget(){return this._configuration.isSimpleWidget}_createConfiguration(isSimpleWidget,options,accessibilityService){return new EditorConfiguration(isSimpleWidget,options,this._domElement,accessibilityService)}getId(){return this.getEditorType()+":"+this._id}getEditorType(){return editorCommon.EditorType.ICodeEditor}dispose(){this._codeEditorService.removeCodeEditor(this),this._focusTracker.dispose();const keys=Object.keys(this._contributions);for(let i=0,len=keys.length;i<len;i++){const contributionId=keys[i];this._contributions[contributionId].dispose()}this._contributions={},this._actions={},this._contentWidgets={},this._overlayWidgets={},this._removeDecorationTypes(),this._postDetachModelCleanup(this._detachModel()),this._onDidDispose.fire(),super.dispose()}invokeWithinContext(fn){return this._instantiationService.invokeFunction(fn)}updateOptions(newOptions){this._configuration.updateOptions(newOptions||{})}getOptions(){return this._configuration.options}getOption(id){return this._configuration.options.get(id)}getRawOptions(){return this._configuration.getRawOptions()}getOverflowWidgetsDomNode(){return this._overflowWidgetsDomNode}getConfiguredWordAtPosition(position){return this._modelData?WordOperations.getWordAtPosition(this._modelData.model,this._configuration.options.get(119),position):null}getValue(options=null){if(!this._modelData)return"";const preserveBOM=!(!options||!options.preserveBOM);let eolPreference=0;return options&&options.lineEnding&&"\n"===options.lineEnding?eolPreference=1:options&&options.lineEnding&&"\r\n"===options.lineEnding&&(eolPreference=2),this._modelData.model.getValue(eolPreference,preserveBOM)}setValue(newValue){this._modelData&&this._modelData.model.setValue(newValue)}getModel(){return this._modelData?this._modelData.model:null}setModel(_model=null){const model=_model;if(null===this._modelData&&null===model)return;if(this._modelData&&this._modelData.model===model)return;const hasTextFocus=this.hasTextFocus(),detachedModel=this._detachModel();this._attachModel(model),hasTextFocus&&this.hasModel()&&this.focus();const e={oldModelUrl:detachedModel?detachedModel.uri:null,newModelUrl:model?model.uri:null};this._removeDecorationTypes(),this._onDidChangeModel.fire(e),this._postDetachModelCleanup(detachedModel)}_removeDecorationTypes(){if(this._decorationTypeKeysToIds={},this._decorationTypeSubtypes){for(const decorationType in this._decorationTypeSubtypes){const subTypes=this._decorationTypeSubtypes[decorationType];for(const subType in subTypes)this._removeDecorationType(decorationType+"-"+subType)}this._decorationTypeSubtypes={}}}getVisibleRanges(){return this._modelData?this._modelData.viewModel.getVisibleRanges():[]}getVisibleRangesPlusViewportAboveBelow(){return this._modelData?this._modelData.viewModel.getVisibleRangesPlusViewportAboveBelow():[]}getWhitespaces(){return this._modelData?this._modelData.viewModel.viewLayout.getWhitespaces():[]}static _getVerticalOffsetAfterPosition(modelData,modelLineNumber,modelColumn,includeViewZones){const modelPosition=modelData.model.validatePosition({lineNumber:modelLineNumber,column:modelColumn}),viewPosition=modelData.viewModel.coordinatesConverter.convertModelPositionToViewPosition(modelPosition);return modelData.viewModel.viewLayout.getVerticalOffsetAfterLineNumber(viewPosition.lineNumber,includeViewZones)}getTopForLineNumber(lineNumber,includeViewZones=!1){return this._modelData?CodeEditorWidget._getVerticalOffsetForPosition(this._modelData,lineNumber,1,includeViewZones):-1}getTopForPosition(lineNumber,column){return this._modelData?CodeEditorWidget._getVerticalOffsetForPosition(this._modelData,lineNumber,column,!1):-1}static _getVerticalOffsetForPosition(modelData,modelLineNumber,modelColumn,includeViewZones=!1){const modelPosition=modelData.model.validatePosition({lineNumber:modelLineNumber,column:modelColumn}),viewPosition=modelData.viewModel.coordinatesConverter.convertModelPositionToViewPosition(modelPosition);return modelData.viewModel.viewLayout.getVerticalOffsetForLineNumber(viewPosition.lineNumber,includeViewZones)}getBottomForLineNumber(lineNumber,includeViewZones=!1){return this._modelData?CodeEditorWidget._getVerticalOffsetAfterPosition(this._modelData,lineNumber,1,includeViewZones):-1}setHiddenAreas(ranges){var _a;null===(_a=this._modelData)||void 0===_a||_a.viewModel.setHiddenAreas(ranges.map((r=>Range.lift(r))))}getVisibleColumnFromPosition(rawPosition){if(!this._modelData)return rawPosition.column;const position=this._modelData.model.validatePosition(rawPosition),tabSize=this._modelData.model.getOptions().tabSize;return CursorColumns.visibleColumnFromColumn(this._modelData.model.getLineContent(position.lineNumber),position.column,tabSize)+1}getPosition(){return this._modelData?this._modelData.viewModel.getPosition():null}setPosition(position,source="api"){if(this._modelData){if(!Position.isIPosition(position))throw new Error("Invalid arguments");this._modelData.viewModel.setSelections(source,[{selectionStartLineNumber:position.lineNumber,selectionStartColumn:position.column,positionLineNumber:position.lineNumber,positionColumn:position.column}])}}_sendRevealRange(modelRange,verticalType,revealHorizontal,scrollType){if(!this._modelData)return;if(!Range.isIRange(modelRange))throw new Error("Invalid arguments");const validatedModelRange=this._modelData.model.validateRange(modelRange),viewRange=this._modelData.viewModel.coordinatesConverter.convertModelRangeToViewRange(validatedModelRange);this._modelData.viewModel.revealRange("api",revealHorizontal,viewRange,verticalType,scrollType)}revealLine(lineNumber,scrollType=0){this._revealLine(lineNumber,0,scrollType)}revealLineInCenter(lineNumber,scrollType=0){this._revealLine(lineNumber,1,scrollType)}revealLineInCenterIfOutsideViewport(lineNumber,scrollType=0){this._revealLine(lineNumber,2,scrollType)}revealLineNearTop(lineNumber,scrollType=0){this._revealLine(lineNumber,5,scrollType)}_revealLine(lineNumber,revealType,scrollType){if("number"!=typeof lineNumber)throw new Error("Invalid arguments");this._sendRevealRange(new Range(lineNumber,1,lineNumber,1),revealType,!1,scrollType)}revealPosition(position,scrollType=0){this._revealPosition(position,0,!0,scrollType)}revealPositionInCenter(position,scrollType=0){this._revealPosition(position,1,!0,scrollType)}revealPositionInCenterIfOutsideViewport(position,scrollType=0){this._revealPosition(position,2,!0,scrollType)}revealPositionNearTop(position,scrollType=0){this._revealPosition(position,5,!0,scrollType)}_revealPosition(position,verticalType,revealHorizontal,scrollType){if(!Position.isIPosition(position))throw new Error("Invalid arguments");this._sendRevealRange(new Range(position.lineNumber,position.column,position.lineNumber,position.column),verticalType,revealHorizontal,scrollType)}getSelection(){return this._modelData?this._modelData.viewModel.getSelection():null}getSelections(){return this._modelData?this._modelData.viewModel.getSelections():null}setSelection(something,source="api"){const isSelection=Selection.isISelection(something),isRange=Range.isIRange(something);if(!isSelection&&!isRange)throw new Error("Invalid arguments");if(isSelection)this._setSelectionImpl(something,source);else if(isRange){const selection={selectionStartLineNumber:something.startLineNumber,selectionStartColumn:something.startColumn,positionLineNumber:something.endLineNumber,positionColumn:something.endColumn};this._setSelectionImpl(selection,source)}}_setSelectionImpl(sel,source){if(!this._modelData)return;const selection=new Selection(sel.selectionStartLineNumber,sel.selectionStartColumn,sel.positionLineNumber,sel.positionColumn);this._modelData.viewModel.setSelections(source,[selection])}revealLines(startLineNumber,endLineNumber,scrollType=0){this._revealLines(startLineNumber,endLineNumber,0,scrollType)}revealLinesInCenter(startLineNumber,endLineNumber,scrollType=0){this._revealLines(startLineNumber,endLineNumber,1,scrollType)}revealLinesInCenterIfOutsideViewport(startLineNumber,endLineNumber,scrollType=0){this._revealLines(startLineNumber,endLineNumber,2,scrollType)}revealLinesNearTop(startLineNumber,endLineNumber,scrollType=0){this._revealLines(startLineNumber,endLineNumber,5,scrollType)}_revealLines(startLineNumber,endLineNumber,verticalType,scrollType){if("number"!=typeof startLineNumber||"number"!=typeof endLineNumber)throw new Error("Invalid arguments");this._sendRevealRange(new Range(startLineNumber,1,endLineNumber,1),verticalType,!1,scrollType)}revealRange(range,scrollType=0,revealVerticalInCenter=!1,revealHorizontal=!0){this._revealRange(range,revealVerticalInCenter?1:0,revealHorizontal,scrollType)}revealRangeInCenter(range,scrollType=0){this._revealRange(range,1,!0,scrollType)}revealRangeInCenterIfOutsideViewport(range,scrollType=0){this._revealRange(range,2,!0,scrollType)}revealRangeNearTop(range,scrollType=0){this._revealRange(range,5,!0,scrollType)}revealRangeNearTopIfOutsideViewport(range,scrollType=0){this._revealRange(range,6,!0,scrollType)}revealRangeAtTop(range,scrollType=0){this._revealRange(range,3,!0,scrollType)}_revealRange(range,verticalType,revealHorizontal,scrollType){if(!Range.isIRange(range))throw new Error("Invalid arguments");this._sendRevealRange(Range.lift(range),verticalType,revealHorizontal,scrollType)}setSelections(ranges,source="api",reason=0){if(this._modelData){if(!ranges||0===ranges.length)throw new Error("Invalid arguments");for(let i=0,len=ranges.length;i<len;i++)if(!Selection.isISelection(ranges[i]))throw new Error("Invalid arguments");this._modelData.viewModel.setSelections(source,ranges,reason)}}getContentWidth(){return this._modelData?this._modelData.viewModel.viewLayout.getContentWidth():-1}getScrollWidth(){return this._modelData?this._modelData.viewModel.viewLayout.getScrollWidth():-1}getScrollLeft(){return this._modelData?this._modelData.viewModel.viewLayout.getCurrentScrollLeft():-1}getContentHeight(){return this._modelData?this._modelData.viewModel.viewLayout.getContentHeight():-1}getScrollHeight(){return this._modelData?this._modelData.viewModel.viewLayout.getScrollHeight():-1}getScrollTop(){return this._modelData?this._modelData.viewModel.viewLayout.getCurrentScrollTop():-1}setScrollLeft(newScrollLeft,scrollType=1){if(this._modelData){if("number"!=typeof newScrollLeft)throw new Error("Invalid arguments");this._modelData.viewModel.viewLayout.setScrollPosition({scrollLeft:newScrollLeft},scrollType)}}setScrollTop(newScrollTop,scrollType=1){if(this._modelData){if("number"!=typeof newScrollTop)throw new Error("Invalid arguments");this._modelData.viewModel.viewLayout.setScrollPosition({scrollTop:newScrollTop},scrollType)}}setScrollPosition(position,scrollType=1){this._modelData&&this._modelData.viewModel.viewLayout.setScrollPosition(position,scrollType)}saveViewState(){if(!this._modelData)return null;const contributionsState={},keys=Object.keys(this._contributions);for(const id of keys){const contribution=this._contributions[id];"function"==typeof contribution.saveViewState&&(contributionsState[id]=contribution.saveViewState())}return{cursorState:this._modelData.viewModel.saveCursorState(),viewState:this._modelData.viewModel.saveState(),contributionsState}}restoreViewState(s){if(!this._modelData||!this._modelData.hasRealView)return;const codeEditorState=s;if(codeEditorState&&codeEditorState.cursorState&&codeEditorState.viewState){const cursorState=codeEditorState.cursorState;Array.isArray(cursorState)?cursorState.length>0&&this._modelData.viewModel.restoreCursorState(cursorState):this._modelData.viewModel.restoreCursorState([cursorState]);const contributionsState=codeEditorState.contributionsState||{},keys=Object.keys(this._contributions);for(let i=0,len=keys.length;i<len;i++){const id=keys[i],contribution=this._contributions[id];"function"==typeof contribution.restoreViewState&&contribution.restoreViewState(contributionsState[id])}const reducedState=this._modelData.viewModel.reduceRestoreState(codeEditorState.viewState);this._modelData.view.restoreState(reducedState)}}getContribution(id){return this._contributions[id]||null}getActions(){const result=[],keys=Object.keys(this._actions);for(let i=0,len=keys.length;i<len;i++){const id=keys[i];result.push(this._actions[id])}return result}getSupportedActions(){let result=this.getActions();return result=result.filter((action=>action.isSupported())),result}getAction(id){return this._actions[id]||null}trigger(source,handlerId,payload){switch(payload=payload||{},handlerId){case"compositionStart":return void this._startComposition();case"compositionEnd":return void this._endComposition(source);case"type":{const args=payload;return void this._type(source,args.text||"")}case"replacePreviousChar":{const args=payload;return void this._compositionType(source,args.text||"",args.replaceCharCnt||0,0,0)}case"compositionType":{const args=payload;return void this._compositionType(source,args.text||"",args.replacePrevCharCnt||0,args.replaceNextCharCnt||0,args.positionDelta||0)}case"paste":{const args=payload;return void this._paste(source,args.text||"",args.pasteOnNewLine||!1,args.multicursorText||null,args.mode||null)}case"cut":return void this._cut(source)}const action=this.getAction(handlerId);action?Promise.resolve(action.run()).then(void 0,onUnexpectedError):this._modelData&&(this._triggerEditorCommand(source,handlerId,payload)||this._triggerCommand(handlerId,payload))}_triggerCommand(handlerId,payload){this._commandService.executeCommand(handlerId,payload)}_startComposition(){this._modelData&&(this._modelData.viewModel.startComposition(),this._onDidCompositionStart.fire())}_endComposition(source){this._modelData&&(this._modelData.viewModel.endComposition(source),this._onDidCompositionEnd.fire())}_type(source,text){this._modelData&&0!==text.length&&("keyboard"===source&&this._onWillType.fire(text),this._modelData.viewModel.type(text,source),"keyboard"===source&&this._onDidType.fire(text))}_compositionType(source,text,replacePrevCharCnt,replaceNextCharCnt,positionDelta){this._modelData&&this._modelData.viewModel.compositionType(text,replacePrevCharCnt,replaceNextCharCnt,positionDelta,source)}_paste(source,text,pasteOnNewLine,multicursorText,mode){if(!this._modelData||0===text.length)return;const viewModel=this._modelData.viewModel,startPosition=viewModel.getSelection().getStartPosition();viewModel.paste(text,pasteOnNewLine,multicursorText,source);const endPosition=viewModel.getSelection().getStartPosition();"keyboard"===source&&this._onDidPaste.fire({range:new Range(startPosition.lineNumber,startPosition.column,endPosition.lineNumber,endPosition.column),languageId:mode})}_cut(source){this._modelData&&this._modelData.viewModel.cut(source)}_triggerEditorCommand(source,handlerId,payload){const command=EditorExtensionsRegistry.getEditorCommand(handlerId);return!!command&&((payload=payload||{}).source=source,this._instantiationService.invokeFunction((accessor=>{Promise.resolve(command.runEditorCommand(accessor,this,payload)).then(void 0,onUnexpectedError)})),!0)}_getViewModel(){return this._modelData?this._modelData.viewModel:null}pushUndoStop(){return!!this._modelData&&(!this._configuration.options.get(83)&&(this._modelData.model.pushStackElement(),!0))}popUndoStop(){return!!this._modelData&&(!this._configuration.options.get(83)&&(this._modelData.model.popStackElement(),!0))}executeEdits(source,edits,endCursorState){if(!this._modelData)return!1;if(this._configuration.options.get(83))return!1;let cursorStateComputer;return cursorStateComputer=endCursorState?Array.isArray(endCursorState)?()=>endCursorState:endCursorState:()=>null,this._modelData.viewModel.executeEdits(source,edits,cursorStateComputer),!0}executeCommand(source,command){this._modelData&&this._modelData.viewModel.executeCommand(command,source)}executeCommands(source,commands){this._modelData&&this._modelData.viewModel.executeCommands(commands,source)}createDecorationsCollection(decorations){return new EditorDecorationsCollection(this,decorations)}changeDecorations(callback){return this._modelData?this._modelData.model.changeDecorations(callback,this._id):null}getLineDecorations(lineNumber){return this._modelData?this._modelData.model.getLineDecorations(lineNumber,this._id,filterValidationDecorations(this._configuration.options)):null}getDecorationsInRange(range){return this._modelData?this._modelData.model.getDecorationsInRange(range,this._id,filterValidationDecorations(this._configuration.options)):null}deltaDecorations(oldDecorations,newDecorations){return this._modelData?0===oldDecorations.length&&0===newDecorations.length?oldDecorations:this._modelData.model.deltaDecorations(oldDecorations,newDecorations,this._id):[]}removeDecorations(decorationIds){this._modelData&&0!==decorationIds.length&&this._modelData.model.changeDecorations((changeAccessor=>{changeAccessor.deltaDecorations(decorationIds,[])}))}removeDecorationsByType(decorationTypeKey){const oldDecorationsIds=this._decorationTypeKeysToIds[decorationTypeKey];oldDecorationsIds&&this.deltaDecorations(oldDecorationsIds,[]),this._decorationTypeKeysToIds.hasOwnProperty(decorationTypeKey)&&delete this._decorationTypeKeysToIds[decorationTypeKey],this._decorationTypeSubtypes.hasOwnProperty(decorationTypeKey)&&delete this._decorationTypeSubtypes[decorationTypeKey]}getLayoutInfo(){return this._configuration.options.get(133)}createOverviewRuler(cssClassName){return this._modelData&&this._modelData.hasRealView?this._modelData.view.createOverviewRuler(cssClassName):null}getContainerDomNode(){return this._domElement}getDomNode(){return this._modelData&&this._modelData.hasRealView?this._modelData.view.domNode.domNode:null}delegateVerticalScrollbarPointerDown(browserEvent){this._modelData&&this._modelData.hasRealView&&this._modelData.view.delegateVerticalScrollbarPointerDown(browserEvent)}layout(dimension){this._configuration.observeContainer(dimension),this.render()}focus(){this._modelData&&this._modelData.hasRealView&&this._modelData.view.focus()}hasTextFocus(){return!(!this._modelData||!this._modelData.hasRealView)&&this._modelData.view.isFocused()}hasWidgetFocus(){return this._focusTracker&&this._focusTracker.hasFocus()}addContentWidget(widget){const widgetData={widget,position:widget.getPosition()};this._contentWidgets.hasOwnProperty(widget.getId())&&console.warn("Overwriting a content widget with the same id."),this._contentWidgets[widget.getId()]=widgetData,this._modelData&&this._modelData.hasRealView&&this._modelData.view.addContentWidget(widgetData)}layoutContentWidget(widget){const widgetId=widget.getId();if(this._contentWidgets.hasOwnProperty(widgetId)){const widgetData=this._contentWidgets[widgetId];widgetData.position=widget.getPosition(),this._modelData&&this._modelData.hasRealView&&this._modelData.view.layoutContentWidget(widgetData)}}removeContentWidget(widget){const widgetId=widget.getId();if(this._contentWidgets.hasOwnProperty(widgetId)){const widgetData=this._contentWidgets[widgetId];delete this._contentWidgets[widgetId],this._modelData&&this._modelData.hasRealView&&this._modelData.view.removeContentWidget(widgetData)}}addOverlayWidget(widget){const widgetData={widget,position:widget.getPosition()};this._overlayWidgets.hasOwnProperty(widget.getId())&&console.warn("Overwriting an overlay widget with the same id."),this._overlayWidgets[widget.getId()]=widgetData,this._modelData&&this._modelData.hasRealView&&this._modelData.view.addOverlayWidget(widgetData)}layoutOverlayWidget(widget){const widgetId=widget.getId();if(this._overlayWidgets.hasOwnProperty(widgetId)){const widgetData=this._overlayWidgets[widgetId];widgetData.position=widget.getPosition(),this._modelData&&this._modelData.hasRealView&&this._modelData.view.layoutOverlayWidget(widgetData)}}removeOverlayWidget(widget){const widgetId=widget.getId();if(this._overlayWidgets.hasOwnProperty(widgetId)){const widgetData=this._overlayWidgets[widgetId];delete this._overlayWidgets[widgetId],this._modelData&&this._modelData.hasRealView&&this._modelData.view.removeOverlayWidget(widgetData)}}changeViewZones(callback){this._modelData&&this._modelData.hasRealView&&this._modelData.view.change(callback)}getTargetAtClientPoint(clientX,clientY){return this._modelData&&this._modelData.hasRealView?this._modelData.view.getTargetAtClientPoint(clientX,clientY):null}getScrolledVisiblePosition(rawPosition){if(!this._modelData||!this._modelData.hasRealView)return null;const position=this._modelData.model.validatePosition(rawPosition),options=this._configuration.options,layoutInfo=options.get(133);return{top:CodeEditorWidget._getVerticalOffsetForPosition(this._modelData,position.lineNumber,position.column)-this.getScrollTop(),left:this._modelData.view.getOffsetForColumn(position.lineNumber,position.column)+layoutInfo.glyphMarginWidth+layoutInfo.lineNumbersWidth+layoutInfo.decorationsWidth-this.getScrollLeft(),height:options.get(61)}}getOffsetForColumn(lineNumber,column){return this._modelData&&this._modelData.hasRealView?this._modelData.view.getOffsetForColumn(lineNumber,column):-1}render(forceRedraw=!1){this._modelData&&this._modelData.hasRealView&&this._modelData.view.render(!0,forceRedraw)}setAriaOptions(options){this._modelData&&this._modelData.hasRealView&&this._modelData.view.setAriaOptions(options)}applyFontInfo(target){applyFontInfo(target,this._configuration.options.get(46))}setBanner(domNode,domNodeHeight){this._bannerDomNode&&this._domElement.contains(this._bannerDomNode)&&this._domElement.removeChild(this._bannerDomNode),this._bannerDomNode=domNode,this._configuration.setReservedHeight(domNode?domNodeHeight:0),this._bannerDomNode&&this._domElement.prepend(this._bannerDomNode)}_attachModel(model){if(!model)return void(this._modelData=null);const listenersToRemove=[];this._domElement.setAttribute("data-mode-id",model.getLanguageId()),this._configuration.setIsDominatedByLongLines(model.isDominatedByLongLines()),this._configuration.setModelLineCount(model.getLineCount()),model.onBeforeAttached();const viewModel=new ViewModel(this._id,this._configuration,model,DOMLineBreaksComputerFactory.create(),MonospaceLineBreaksComputerFactory.create(this._configuration.options),(callback=>dom.scheduleAtNextAnimationFrame(callback)),this.languageConfigurationService,this._themeService);listenersToRemove.push(model.onWillDispose((()=>this.setModel(null)))),listenersToRemove.push(viewModel.onEvent((e=>{switch(e.kind){case 0:this._onDidContentSizeChange.fire(e);break;case 1:this._editorTextFocus.setValue(e.hasFocus);break;case 2:this._onDidScrollChange.fire(e);break;case 3:this._onDidChangeViewZones.fire();break;case 4:this._onDidChangeHiddenAreas.fire();break;case 5:this._onDidAttemptReadOnlyEdit.fire();break;case 6:{e.reachedMaxCursorCount&&this._notificationService.warn(nls.localize("cursors.maximum","The number of cursors has been limited to {0}.",CursorsController.MAX_CURSOR_COUNT));const positions=[];for(let i=0,len=e.selections.length;i<len;i++)positions[i]=e.selections[i].getPosition();const e1={position:positions[0],secondaryPositions:positions.slice(1),reason:e.reason,source:e.source};this._onDidChangeCursorPosition.fire(e1);const e2={selection:e.selections[0],secondarySelections:e.selections.slice(1),modelVersionId:e.modelVersionId,oldSelections:e.oldSelections,oldModelVersionId:e.oldModelVersionId,source:e.source,reason:e.reason};this._onDidChangeCursorSelection.fire(e2);break}case 7:this._onDidChangeModelDecorations.fire(e.event);break;case 8:this._domElement.setAttribute("data-mode-id",model.getLanguageId()),this._onDidChangeModelLanguage.fire(e.event);break;case 9:this._onDidChangeModelLanguageConfiguration.fire(e.event);break;case 10:this._onDidChangeModelContent.fire(e.event);break;case 11:this._onDidChangeModelOptions.fire(e.event);break;case 12:this._onDidChangeModelTokens.fire(e.event)}})));const[view,hasRealView]=this._createView(viewModel);if(hasRealView){this._domElement.appendChild(view.domNode.domNode);let keys=Object.keys(this._contentWidgets);for(let i=0,len=keys.length;i<len;i++){const widgetId=keys[i];view.addContentWidget(this._contentWidgets[widgetId])}keys=Object.keys(this._overlayWidgets);for(let i=0,len=keys.length;i<len;i++){const widgetId=keys[i];view.addOverlayWidget(this._overlayWidgets[widgetId])}view.render(!1,!0),view.domNode.domNode.setAttribute("data-uri",model.uri.toString())}this._modelData=new ModelData(model,viewModel,view,hasRealView,listenersToRemove)}_createView(viewModel){let commandDelegate;commandDelegate=this.isSimpleWidget?{paste:(text,pasteOnNewLine,multicursorText,mode)=>{this._paste("keyboard",text,pasteOnNewLine,multicursorText,mode)},type:text=>{this._type("keyboard",text)},compositionType:(text,replacePrevCharCnt,replaceNextCharCnt,positionDelta)=>{this._compositionType("keyboard",text,replacePrevCharCnt,replaceNextCharCnt,positionDelta)},startComposition:()=>{this._startComposition()},endComposition:()=>{this._endComposition("keyboard")},cut:()=>{this._cut("keyboard")}}:{paste:(text,pasteOnNewLine,multicursorText,mode)=>{const payload={text,pasteOnNewLine,multicursorText,mode};this._commandService.executeCommand("paste",payload)},type:text=>{const payload={text};this._commandService.executeCommand("type",payload)},compositionType:(text,replacePrevCharCnt,replaceNextCharCnt,positionDelta)=>{if(replaceNextCharCnt||positionDelta){const payload={text,replacePrevCharCnt,replaceNextCharCnt,positionDelta};this._commandService.executeCommand("compositionType",payload)}else{const payload={text,replaceCharCnt:replacePrevCharCnt};this._commandService.executeCommand("replacePreviousChar",payload)}},startComposition:()=>{this._commandService.executeCommand("compositionStart",{})},endComposition:()=>{this._commandService.executeCommand("compositionEnd",{})},cut:()=>{this._commandService.executeCommand("cut",{})}};const viewUserInputEvents=new ViewUserInputEvents(viewModel.coordinatesConverter);viewUserInputEvents.onKeyDown=e=>this._onKeyDown.fire(e),viewUserInputEvents.onKeyUp=e=>this._onKeyUp.fire(e),viewUserInputEvents.onContextMenu=e=>this._onContextMenu.fire(e),viewUserInputEvents.onMouseMove=e=>this._onMouseMove.fire(e),viewUserInputEvents.onMouseLeave=e=>this._onMouseLeave.fire(e),viewUserInputEvents.onMouseDown=e=>this._onMouseDown.fire(e),viewUserInputEvents.onMouseUp=e=>this._onMouseUp.fire(e),viewUserInputEvents.onMouseDrag=e=>this._onMouseDrag.fire(e),viewUserInputEvents.onMouseDrop=e=>this._onMouseDrop.fire(e),viewUserInputEvents.onMouseDropCanceled=e=>this._onMouseDropCanceled.fire(e),viewUserInputEvents.onMouseWheel=e=>this._onMouseWheel.fire(e);return[new View(commandDelegate,this._configuration,this._themeService.getColorTheme(),viewModel,viewUserInputEvents,this._overflowWidgetsDomNode),!0]}_postDetachModelCleanup(detachedModel){null==detachedModel||detachedModel.removeAllDecorationsWithOwnerId(this._id)}_detachModel(){if(!this._modelData)return null;const model=this._modelData.model,removeDomNode=this._modelData.hasRealView?this._modelData.view.domNode.domNode:null;return this._modelData.dispose(),this._modelData=null,this._domElement.removeAttribute("data-mode-id"),removeDomNode&&this._domElement.contains(removeDomNode)&&this._domElement.removeChild(removeDomNode),this._bannerDomNode&&this._domElement.contains(this._bannerDomNode)&&this._domElement.removeChild(this._bannerDomNode),model}_removeDecorationType(key){this._codeEditorService.removeDecorationType(key)}hasModel(){return null!==this._modelData}showDropIndicatorAt(position){const newDecorations=[{range:new Range(position.lineNumber,position.column,position.lineNumber,position.column),options:CodeEditorWidget.dropIntoEditorDecorationOptions}];this._dropIntoEditorDecorations.set(newDecorations),this.revealPosition(position,1)}removeDropIndicator(){this._dropIntoEditorDecorations.clear()}};CodeEditorWidget.dropIntoEditorDecorationOptions=ModelDecorationOptions.register({description:"workbench-dnd-target",className:"dnd-target"}),CodeEditorWidget=__decorate([__param(3,IInstantiationService),__param(4,ICodeEditorService),__param(5,ICommandService),__param(6,IContextKeyService),__param(7,IThemeService),__param(8,INotificationService),__param(9,IAccessibilityService),__param(10,ILanguageConfigurationService),__param(11,ILanguageFeaturesService)],CodeEditorWidget);export{CodeEditorWidget};export class BooleanEventEmitter extends Disposable{constructor(_emitterOptions){super(),this._emitterOptions=_emitterOptions,this._onDidChangeToTrue=this._register(new Emitter(this._emitterOptions)),this.onDidChangeToTrue=this._onDidChangeToTrue.event,this._onDidChangeToFalse=this._register(new Emitter(this._emitterOptions)),this.onDidChangeToFalse=this._onDidChangeToFalse.event,this._value=0}setValue(_value){const value=_value?2:1;this._value!==value&&(this._value=value,2===this._value?this._onDidChangeToTrue.fire():1===this._value&&this._onDidChangeToFalse.fire())}}class EditorContextKeysManager extends Disposable{constructor(editor,contextKeyService){super(),this._editor=editor,contextKeyService.createKey("editorId",editor.getId()),this._editorSimpleInput=EditorContextKeys.editorSimpleInput.bindTo(contextKeyService),this._editorFocus=EditorContextKeys.focus.bindTo(contextKeyService),this._textInputFocus=EditorContextKeys.textInputFocus.bindTo(contextKeyService),this._editorTextFocus=EditorContextKeys.editorTextFocus.bindTo(contextKeyService),this._editorTabMovesFocus=EditorContextKeys.tabMovesFocus.bindTo(contextKeyService),this._editorReadonly=EditorContextKeys.readOnly.bindTo(contextKeyService),this._inDiffEditor=EditorContextKeys.inDiffEditor.bindTo(contextKeyService),this._editorColumnSelection=EditorContextKeys.columnSelection.bindTo(contextKeyService),this._hasMultipleSelections=EditorContextKeys.hasMultipleSelections.bindTo(contextKeyService),this._hasNonEmptySelection=EditorContextKeys.hasNonEmptySelection.bindTo(contextKeyService),this._canUndo=EditorContextKeys.canUndo.bindTo(contextKeyService),this._canRedo=EditorContextKeys.canRedo.bindTo(contextKeyService),this._register(this._editor.onDidChangeConfiguration((()=>this._updateFromConfig()))),this._register(this._editor.onDidChangeCursorSelection((()=>this._updateFromSelection()))),this._register(this._editor.onDidFocusEditorWidget((()=>this._updateFromFocus()))),this._register(this._editor.onDidBlurEditorWidget((()=>this._updateFromFocus()))),this._register(this._editor.onDidFocusEditorText((()=>this._updateFromFocus()))),this._register(this._editor.onDidBlurEditorText((()=>this._updateFromFocus()))),this._register(this._editor.onDidChangeModel((()=>this._updateFromModel()))),this._register(this._editor.onDidChangeConfiguration((()=>this._updateFromModel()))),this._updateFromConfig(),this._updateFromSelection(),this._updateFromFocus(),this._updateFromModel(),this._editorSimpleInput.set(this._editor.isSimpleWidget)}_updateFromConfig(){const options=this._editor.getOptions();this._editorTabMovesFocus.set(options.get(132)),this._editorReadonly.set(options.get(83)),this._inDiffEditor.set(options.get(56)),this._editorColumnSelection.set(options.get(18))}_updateFromSelection(){const selections=this._editor.getSelections();selections?(this._hasMultipleSelections.set(selections.length>1),this._hasNonEmptySelection.set(selections.some((s=>!s.isEmpty())))):(this._hasMultipleSelections.reset(),this._hasNonEmptySelection.reset())}_updateFromFocus(){this._editorFocus.set(this._editor.hasWidgetFocus()&&!this._editor.isSimpleWidget),this._editorTextFocus.set(this._editor.hasTextFocus()&&!this._editor.isSimpleWidget),this._textInputFocus.set(this._editor.hasTextFocus())}_updateFromModel(){const model=this._editor.getModel();this._canUndo.set(Boolean(model&&model.canUndo())),this._canRedo.set(Boolean(model&&model.canRedo()))}}export class EditorModeContext extends Disposable{constructor(_editor,_contextKeyService,_languageFeaturesService){super(),this._editor=_editor,this._contextKeyService=_contextKeyService,this._languageFeaturesService=_languageFeaturesService,this._langId=EditorContextKeys.languageId.bindTo(_contextKeyService),this._hasCompletionItemProvider=EditorContextKeys.hasCompletionItemProvider.bindTo(_contextKeyService),this._hasCodeActionsProvider=EditorContextKeys.hasCodeActionsProvider.bindTo(_contextKeyService),this._hasCodeLensProvider=EditorContextKeys.hasCodeLensProvider.bindTo(_contextKeyService),this._hasDefinitionProvider=EditorContextKeys.hasDefinitionProvider.bindTo(_contextKeyService),this._hasDeclarationProvider=EditorContextKeys.hasDeclarationProvider.bindTo(_contextKeyService),this._hasImplementationProvider=EditorContextKeys.hasImplementationProvider.bindTo(_contextKeyService),this._hasTypeDefinitionProvider=EditorContextKeys.hasTypeDefinitionProvider.bindTo(_contextKeyService),this._hasHoverProvider=EditorContextKeys.hasHoverProvider.bindTo(_contextKeyService),this._hasDocumentHighlightProvider=EditorContextKeys.hasDocumentHighlightProvider.bindTo(_contextKeyService),this._hasDocumentSymbolProvider=EditorContextKeys.hasDocumentSymbolProvider.bindTo(_contextKeyService),this._hasReferenceProvider=EditorContextKeys.hasReferenceProvider.bindTo(_contextKeyService),this._hasRenameProvider=EditorContextKeys.hasRenameProvider.bindTo(_contextKeyService),this._hasSignatureHelpProvider=EditorContextKeys.hasSignatureHelpProvider.bindTo(_contextKeyService),this._hasInlayHintsProvider=EditorContextKeys.hasInlayHintsProvider.bindTo(_contextKeyService),this._hasDocumentFormattingProvider=EditorContextKeys.hasDocumentFormattingProvider.bindTo(_contextKeyService),this._hasDocumentSelectionFormattingProvider=EditorContextKeys.hasDocumentSelectionFormattingProvider.bindTo(_contextKeyService),this._hasMultipleDocumentFormattingProvider=EditorContextKeys.hasMultipleDocumentFormattingProvider.bindTo(_contextKeyService),this._hasMultipleDocumentSelectionFormattingProvider=EditorContextKeys.hasMultipleDocumentSelectionFormattingProvider.bindTo(_contextKeyService),this._isInWalkThrough=EditorContextKeys.isInWalkThroughSnippet.bindTo(_contextKeyService);const update=()=>this._update();this._register(_editor.onDidChangeModel(update)),this._register(_editor.onDidChangeModelLanguage(update)),this._register(_languageFeaturesService.completionProvider.onDidChange(update)),this._register(_languageFeaturesService.codeActionProvider.onDidChange(update)),this._register(_languageFeaturesService.codeLensProvider.onDidChange(update)),this._register(_languageFeaturesService.definitionProvider.onDidChange(update)),this._register(_languageFeaturesService.declarationProvider.onDidChange(update)),this._register(_languageFeaturesService.implementationProvider.onDidChange(update)),this._register(_languageFeaturesService.typeDefinitionProvider.onDidChange(update)),this._register(_languageFeaturesService.hoverProvider.onDidChange(update)),this._register(_languageFeaturesService.documentHighlightProvider.onDidChange(update)),this._register(_languageFeaturesService.documentSymbolProvider.onDidChange(update)),this._register(_languageFeaturesService.referenceProvider.onDidChange(update)),this._register(_languageFeaturesService.renameProvider.onDidChange(update)),this._register(_languageFeaturesService.documentFormattingEditProvider.onDidChange(update)),this._register(_languageFeaturesService.documentRangeFormattingEditProvider.onDidChange(update)),this._register(_languageFeaturesService.signatureHelpProvider.onDidChange(update)),this._register(_languageFeaturesService.inlayHintsProvider.onDidChange(update)),update()}dispose(){super.dispose()}reset(){this._contextKeyService.bufferChangeEvents((()=>{this._langId.reset(),this._hasCompletionItemProvider.reset(),this._hasCodeActionsProvider.reset(),this._hasCodeLensProvider.reset(),this._hasDefinitionProvider.reset(),this._hasDeclarationProvider.reset(),this._hasImplementationProvider.reset(),this._hasTypeDefinitionProvider.reset(),this._hasHoverProvider.reset(),this._hasDocumentHighlightProvider.reset(),this._hasDocumentSymbolProvider.reset(),this._hasReferenceProvider.reset(),this._hasRenameProvider.reset(),this._hasDocumentFormattingProvider.reset(),this._hasDocumentSelectionFormattingProvider.reset(),this._hasSignatureHelpProvider.reset(),this._isInWalkThrough.reset()}))}_update(){const model=this._editor.getModel();model?this._contextKeyService.bufferChangeEvents((()=>{this._langId.set(model.getLanguageId()),this._hasCompletionItemProvider.set(this._languageFeaturesService.completionProvider.has(model)),this._hasCodeActionsProvider.set(this._languageFeaturesService.codeActionProvider.has(model)),this._hasCodeLensProvider.set(this._languageFeaturesService.codeLensProvider.has(model)),this._hasDefinitionProvider.set(this._languageFeaturesService.definitionProvider.has(model)),this._hasDeclarationProvider.set(this._languageFeaturesService.declarationProvider.has(model)),this._hasImplementationProvider.set(this._languageFeaturesService.implementationProvider.has(model)),this._hasTypeDefinitionProvider.set(this._languageFeaturesService.typeDefinitionProvider.has(model)),this._hasHoverProvider.set(this._languageFeaturesService.hoverProvider.has(model)),this._hasDocumentHighlightProvider.set(this._languageFeaturesService.documentHighlightProvider.has(model)),this._hasDocumentSymbolProvider.set(this._languageFeaturesService.documentSymbolProvider.has(model)),this._hasReferenceProvider.set(this._languageFeaturesService.referenceProvider.has(model)),this._hasRenameProvider.set(this._languageFeaturesService.renameProvider.has(model)),this._hasSignatureHelpProvider.set(this._languageFeaturesService.signatureHelpProvider.has(model)),this._hasInlayHintsProvider.set(this._languageFeaturesService.inlayHintsProvider.has(model)),this._hasDocumentFormattingProvider.set(this._languageFeaturesService.documentFormattingEditProvider.has(model)||this._languageFeaturesService.documentRangeFormattingEditProvider.has(model)),this._hasDocumentSelectionFormattingProvider.set(this._languageFeaturesService.documentRangeFormattingEditProvider.has(model)),this._hasMultipleDocumentFormattingProvider.set(this._languageFeaturesService.documentFormattingEditProvider.all(model).length+this._languageFeaturesService.documentRangeFormattingEditProvider.all(model).length>1),this._hasMultipleDocumentSelectionFormattingProvider.set(this._languageFeaturesService.documentRangeFormattingEditProvider.all(model).length>1),this._isInWalkThrough.set(model.uri.scheme===Schemas.walkThroughSnippet)})):this.reset()}}class CodeEditorWidgetFocusTracker extends Disposable{constructor(domElement){super(),this._onChange=this._register(new Emitter),this.onChange=this._onChange.event,this._hasFocus=!1,this._domFocusTracker=this._register(dom.trackFocus(domElement)),this._register(this._domFocusTracker.onDidFocus((()=>{this._hasFocus=!0,this._onChange.fire(void 0)}))),this._register(this._domFocusTracker.onDidBlur((()=>{this._hasFocus=!1,this._onChange.fire(void 0)})))}hasFocus(){return this._hasFocus}}class EditorDecorationsCollection{constructor(_editor,decorations){this._editor=_editor,this._decorationIds=[],this._isChangingDecorations=!1,Array.isArray(decorations)&&decorations.length>0&&this.set(decorations)}get length(){return this._decorationIds.length}onDidChange(listener,thisArgs,disposables){return this._editor.onDidChangeModelDecorations((e=>{this._isChangingDecorations||listener.call(thisArgs,e)}),disposables)}getRange(index){return this._editor.hasModel()?index>=this._decorationIds.length?null:this._editor.getModel().getDecorationRange(this._decorationIds[index]):null}getRanges(){if(!this._editor.hasModel())return[];const model=this._editor.getModel(),result=[];for(const decorationId of this._decorationIds){const range=model.getDecorationRange(decorationId);range&&result.push(range)}return result}has(decoration){return this._decorationIds.includes(decoration.id)}clear(){0!==this._decorationIds.length&&this.set([])}set(newDecorations){try{this._isChangingDecorations=!0,this._editor.changeDecorations((accessor=>{this._decorationIds=accessor.deltaDecorations(this._decorationIds,newDecorations)}))}finally{this._isChangingDecorations=!1}}}const squigglyStart=encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 6 3' enable-background='new 0 0 6 3' height='3' width='6'><g fill='"),squigglyEnd=encodeURIComponent("'><polygon points='5.5,0 2.5,3 1.1,3 4.1,0'/><polygon points='4,0 6,2 6,0.6 5.4,0'/><polygon points='0,2 1,3 2.4,3 0,0.6'/></g></svg>");function getSquigglySVGData(color){return squigglyStart+encodeURIComponent(color.toString())+squigglyEnd}const dotdotdotStart=encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" height="3" width="12"><g fill="'),dotdotdotEnd=encodeURIComponent('"><circle cx="1" cy="1" r="1"/><circle cx="5" cy="1" r="1"/><circle cx="9" cy="1" r="1"/></g></svg>');function getDotDotDotSVGData(color){return dotdotdotStart+encodeURIComponent(color.toString())+dotdotdotEnd}registerThemingParticipant(((theme,collector)=>{const errorBorderColor=theme.getColor(editorErrorBorder);errorBorderColor&&collector.addRule(`.monaco-editor .squiggly-error { border-bottom: 4px double ${errorBorderColor}; }`);const errorForeground=theme.getColor(editorErrorForeground);errorForeground&&collector.addRule(`.monaco-editor .squiggly-error { background: url("data:image/svg+xml,${getSquigglySVGData(errorForeground)}") repeat-x bottom left; }`);const errorBackground=theme.getColor(editorErrorBackground);errorBackground&&collector.addRule(`.monaco-editor .squiggly-error::before { display: block; content: ''; width: 100%; height: 100%; background: ${errorBackground}; }`);const warningBorderColor=theme.getColor(editorWarningBorder);warningBorderColor&&collector.addRule(`.monaco-editor .squiggly-warning { border-bottom: 4px double ${warningBorderColor}; }`);const warningForeground=theme.getColor(editorWarningForeground);warningForeground&&collector.addRule(`.monaco-editor .squiggly-warning { background: url("data:image/svg+xml,${getSquigglySVGData(warningForeground)}") repeat-x bottom left; }`);const warningBackground=theme.getColor(editorWarningBackground);warningBackground&&collector.addRule(`.monaco-editor .squiggly-warning::before { display: block; content: ''; width: 100%; height: 100%; background: ${warningBackground}; }`);const infoBorderColor=theme.getColor(editorInfoBorder);infoBorderColor&&collector.addRule(`.monaco-editor .squiggly-info { border-bottom: 4px double ${infoBorderColor}; }`);const infoForeground=theme.getColor(editorInfoForeground);infoForeground&&collector.addRule(`.monaco-editor .squiggly-info { background: url("data:image/svg+xml,${getSquigglySVGData(infoForeground)}") repeat-x bottom left; }`);const infoBackground=theme.getColor(editorInfoBackground);infoBackground&&collector.addRule(`.monaco-editor .squiggly-info::before { display: block; content: ''; width: 100%; height: 100%; background: ${infoBackground}; }`);const hintBorderColor=theme.getColor(editorHintBorder);hintBorderColor&&collector.addRule(`.monaco-editor .squiggly-hint { border-bottom: 2px dotted ${hintBorderColor}; }`);const hintForeground=theme.getColor(editorHintForeground);hintForeground&&collector.addRule(`.monaco-editor .squiggly-hint { background: url("data:image/svg+xml,${getDotDotDotSVGData(hintForeground)}") no-repeat bottom left; }`);const unnecessaryForeground=theme.getColor(editorUnnecessaryCodeOpacity);unnecessaryForeground&&collector.addRule(`.monaco-editor.showUnused .squiggly-inline-unnecessary { opacity: ${unnecessaryForeground.rgba.a}; }`);const unnecessaryBorder=theme.getColor(editorUnnecessaryCodeBorder);unnecessaryBorder&&collector.addRule(`.monaco-editor.showUnused .squiggly-unnecessary { border-bottom: 2px dashed ${unnecessaryBorder}; }`);const deprecatedForeground=theme.getColor(editorForeground)||"inherit";collector.addRule(`.monaco-editor.showDeprecated .squiggly-inline-deprecated { text-decoration: line-through; text-decoration-color: ${deprecatedForeground}}`)}));