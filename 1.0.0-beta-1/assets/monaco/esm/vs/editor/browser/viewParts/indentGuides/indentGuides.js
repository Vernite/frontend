import"./indentGuides.css";import{DynamicViewOverlay}from"../../view/dynamicViewOverlay.js";import{editorActiveIndentGuides,editorBracketHighlightingForeground1,editorBracketHighlightingForeground2,editorBracketHighlightingForeground3,editorBracketHighlightingForeground4,editorBracketHighlightingForeground5,editorBracketHighlightingForeground6,editorBracketPairGuideActiveBackground1,editorBracketPairGuideActiveBackground2,editorBracketPairGuideActiveBackground3,editorBracketPairGuideActiveBackground4,editorBracketPairGuideActiveBackground5,editorBracketPairGuideActiveBackground6,editorBracketPairGuideBackground1,editorBracketPairGuideBackground2,editorBracketPairGuideBackground3,editorBracketPairGuideBackground4,editorBracketPairGuideBackground5,editorBracketPairGuideBackground6,editorIndentGuides}from"../../../common/core/editorColorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";import{Position}from"../../../common/core/position.js";import{ArrayQueue}from"../../../../base/common/arrays.js";import{isDefined}from"../../../../base/common/types.js";import{BracketPairGuidesClassNames}from"../../../common/model/guidesTextModelPart.js";import{IndentGuide,HorizontalGuidesState}from"../../../common/textModelGuides.js";export class IndentGuidesOverlay extends DynamicViewOverlay{constructor(context){super(),this._context=context,this._primaryPosition=null;const options=this._context.configuration.options,wrappingInfo=options.get(134),fontInfo=options.get(46);this._lineHeight=options.get(61),this._spaceWidth=fontInfo.spaceWidth,this._maxIndentLeft=-1===wrappingInfo.wrappingColumn?-1:wrappingInfo.wrappingColumn*fontInfo.typicalHalfwidthCharacterWidth,this._bracketPairGuideOptions=options.get(13),this._renderResult=null,this._context.addEventHandler(this)}dispose(){this._context.removeEventHandler(this),this._renderResult=null,super.dispose()}onConfigurationChanged(e){const options=this._context.configuration.options,wrappingInfo=options.get(134),fontInfo=options.get(46);return this._lineHeight=options.get(61),this._spaceWidth=fontInfo.spaceWidth,this._maxIndentLeft=-1===wrappingInfo.wrappingColumn?-1:wrappingInfo.wrappingColumn*fontInfo.typicalHalfwidthCharacterWidth,this._bracketPairGuideOptions=options.get(13),!0}onCursorStateChanged(e){var _a;const newPosition=e.selections[0].getPosition();return!(null===(_a=this._primaryPosition)||void 0===_a?void 0:_a.equals(newPosition))&&(this._primaryPosition=newPosition,!0)}onDecorationsChanged(e){return!0}onFlushed(e){return!0}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return e.scrollTopChanged}onZonesChanged(e){return!0}onLanguageConfigurationChanged(e){return!0}prepareRender(ctx){var _a,_b,_c,_d;if(!this._bracketPairGuideOptions.indentation&&!1===this._bracketPairGuideOptions.bracketPairs)return void(this._renderResult=null);const visibleStartLineNumber=ctx.visibleRange.startLineNumber,visibleEndLineNumber=ctx.visibleRange.endLineNumber,scrollWidth=ctx.scrollWidth,lineHeight=this._lineHeight,activeCursorPosition=this._primaryPosition,indents=this.getGuidesByLine(visibleStartLineNumber,visibleEndLineNumber,activeCursorPosition),output=[];for(let lineNumber=visibleStartLineNumber;lineNumber<=visibleEndLineNumber;lineNumber++){const lineIndex=lineNumber-visibleStartLineNumber,indent=indents[lineIndex];let result="";const leftOffset=null!==(_b=null===(_a=ctx.visibleRangeForPosition(new Position(lineNumber,1)))||void 0===_a?void 0:_a.left)&&void 0!==_b?_b:0;for(const guide of indent){const left=-1===guide.column?leftOffset+(guide.visibleColumn-1)*this._spaceWidth:ctx.visibleRangeForPosition(new Position(lineNumber,guide.column)).left;if(left>scrollWidth||this._maxIndentLeft>0&&left>this._maxIndentLeft)break;const className=guide.horizontalLine?guide.horizontalLine.top?"horizontal-top":"horizontal-bottom":"vertical",width=guide.horizontalLine?(null!==(_d=null===(_c=ctx.visibleRangeForPosition(new Position(lineNumber,guide.horizontalLine.endColumn)))||void 0===_c?void 0:_c.left)&&void 0!==_d?_d:left+this._spaceWidth)-left:this._spaceWidth;result+=`<div class="core-guide ${guide.className} ${className}" style="left:${left}px;height:${lineHeight}px;width:${width}px"></div>`}output[lineIndex]=result}this._renderResult=output}getGuidesByLine(visibleStartLineNumber,visibleEndLineNumber,activeCursorPosition){const bracketGuides=!1!==this._bracketPairGuideOptions.bracketPairs?this._context.viewModel.getBracketGuidesInRangeByLine(visibleStartLineNumber,visibleEndLineNumber,activeCursorPosition,{highlightActive:this._bracketPairGuideOptions.highlightActiveBracketPair,horizontalGuides:!0===this._bracketPairGuideOptions.bracketPairsHorizontal?HorizontalGuidesState.Enabled:"active"===this._bracketPairGuideOptions.bracketPairsHorizontal?HorizontalGuidesState.EnabledForActive:HorizontalGuidesState.Disabled,includeInactive:!0===this._bracketPairGuideOptions.bracketPairs}):null,indentGuides=this._bracketPairGuideOptions.indentation?this._context.viewModel.getLinesIndentGuides(visibleStartLineNumber,visibleEndLineNumber):null;let activeIndentStartLineNumber=0,activeIndentEndLineNumber=0,activeIndentLevel=0;if(!1!==this._bracketPairGuideOptions.highlightActiveIndentation&&activeCursorPosition){const activeIndentInfo=this._context.viewModel.getActiveIndentGuide(activeCursorPosition.lineNumber,visibleStartLineNumber,visibleEndLineNumber);activeIndentStartLineNumber=activeIndentInfo.startLineNumber,activeIndentEndLineNumber=activeIndentInfo.endLineNumber,activeIndentLevel=activeIndentInfo.indent}const{indentSize}=this._context.viewModel.model.getOptions(),result=[];for(let lineNumber=visibleStartLineNumber;lineNumber<=visibleEndLineNumber;lineNumber++){const lineGuides=new Array;result.push(lineGuides);const bracketGuidesInLine=bracketGuides?bracketGuides[lineNumber-visibleStartLineNumber]:[],bracketGuidesInLineQueue=new ArrayQueue(bracketGuidesInLine),indentGuidesInLine=indentGuides?indentGuides[lineNumber-visibleStartLineNumber]:[];for(let indentLvl=1;indentLvl<=indentGuidesInLine;indentLvl++){const indentGuide=(indentLvl-1)*indentSize+1,isActive=("always"===this._bracketPairGuideOptions.highlightActiveIndentation||0===bracketGuidesInLine.length)&&activeIndentStartLineNumber<=lineNumber&&lineNumber<=activeIndentEndLineNumber&&indentLvl===activeIndentLevel;lineGuides.push(...bracketGuidesInLineQueue.takeWhile((g=>g.visibleColumn<indentGuide))||[]);const peeked=bracketGuidesInLineQueue.peek();peeked&&peeked.visibleColumn===indentGuide&&!peeked.horizontalLine||lineGuides.push(new IndentGuide(indentGuide,-1,isActive?"core-guide-indent-active":"core-guide-indent",null,-1,-1))}lineGuides.push(...bracketGuidesInLineQueue.takeWhile((g=>!0))||[])}return result}render(startLineNumber,lineNumber){if(!this._renderResult)return"";const lineIndex=lineNumber-startLineNumber;return lineIndex<0||lineIndex>=this._renderResult.length?"":this._renderResult[lineIndex]}}function transparentToUndefined(color){if(!color||!color.isTransparent())return color}registerThemingParticipant(((theme,collector)=>{const editorIndentGuidesColor=theme.getColor(editorIndentGuides);editorIndentGuidesColor&&collector.addRule(`.monaco-editor .lines-content .core-guide-indent { box-shadow: 1px 0 0 0 ${editorIndentGuidesColor} inset; }`);const editorActiveIndentGuidesColor=theme.getColor(editorActiveIndentGuides)||editorIndentGuidesColor;editorActiveIndentGuidesColor&&collector.addRule(`.monaco-editor .lines-content .core-guide-indent-active { box-shadow: 1px 0 0 0 ${editorActiveIndentGuidesColor} inset; }`);const colors=[{bracketColor:editorBracketHighlightingForeground1,guideColor:editorBracketPairGuideBackground1,guideColorActive:editorBracketPairGuideActiveBackground1},{bracketColor:editorBracketHighlightingForeground2,guideColor:editorBracketPairGuideBackground2,guideColorActive:editorBracketPairGuideActiveBackground2},{bracketColor:editorBracketHighlightingForeground3,guideColor:editorBracketPairGuideBackground3,guideColorActive:editorBracketPairGuideActiveBackground3},{bracketColor:editorBracketHighlightingForeground4,guideColor:editorBracketPairGuideBackground4,guideColorActive:editorBracketPairGuideActiveBackground4},{bracketColor:editorBracketHighlightingForeground5,guideColor:editorBracketPairGuideBackground5,guideColorActive:editorBracketPairGuideActiveBackground5},{bracketColor:editorBracketHighlightingForeground6,guideColor:editorBracketPairGuideBackground6,guideColorActive:editorBracketPairGuideActiveBackground6}],colorProvider=new BracketPairGuidesClassNames,colorValues=colors.map((c=>{var _a,_b;const bracketColor=theme.getColor(c.bracketColor),guideColor=theme.getColor(c.guideColor),guideColorActive=theme.getColor(c.guideColorActive),effectiveGuideColor=transparentToUndefined(null!==(_a=transparentToUndefined(guideColor))&&void 0!==_a?_a:null==bracketColor?void 0:bracketColor.transparent(.3)),effectiveGuideColorActive=transparentToUndefined(null!==(_b=transparentToUndefined(guideColorActive))&&void 0!==_b?_b:bracketColor);if(effectiveGuideColor&&effectiveGuideColorActive)return{guideColor:effectiveGuideColor,guideColorActive:effectiveGuideColorActive}})).filter(isDefined);if(colorValues.length>0){for(let level=0;level<30;level++){const colors=colorValues[level%colorValues.length];collector.addRule(`.monaco-editor .${colorProvider.getInlineClassNameOfLevel(level).replace(/ /g,".")} { --guide-color: ${colors.guideColor}; --guide-color-active: ${colors.guideColorActive}; }`)}collector.addRule(".monaco-editor .vertical { box-shadow: 1px 0 0 0 var(--guide-color) inset; }"),collector.addRule(".monaco-editor .horizontal-top { border-top: 1px solid var(--guide-color); }"),collector.addRule(".monaco-editor .horizontal-bottom { border-bottom: 1px solid var(--guide-color); }"),collector.addRule(`.monaco-editor .vertical.${colorProvider.activeClassName} { box-shadow: 1px 0 0 0 var(--guide-color-active) inset; }`),collector.addRule(`.monaco-editor .horizontal-top.${colorProvider.activeClassName} { border-top: 1px solid var(--guide-color-active); }`),collector.addRule(`.monaco-editor .horizontal-bottom.${colorProvider.activeClassName} { border-bottom: 1px solid var(--guide-color-active); }`)}}));