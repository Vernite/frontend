var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import*as aria from"../../../base/browser/ui/aria/aria.js";import{Disposable,toDisposable,DisposableStore}from"../../../base/common/lifecycle.js";import{ICodeEditorService}from"../../browser/services/codeEditorService.js";import{CodeEditorWidget}from"../../browser/widget/codeEditorWidget.js";import{DiffEditorWidget}from"../../browser/widget/diffEditorWidget.js";import{InternalEditorAction}from"../../common/editorAction.js";import{IEditorWorkerService}from"../../common/services/editorWorker.js";import{StandaloneKeybindingService,updateConfigurationService}from"./standaloneServices.js";import{IStandaloneThemeService}from"../common/standaloneTheme.js";import{MenuId,MenuRegistry}from"../../../platform/actions/common/actions.js";import{CommandsRegistry,ICommandService}from"../../../platform/commands/common/commands.js";import{IConfigurationService}from"../../../platform/configuration/common/configuration.js";import{ContextKeyExpr,IContextKeyService}from"../../../platform/contextkey/common/contextkey.js";import{IContextMenuService}from"../../../platform/contextview/browser/contextView.js";import{IInstantiationService}from"../../../platform/instantiation/common/instantiation.js";import{IKeybindingService}from"../../../platform/keybinding/common/keybinding.js";import{INotificationService}from"../../../platform/notification/common/notification.js";import{IThemeService}from"../../../platform/theme/common/themeService.js";import{IAccessibilityService}from"../../../platform/accessibility/common/accessibility.js";import{StandaloneCodeEditorNLS}from"../../common/standaloneStrings.js";import{IClipboardService}from"../../../platform/clipboard/common/clipboardService.js";import{IEditorProgressService}from"../../../platform/progress/common/progress.js";import{IModelService}from"../../common/services/model.js";import{ILanguageService}from"../../common/languages/language.js";import{StandaloneCodeEditorService}from"./standaloneCodeEditorService.js";import{PLAINTEXT_LANGUAGE_ID}from"../../common/languages/modesRegistry.js";import{ILanguageConfigurationService}from"../../common/languages/languageConfigurationRegistry.js";import{ILanguageFeaturesService}from"../../common/services/languageFeatures.js";let LAST_GENERATED_COMMAND_ID=0,ariaDomNodeCreated=!1;function createAriaDomNode(parent){if(!parent){if(ariaDomNodeCreated)return;ariaDomNodeCreated=!0}aria.setARIAContainer(parent||document.body)}let StandaloneCodeEditor=class StandaloneCodeEditor extends CodeEditorWidget{constructor(domElement,_options,instantiationService,codeEditorService,commandService,contextKeyService,keybindingService,themeService,notificationService,accessibilityService,languageConfigurationService,languageFeaturesService){const options=Object.assign({},_options);options.ariaLabel=options.ariaLabel||StandaloneCodeEditorNLS.editorViewAccessibleLabel,options.ariaLabel=options.ariaLabel+";"+StandaloneCodeEditorNLS.accessibilityHelpMessage,super(domElement,options,{},instantiationService,codeEditorService,commandService,contextKeyService,themeService,notificationService,accessibilityService,languageConfigurationService,languageFeaturesService),this._standaloneKeybindingService=keybindingService instanceof StandaloneKeybindingService?keybindingService:null,createAriaDomNode(options.ariaContainerElement)}addCommand(keybinding,handler,context){if(!this._standaloneKeybindingService)return console.warn("Cannot add command because the editor is configured with an unrecognized KeybindingService"),null;const commandId="DYNAMIC_"+ ++LAST_GENERATED_COMMAND_ID,whenExpression=ContextKeyExpr.deserialize(context);return this._standaloneKeybindingService.addDynamicKeybinding(commandId,keybinding,handler,whenExpression),commandId}createContextKey(key,defaultValue){return this._contextKeyService.createKey(key,defaultValue)}addAction(_descriptor){if("string"!=typeof _descriptor.id||"string"!=typeof _descriptor.label||"function"!=typeof _descriptor.run)throw new Error("Invalid action descriptor, `id`, `label` and `run` are required properties!");if(!this._standaloneKeybindingService)return console.warn("Cannot add keybinding because the editor is configured with an unrecognized KeybindingService"),Disposable.None;const id=_descriptor.id,label=_descriptor.label,precondition=ContextKeyExpr.and(ContextKeyExpr.equals("editorId",this.getId()),ContextKeyExpr.deserialize(_descriptor.precondition)),keybindings=_descriptor.keybindings,keybindingsWhen=ContextKeyExpr.and(precondition,ContextKeyExpr.deserialize(_descriptor.keybindingContext)),contextMenuGroupId=_descriptor.contextMenuGroupId||null,contextMenuOrder=_descriptor.contextMenuOrder||0,run=(accessor,...args)=>Promise.resolve(_descriptor.run(this,...args)),toDispose=new DisposableStore,uniqueId=this.getId()+":"+id;if(toDispose.add(CommandsRegistry.registerCommand(uniqueId,run)),contextMenuGroupId){const menuItem={command:{id:uniqueId,title:label},when:precondition,group:contextMenuGroupId,order:contextMenuOrder};toDispose.add(MenuRegistry.appendMenuItem(MenuId.EditorContext,menuItem))}if(Array.isArray(keybindings))for(const kb of keybindings)toDispose.add(this._standaloneKeybindingService.addDynamicKeybinding(uniqueId,kb,run,keybindingsWhen));const internalAction=new InternalEditorAction(uniqueId,label,label,precondition,run,this._contextKeyService);return this._actions[id]=internalAction,toDispose.add(toDisposable((()=>{delete this._actions[id]}))),toDispose}_triggerCommand(handlerId,payload){if(this._codeEditorService instanceof StandaloneCodeEditorService)try{this._codeEditorService.setActiveCodeEditor(this),super._triggerCommand(handlerId,payload)}finally{this._codeEditorService.setActiveCodeEditor(null)}else super._triggerCommand(handlerId,payload)}};StandaloneCodeEditor=__decorate([__param(2,IInstantiationService),__param(3,ICodeEditorService),__param(4,ICommandService),__param(5,IContextKeyService),__param(6,IKeybindingService),__param(7,IThemeService),__param(8,INotificationService),__param(9,IAccessibilityService),__param(10,ILanguageConfigurationService),__param(11,ILanguageFeaturesService)],StandaloneCodeEditor);export{StandaloneCodeEditor};let StandaloneEditor=class StandaloneEditor extends StandaloneCodeEditor{constructor(domElement,_options,instantiationService,codeEditorService,commandService,contextKeyService,keybindingService,themeService,notificationService,configurationService,accessibilityService,modelService,languageService,languageConfigurationService,languageFeaturesService){const options=Object.assign({},_options);updateConfigurationService(configurationService,options,!1);const themeDomRegistration=themeService.registerEditorContainer(domElement);"string"==typeof options.theme&&themeService.setTheme(options.theme),void 0!==options.autoDetectHighContrast&&themeService.setAutoDetectHighContrast(Boolean(options.autoDetectHighContrast));const _model=options.model;let model;if(delete options.model,super(domElement,options,instantiationService,codeEditorService,commandService,contextKeyService,keybindingService,themeService,notificationService,accessibilityService,languageConfigurationService,languageFeaturesService),this._configurationService=configurationService,this._standaloneThemeService=themeService,this._register(themeDomRegistration),void 0===_model){const languageId=languageService.getLanguageIdByMimeType(options.language)||options.language||PLAINTEXT_LANGUAGE_ID;model=createTextModel(modelService,languageService,options.value||"",languageId,void 0),this._ownsModel=!0}else model=_model,this._ownsModel=!1;if(this._attachModel(model),model){const e={oldModelUrl:null,newModelUrl:model.uri};this._onDidChangeModel.fire(e)}}dispose(){super.dispose()}updateOptions(newOptions){updateConfigurationService(this._configurationService,newOptions,!1),"string"==typeof newOptions.theme&&this._standaloneThemeService.setTheme(newOptions.theme),void 0!==newOptions.autoDetectHighContrast&&this._standaloneThemeService.setAutoDetectHighContrast(Boolean(newOptions.autoDetectHighContrast)),super.updateOptions(newOptions)}_postDetachModelCleanup(detachedModel){super._postDetachModelCleanup(detachedModel),detachedModel&&this._ownsModel&&(detachedModel.dispose(),this._ownsModel=!1)}};StandaloneEditor=__decorate([__param(2,IInstantiationService),__param(3,ICodeEditorService),__param(4,ICommandService),__param(5,IContextKeyService),__param(6,IKeybindingService),__param(7,IStandaloneThemeService),__param(8,INotificationService),__param(9,IConfigurationService),__param(10,IAccessibilityService),__param(11,IModelService),__param(12,ILanguageService),__param(13,ILanguageConfigurationService),__param(14,ILanguageFeaturesService)],StandaloneEditor);export{StandaloneEditor};let StandaloneDiffEditor=class StandaloneDiffEditor extends DiffEditorWidget{constructor(domElement,_options,instantiationService,contextKeyService,editorWorkerService,codeEditorService,themeService,notificationService,configurationService,contextMenuService,editorProgressService,clipboardService){const options=Object.assign({},_options);updateConfigurationService(configurationService,options,!0);const themeDomRegistration=themeService.registerEditorContainer(domElement);"string"==typeof options.theme&&themeService.setTheme(options.theme),void 0!==options.autoDetectHighContrast&&themeService.setAutoDetectHighContrast(Boolean(options.autoDetectHighContrast)),super(domElement,options,{},clipboardService,editorWorkerService,contextKeyService,instantiationService,codeEditorService,themeService,notificationService,contextMenuService,editorProgressService),this._configurationService=configurationService,this._standaloneThemeService=themeService,this._register(themeDomRegistration)}dispose(){super.dispose()}updateOptions(newOptions){updateConfigurationService(this._configurationService,newOptions,!0),"string"==typeof newOptions.theme&&this._standaloneThemeService.setTheme(newOptions.theme),void 0!==newOptions.autoDetectHighContrast&&this._standaloneThemeService.setAutoDetectHighContrast(Boolean(newOptions.autoDetectHighContrast)),super.updateOptions(newOptions)}_createInnerEditor(instantiationService,container,options){return instantiationService.createInstance(StandaloneCodeEditor,container,options)}getOriginalEditor(){return super.getOriginalEditor()}getModifiedEditor(){return super.getModifiedEditor()}addCommand(keybinding,handler,context){return this.getModifiedEditor().addCommand(keybinding,handler,context)}createContextKey(key,defaultValue){return this.getModifiedEditor().createContextKey(key,defaultValue)}addAction(descriptor){return this.getModifiedEditor().addAction(descriptor)}};StandaloneDiffEditor=__decorate([__param(2,IInstantiationService),__param(3,IContextKeyService),__param(4,IEditorWorkerService),__param(5,ICodeEditorService),__param(6,IStandaloneThemeService),__param(7,INotificationService),__param(8,IConfigurationService),__param(9,IContextMenuService),__param(10,IEditorProgressService),__param(11,IClipboardService)],StandaloneDiffEditor);export{StandaloneDiffEditor};export function createTextModel(modelService,languageService,value,languageId,uri){if(value=value||"",!languageId){const firstLF=value.indexOf("\n");let firstLine=value;return-1!==firstLF&&(firstLine=value.substring(0,firstLF)),doCreateModel(modelService,value,languageService.createByFilepathOrFirstLine(uri||null,firstLine),uri)}return doCreateModel(modelService,value,languageService.createById(languageId),uri)}function doCreateModel(modelService,value,languageSelection,uri){return modelService.createModel(value,languageSelection,uri)}