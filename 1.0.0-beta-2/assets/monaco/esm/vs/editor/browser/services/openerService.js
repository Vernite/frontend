var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import*as dom from"../../../base/browser/dom.js";import{CancellationToken}from"../../../base/common/cancellation.js";import{LinkedList}from"../../../base/common/linkedList.js";import{ResourceMap}from"../../../base/common/map.js";import{parse}from"../../../base/common/marshalling.js";import{Schemas}from"../../../base/common/network.js";import{normalizePath}from"../../../base/common/resources.js";import{URI}from"../../../base/common/uri.js";import{ICodeEditorService}from"./codeEditorService.js";import{ICommandService}from"../../../platform/commands/common/commands.js";import{EditorOpenSource}from"../../../platform/editor/common/editor.js";import{extractSelection,matchesScheme,matchesSomeScheme}from"../../../platform/opener/common/opener.js";let CommandOpener=class CommandOpener{constructor(_commandService){this._commandService=_commandService}open(target,options){return __awaiter(this,void 0,void 0,(function*(){if(!matchesScheme(target,Schemas.command))return!1;if(!(null==options?void 0:options.allowCommands))return!0;"string"==typeof target&&(target=URI.parse(target));let args=[];try{args=parse(decodeURIComponent(target.query))}catch(_a){try{args=parse(target.query)}catch(_b){}}return Array.isArray(args)||(args=[args]),yield this._commandService.executeCommand(target.path,...args),!0}))}};CommandOpener=__decorate([__param(0,ICommandService)],CommandOpener);let EditorOpener=class EditorOpener{constructor(_editorService){this._editorService=_editorService}open(target,options){return __awaiter(this,void 0,void 0,(function*(){"string"==typeof target&&(target=URI.parse(target));const{selection,uri}=extractSelection(target);return(target=uri).scheme===Schemas.file&&(target=normalizePath(target)),yield this._editorService.openCodeEditor({resource:target,options:Object.assign({selection,source:(null==options?void 0:options.fromUserGesture)?EditorOpenSource.USER:EditorOpenSource.API},null==options?void 0:options.editorOptions)},this._editorService.getFocusedCodeEditor(),null==options?void 0:options.openToSide),!0}))}};EditorOpener=__decorate([__param(0,ICodeEditorService)],EditorOpener);let OpenerService=class OpenerService{constructor(editorService,commandService){this._openers=new LinkedList,this._validators=new LinkedList,this._resolvers=new LinkedList,this._resolvedUriTargets=new ResourceMap((uri=>uri.with({path:null,fragment:null,query:null}).toString())),this._externalOpeners=new LinkedList,this._defaultExternalOpener={openExternal:href=>__awaiter(this,void 0,void 0,(function*(){return matchesSomeScheme(href,Schemas.http,Schemas.https)?dom.windowOpenNoOpener(href):window.location.href=href,!0}))},this._openers.push({open:(target,options)=>__awaiter(this,void 0,void 0,(function*(){return!(!(null==options?void 0:options.openExternal)&&!matchesSomeScheme(target,Schemas.mailto,Schemas.http,Schemas.https,Schemas.vsls))&&(yield this._doOpenExternal(target,options),!0)}))}),this._openers.push(new CommandOpener(commandService)),this._openers.push(new EditorOpener(editorService))}registerOpener(opener){return{dispose:this._openers.unshift(opener)}}registerValidator(validator){return{dispose:this._validators.push(validator)}}registerExternalUriResolver(resolver){return{dispose:this._resolvers.push(resolver)}}setDefaultExternalOpener(externalOpener){this._defaultExternalOpener=externalOpener}registerExternalOpener(opener){return{dispose:this._externalOpeners.push(opener)}}open(target,options){var _a;return __awaiter(this,void 0,void 0,(function*(){const targetURI="string"==typeof target?URI.parse(target):target,validationTarget=null!==(_a=this._resolvedUriTargets.get(targetURI))&&void 0!==_a?_a:target;for(const validator of this._validators)if(!(yield validator.shouldOpen(validationTarget,options)))return!1;for(const opener of this._openers){if(yield opener.open(target,options))return!0}return!1}))}resolveExternalUri(resource,options){return __awaiter(this,void 0,void 0,(function*(){for(const resolver of this._resolvers)try{const result=yield resolver.resolveExternalUri(resource,options);if(result)return this._resolvedUriTargets.has(result.resolved)||this._resolvedUriTargets.set(result.resolved,resource),result}catch(_a){}throw new Error("Could not resolve external URI: "+resource.toString())}))}_doOpenExternal(resource,options){return __awaiter(this,void 0,void 0,(function*(){const uri="string"==typeof resource?URI.parse(resource):resource;let externalUri,href;try{externalUri=(yield this.resolveExternalUri(uri,options)).resolved}catch(_a){externalUri=uri}if(href="string"==typeof resource&&uri.toString()===externalUri.toString()?resource:encodeURI(externalUri.toString(!0)),null==options?void 0:options.allowContributedOpeners){const preferredOpenerId="string"==typeof(null==options?void 0:options.allowContributedOpeners)?null==options?void 0:options.allowContributedOpeners:void 0;for(const opener of this._externalOpeners){if(yield opener.openExternal(href,{sourceUri:uri,preferredOpenerId},CancellationToken.None))return!0}}return this._defaultExternalOpener.openExternal(href,{sourceUri:uri},CancellationToken.None)}))}dispose(){this._validators.clear()}};OpenerService=__decorate([__param(0,ICodeEditorService),__param(1,ICommandService)],OpenerService);export{OpenerService};