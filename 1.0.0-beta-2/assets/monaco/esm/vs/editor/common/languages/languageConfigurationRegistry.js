var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import{Emitter}from"../../../base/common/event.js";import{Disposable,toDisposable}from"../../../base/common/lifecycle.js";import*as strings from"../../../base/common/strings.js";import{DEFAULT_WORD_REGEXP,ensureValidWordDefinition}from"../core/wordHelper.js";import{AutoClosingPairs}from"./languageConfiguration.js";import{createScopedLineTokens}from"./supports.js";import{CharacterPairSupport}from"./supports/characterPair.js";import{BracketElectricCharacterSupport}from"./supports/electricCharacter.js";import{IndentRulesSupport}from"./supports/indentRules.js";import{OnEnterSupport}from"./supports/onEnter.js";import{RichEditBrackets}from"./supports/richEditBrackets.js";import{createDecorator}from"../../../platform/instantiation/common/instantiation.js";import{IConfigurationService}from"../../../platform/configuration/common/configuration.js";import{ILanguageService}from"./language.js";import{registerSingleton}from"../../../platform/instantiation/common/extensions.js";import{PLAINTEXT_LANGUAGE_ID}from"./modesRegistry.js";import{LanguageBracketsConfiguration}from"./supports/languageBracketsConfiguration.js";export class LanguageConfigurationServiceChangeEvent{constructor(languageId){this.languageId=languageId}affects(languageId){return!this.languageId||this.languageId===languageId}}export const ILanguageConfigurationService=createDecorator("languageConfigurationService");let LanguageConfigurationService=class LanguageConfigurationService extends Disposable{constructor(configurationService,languageService){super(),this.configurationService=configurationService,this.languageService=languageService,this._registry=this._register(new LanguageConfigurationRegistry),this.onDidChangeEmitter=this._register(new Emitter),this.onDidChange=this.onDidChangeEmitter.event,this.configurations=new Map;const languageConfigKeys=new Set(Object.values(customizedLanguageConfigKeys));this._register(this.configurationService.onDidChangeConfiguration((e=>{const globalConfigChanged=e.change.keys.some((k=>languageConfigKeys.has(k))),localConfigChanged=e.change.overrides.filter((([overrideLangName,keys])=>keys.some((k=>languageConfigKeys.has(k))))).map((([overrideLangName])=>overrideLangName));if(globalConfigChanged)this.configurations.clear(),this.onDidChangeEmitter.fire(new LanguageConfigurationServiceChangeEvent(void 0));else for(const languageId of localConfigChanged)this.languageService.isRegisteredLanguageId(languageId)&&(this.configurations.delete(languageId),this.onDidChangeEmitter.fire(new LanguageConfigurationServiceChangeEvent(languageId)))}))),this._register(this._registry.onDidChange((e=>{this.configurations.delete(e.languageId),this.onDidChangeEmitter.fire(new LanguageConfigurationServiceChangeEvent(e.languageId))})))}register(languageId,configuration,priority){return this._registry.register(languageId,configuration,priority)}getLanguageConfiguration(languageId){let result=this.configurations.get(languageId);return result||(result=computeConfig(languageId,this._registry,this.configurationService,this.languageService),this.configurations.set(languageId,result)),result}};LanguageConfigurationService=__decorate([__param(0,IConfigurationService),__param(1,ILanguageService)],LanguageConfigurationService);export{LanguageConfigurationService};function computeConfig(languageId,registry,configurationService,languageService){let languageConfig=registry.getLanguageConfiguration(languageId);if(!languageConfig){if(!languageService.isRegisteredLanguageId(languageId))throw new Error(`Language id "${languageId}" is not configured nor known`);languageConfig=new ResolvedLanguageConfiguration(languageId,{})}const customizedConfig=getCustomizedLanguageConfig(languageConfig.languageId,configurationService),data=combineLanguageConfigurations([languageConfig.underlyingConfig,customizedConfig]);return new ResolvedLanguageConfiguration(languageConfig.languageId,data)}const customizedLanguageConfigKeys={brackets:"editor.language.brackets",colorizedBracketPairs:"editor.language.colorizedBracketPairs"};function getCustomizedLanguageConfig(languageId,configurationService){const brackets=configurationService.getValue(customizedLanguageConfigKeys.brackets,{overrideIdentifier:languageId}),colorizedBracketPairs=configurationService.getValue(customizedLanguageConfigKeys.colorizedBracketPairs,{overrideIdentifier:languageId});return{brackets:validateBracketPairs(brackets),colorizedBracketPairs:validateBracketPairs(colorizedBracketPairs)}}function validateBracketPairs(data){if(Array.isArray(data))return data.map((pair=>{if(Array.isArray(pair)&&2===pair.length)return[pair[0],pair[1]]})).filter((p=>!!p))}export function getIndentationAtPosition(model,lineNumber,column){const lineText=model.getLineContent(lineNumber);let indentation=strings.getLeadingWhitespace(lineText);return indentation.length>column-1&&(indentation=indentation.substring(0,column-1)),indentation}export function getScopedLineTokens(model,lineNumber,columnNumber){model.tokenization.forceTokenization(lineNumber);const lineTokens=model.tokenization.getLineTokens(lineNumber),column=void 0===columnNumber?model.getLineMaxColumn(lineNumber)-1:columnNumber-1;return createScopedLineTokens(lineTokens,column)}class ComposedLanguageConfiguration{constructor(languageId){this.languageId=languageId,this._resolved=null,this._entries=[],this._order=0,this._resolved=null}register(configuration,priority){const entry=new LanguageConfigurationContribution(configuration,priority,++this._order);return this._entries.push(entry),this._resolved=null,toDisposable((()=>{for(let i=0;i<this._entries.length;i++)if(this._entries[i]===entry){this._entries.splice(i,1),this._resolved=null;break}}))}getResolvedConfiguration(){if(!this._resolved){const config=this._resolve();config&&(this._resolved=new ResolvedLanguageConfiguration(this.languageId,config))}return this._resolved}_resolve(){return 0===this._entries.length?null:(this._entries.sort(LanguageConfigurationContribution.cmp),combineLanguageConfigurations(this._entries.map((e=>e.configuration))))}}function combineLanguageConfigurations(configs){let result={comments:void 0,brackets:void 0,wordPattern:void 0,indentationRules:void 0,onEnterRules:void 0,autoClosingPairs:void 0,surroundingPairs:void 0,autoCloseBefore:void 0,folding:void 0,colorizedBracketPairs:void 0,__electricCharacterSupport:void 0};for(const entry of configs)result={comments:entry.comments||result.comments,brackets:entry.brackets||result.brackets,wordPattern:entry.wordPattern||result.wordPattern,indentationRules:entry.indentationRules||result.indentationRules,onEnterRules:entry.onEnterRules||result.onEnterRules,autoClosingPairs:entry.autoClosingPairs||result.autoClosingPairs,surroundingPairs:entry.surroundingPairs||result.surroundingPairs,autoCloseBefore:entry.autoCloseBefore||result.autoCloseBefore,folding:entry.folding||result.folding,colorizedBracketPairs:entry.colorizedBracketPairs||result.colorizedBracketPairs,__electricCharacterSupport:entry.__electricCharacterSupport||result.__electricCharacterSupport};return result}class LanguageConfigurationContribution{constructor(configuration,priority,order){this.configuration=configuration,this.priority=priority,this.order=order}static cmp(a,b){return a.priority===b.priority?a.order-b.order:a.priority-b.priority}}export class LanguageConfigurationChangeEvent{constructor(languageId){this.languageId=languageId}}export class LanguageConfigurationRegistry extends Disposable{constructor(){super(),this._entries=new Map,this._onDidChange=this._register(new Emitter),this.onDidChange=this._onDidChange.event,this._register(this.register(PLAINTEXT_LANGUAGE_ID,{brackets:[["(",")"],["[","]"],["{","}"]],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:"<",close:">"},{open:'"',close:'"'},{open:"'",close:"'"},{open:"`",close:"`"}],colorizedBracketPairs:[],folding:{offSide:!0}},0))}register(languageId,configuration,priority=0){let entries=this._entries.get(languageId);entries||(entries=new ComposedLanguageConfiguration(languageId),this._entries.set(languageId,entries));const disposable=entries.register(configuration,priority);return this._onDidChange.fire(new LanguageConfigurationChangeEvent(languageId)),toDisposable((()=>{disposable.dispose(),this._onDidChange.fire(new LanguageConfigurationChangeEvent(languageId))}))}getLanguageConfiguration(languageId){const entries=this._entries.get(languageId);return(null==entries?void 0:entries.getResolvedConfiguration())||null}}export class ResolvedLanguageConfiguration{constructor(languageId,underlyingConfig){this.languageId=languageId,this.underlyingConfig=underlyingConfig,this._brackets=null,this._electricCharacter=null,this._onEnterSupport=this.underlyingConfig.brackets||this.underlyingConfig.indentationRules||this.underlyingConfig.onEnterRules?new OnEnterSupport(this.underlyingConfig):null,this.comments=ResolvedLanguageConfiguration._handleComments(this.underlyingConfig),this.characterPair=new CharacterPairSupport(this.underlyingConfig),this.wordDefinition=this.underlyingConfig.wordPattern||DEFAULT_WORD_REGEXP,this.indentationRules=this.underlyingConfig.indentationRules,this.underlyingConfig.indentationRules?this.indentRulesSupport=new IndentRulesSupport(this.underlyingConfig.indentationRules):this.indentRulesSupport=null,this.foldingRules=this.underlyingConfig.folding||{},this.bracketsNew=new LanguageBracketsConfiguration(languageId,this.underlyingConfig)}getWordDefinition(){return ensureValidWordDefinition(this.wordDefinition)}get brackets(){return!this._brackets&&this.underlyingConfig.brackets&&(this._brackets=new RichEditBrackets(this.languageId,this.underlyingConfig.brackets)),this._brackets}get electricCharacter(){return this._electricCharacter||(this._electricCharacter=new BracketElectricCharacterSupport(this.brackets)),this._electricCharacter}onEnter(autoIndent,previousLineText,beforeEnterText,afterEnterText){return this._onEnterSupport?this._onEnterSupport.onEnter(autoIndent,previousLineText,beforeEnterText,afterEnterText):null}getAutoClosingPairs(){return new AutoClosingPairs(this.characterPair.getAutoClosingPairs())}getAutoCloseBeforeSet(){return this.characterPair.getAutoCloseBeforeSet()}getSurroundingPairs(){return this.characterPair.getSurroundingPairs()}static _handleComments(conf){const commentRule=conf.comments;if(!commentRule)return null;const comments={};if(commentRule.lineComment&&(comments.lineCommentToken=commentRule.lineComment),commentRule.blockComment){const[blockStart,blockEnd]=commentRule.blockComment;comments.blockCommentStartToken=blockStart,comments.blockCommentEndToken=blockEnd}return comments}}registerSingleton(ILanguageConfigurationService,LanguageConfigurationService);