import*as strings from"../../../base/common/strings.js";import{createStringBuilder}from"../core/stringBuilder.js";import{LineDecoration,LineDecorationsNormalizer}from"./lineDecorations.js";import{LinePart}from"./linePart.js";export class LineRange{constructor(startIndex,endIndex){this.startOffset=startIndex,this.endOffset=endIndex}equals(otherLineRange){return this.startOffset===otherLineRange.startOffset&&this.endOffset===otherLineRange.endOffset}}export class RenderLineInput{constructor(useMonospaceOptimizations,canUseHalfwidthRightwardsArrow,lineContent,continuesWithWrappedLine,isBasicASCII,containsRTL,fauxIndentLength,lineTokens,lineDecorations,tabSize,startVisibleColumn,spaceWidth,middotWidth,wsmiddotWidth,stopRenderingLineAfter,renderWhitespace,renderControlCharacters,fontLigatures,selectionsOnLine){this.useMonospaceOptimizations=useMonospaceOptimizations,this.canUseHalfwidthRightwardsArrow=canUseHalfwidthRightwardsArrow,this.lineContent=lineContent,this.continuesWithWrappedLine=continuesWithWrappedLine,this.isBasicASCII=isBasicASCII,this.containsRTL=containsRTL,this.fauxIndentLength=fauxIndentLength,this.lineTokens=lineTokens,this.lineDecorations=lineDecorations.sort(LineDecoration.compare),this.tabSize=tabSize,this.startVisibleColumn=startVisibleColumn,this.spaceWidth=spaceWidth,this.stopRenderingLineAfter=stopRenderingLineAfter,this.renderWhitespace="all"===renderWhitespace?4:"boundary"===renderWhitespace?1:"selection"===renderWhitespace?2:"trailing"===renderWhitespace?3:0,this.renderControlCharacters=renderControlCharacters,this.fontLigatures=fontLigatures,this.selectionsOnLine=selectionsOnLine&&selectionsOnLine.sort(((a,b)=>a.startOffset<b.startOffset?-1:1));Math.abs(wsmiddotWidth-spaceWidth)<Math.abs(middotWidth-spaceWidth)?(this.renderSpaceWidth=wsmiddotWidth,this.renderSpaceCharCode=11825):(this.renderSpaceWidth=middotWidth,this.renderSpaceCharCode=183)}sameSelection(otherSelections){if(null===this.selectionsOnLine)return null===otherSelections;if(null===otherSelections)return!1;if(otherSelections.length!==this.selectionsOnLine.length)return!1;for(let i=0;i<this.selectionsOnLine.length;i++)if(!this.selectionsOnLine[i].equals(otherSelections[i]))return!1;return!0}equals(other){return this.useMonospaceOptimizations===other.useMonospaceOptimizations&&this.canUseHalfwidthRightwardsArrow===other.canUseHalfwidthRightwardsArrow&&this.lineContent===other.lineContent&&this.continuesWithWrappedLine===other.continuesWithWrappedLine&&this.isBasicASCII===other.isBasicASCII&&this.containsRTL===other.containsRTL&&this.fauxIndentLength===other.fauxIndentLength&&this.tabSize===other.tabSize&&this.startVisibleColumn===other.startVisibleColumn&&this.spaceWidth===other.spaceWidth&&this.renderSpaceWidth===other.renderSpaceWidth&&this.renderSpaceCharCode===other.renderSpaceCharCode&&this.stopRenderingLineAfter===other.stopRenderingLineAfter&&this.renderWhitespace===other.renderWhitespace&&this.renderControlCharacters===other.renderControlCharacters&&this.fontLigatures===other.fontLigatures&&LineDecoration.equalsArr(this.lineDecorations,other.lineDecorations)&&this.lineTokens.equals(other.lineTokens)&&this.sameSelection(other.selectionsOnLine)}}export class DomPosition{constructor(partIndex,charIndex){this.partIndex=partIndex,this.charIndex=charIndex}}export class CharacterMapping{constructor(length,partCount){this.length=length,this._data=new Uint32Array(this.length),this._horizontalOffset=new Uint32Array(this.length)}static getPartIndex(partData){return(4294901760&partData)>>>16}static getCharIndex(partData){return(65535&partData)>>>0}setColumnInfo(column,partIndex,charIndex,horizontalOffset){const partData=(partIndex<<16|charIndex<<0)>>>0;this._data[column-1]=partData,this._horizontalOffset[column-1]=horizontalOffset}getHorizontalOffset(column){return 0===this._horizontalOffset.length?0:this._horizontalOffset[column-1]}charOffsetToPartData(charOffset){return 0===this.length?0:charOffset<0?this._data[0]:charOffset>=this.length?this._data[this.length-1]:this._data[charOffset]}getDomPosition(column){const partData=this.charOffsetToPartData(column-1),partIndex=CharacterMapping.getPartIndex(partData),charIndex=CharacterMapping.getCharIndex(partData);return new DomPosition(partIndex,charIndex)}getColumn(domPosition,partLength){return this.partDataToCharOffset(domPosition.partIndex,partLength,domPosition.charIndex)+1}partDataToCharOffset(partIndex,partLength,charIndex){if(0===this.length)return 0;const searchEntry=(partIndex<<16|charIndex<<0)>>>0;let min=0,max=this.length-1;for(;min+1<max;){const mid=min+max>>>1,midEntry=this._data[mid];if(midEntry===searchEntry)return mid;midEntry>searchEntry?max=mid:min=mid}if(min===max)return min;const minEntry=this._data[min],maxEntry=this._data[max];if(minEntry===searchEntry)return min;if(maxEntry===searchEntry)return max;const minPartIndex=CharacterMapping.getPartIndex(minEntry),minCharIndex=CharacterMapping.getCharIndex(minEntry);let maxCharIndex;maxCharIndex=minPartIndex!==CharacterMapping.getPartIndex(maxEntry)?partLength:CharacterMapping.getCharIndex(maxEntry);return charIndex-minCharIndex<=maxCharIndex-charIndex?min:max}}export class RenderLineOutput{constructor(characterMapping,containsRTL,containsForeignElements){this._renderLineOutputBrand=void 0,this.characterMapping=characterMapping,this.containsRTL=containsRTL,this.containsForeignElements=containsForeignElements}}export function renderViewLine(input,sb){if(0===input.lineContent.length){if(input.lineDecorations.length>0){sb.appendASCIIString("<span>");let beforeCount=0,afterCount=0,containsForeignElements=0;for(const lineDecoration of input.lineDecorations)1!==lineDecoration.type&&2!==lineDecoration.type||(sb.appendASCIIString('<span class="'),sb.appendASCIIString(lineDecoration.className),sb.appendASCIIString('"></span>'),1===lineDecoration.type&&(containsForeignElements|=1,beforeCount++),2===lineDecoration.type&&(containsForeignElements|=2,afterCount++));sb.appendASCIIString("</span>");const characterMapping=new CharacterMapping(1,beforeCount+afterCount);return characterMapping.setColumnInfo(1,beforeCount,0,0),new RenderLineOutput(characterMapping,!1,containsForeignElements)}return sb.appendASCIIString("<span><span></span></span>"),new RenderLineOutput(new CharacterMapping(0,0),!1,0)}return _renderLine(resolveRenderLineInput(input),sb)}export class RenderLineOutput2{constructor(characterMapping,html,containsRTL,containsForeignElements){this.characterMapping=characterMapping,this.html=html,this.containsRTL=containsRTL,this.containsForeignElements=containsForeignElements}}export function renderViewLine2(input){const sb=createStringBuilder(1e4),out=renderViewLine(input,sb);return new RenderLineOutput2(out.characterMapping,sb.build(),out.containsRTL,out.containsForeignElements)}class ResolvedRenderLineInput{constructor(fontIsMonospace,canUseHalfwidthRightwardsArrow,lineContent,len,isOverflowing,parts,containsForeignElements,fauxIndentLength,tabSize,startVisibleColumn,containsRTL,spaceWidth,renderSpaceCharCode,renderWhitespace,renderControlCharacters){this.fontIsMonospace=fontIsMonospace,this.canUseHalfwidthRightwardsArrow=canUseHalfwidthRightwardsArrow,this.lineContent=lineContent,this.len=len,this.isOverflowing=isOverflowing,this.parts=parts,this.containsForeignElements=containsForeignElements,this.fauxIndentLength=fauxIndentLength,this.tabSize=tabSize,this.startVisibleColumn=startVisibleColumn,this.containsRTL=containsRTL,this.spaceWidth=spaceWidth,this.renderSpaceCharCode=renderSpaceCharCode,this.renderWhitespace=renderWhitespace,this.renderControlCharacters=renderControlCharacters}}function resolveRenderLineInput(input){const lineContent=input.lineContent;let isOverflowing,len;-1!==input.stopRenderingLineAfter&&input.stopRenderingLineAfter<lineContent.length?(isOverflowing=!0,len=input.stopRenderingLineAfter):(isOverflowing=!1,len=lineContent.length);let tokens=transformAndRemoveOverflowing(lineContent,input.containsRTL,input.lineTokens,input.fauxIndentLength,len);input.renderControlCharacters&&!input.isBasicASCII&&(tokens=extractControlCharacters(lineContent,tokens)),(4===input.renderWhitespace||1===input.renderWhitespace||2===input.renderWhitespace&&input.selectionsOnLine||3===input.renderWhitespace)&&(tokens=_applyRenderWhitespace(input,lineContent,len,tokens));let containsForeignElements=0;if(input.lineDecorations.length>0){for(let i=0,len=input.lineDecorations.length;i<len;i++){const lineDecoration=input.lineDecorations[i];3===lineDecoration.type||1===lineDecoration.type?containsForeignElements|=1:2===lineDecoration.type&&(containsForeignElements|=2)}tokens=_applyInlineDecorations(lineContent,len,tokens,input.lineDecorations)}return input.containsRTL||(tokens=splitLargeTokens(lineContent,tokens,!input.isBasicASCII||input.fontLigatures)),new ResolvedRenderLineInput(input.useMonospaceOptimizations,input.canUseHalfwidthRightwardsArrow,lineContent,len,isOverflowing,tokens,containsForeignElements,input.fauxIndentLength,input.tabSize,input.startVisibleColumn,input.containsRTL,input.spaceWidth,input.renderSpaceCharCode,input.renderWhitespace,input.renderControlCharacters)}function transformAndRemoveOverflowing(lineContent,lineContainsRTL,tokens,fauxIndentLength,len){const result=[];let resultLen=0;fauxIndentLength>0&&(result[resultLen++]=new LinePart(fauxIndentLength,"",0,!1));let startOffset=fauxIndentLength;for(let tokenIndex=0,tokensLen=tokens.getCount();tokenIndex<tokensLen;tokenIndex++){const endIndex=tokens.getEndOffset(tokenIndex);if(endIndex<=fauxIndentLength)continue;const type=tokens.getClassName(tokenIndex);if(endIndex>=len){const tokenContainsRTL=!!lineContainsRTL&&strings.containsRTL(lineContent.substring(startOffset,len));result[resultLen++]=new LinePart(len,type,0,tokenContainsRTL);break}const tokenContainsRTL=!!lineContainsRTL&&strings.containsRTL(lineContent.substring(startOffset,endIndex));result[resultLen++]=new LinePart(endIndex,type,0,tokenContainsRTL),startOffset=endIndex}return result}function splitLargeTokens(lineContent,tokens,onlyAtSpaces){let lastTokenEndIndex=0;const result=[];let resultLen=0;if(onlyAtSpaces)for(let i=0,len=tokens.length;i<len;i++){const token=tokens[i],tokenEndIndex=token.endIndex;if(lastTokenEndIndex+50<tokenEndIndex){const tokenType=token.type,tokenMetadata=token.metadata,tokenContainsRTL=token.containsRTL;let lastSpaceOffset=-1,currTokenStart=lastTokenEndIndex;for(let j=lastTokenEndIndex;j<tokenEndIndex;j++)32===lineContent.charCodeAt(j)&&(lastSpaceOffset=j),-1!==lastSpaceOffset&&j-currTokenStart>=50&&(result[resultLen++]=new LinePart(lastSpaceOffset+1,tokenType,tokenMetadata,tokenContainsRTL),currTokenStart=lastSpaceOffset+1,lastSpaceOffset=-1);currTokenStart!==tokenEndIndex&&(result[resultLen++]=new LinePart(tokenEndIndex,tokenType,tokenMetadata,tokenContainsRTL))}else result[resultLen++]=token;lastTokenEndIndex=tokenEndIndex}else for(let i=0,len=tokens.length;i<len;i++){const token=tokens[i],tokenEndIndex=token.endIndex,diff=tokenEndIndex-lastTokenEndIndex;if(diff>50){const tokenType=token.type,tokenMetadata=token.metadata,tokenContainsRTL=token.containsRTL,piecesCount=Math.ceil(diff/50);for(let j=1;j<piecesCount;j++){const pieceEndIndex=lastTokenEndIndex+50*j;result[resultLen++]=new LinePart(pieceEndIndex,tokenType,tokenMetadata,tokenContainsRTL)}result[resultLen++]=new LinePart(tokenEndIndex,tokenType,tokenMetadata,tokenContainsRTL)}else result[resultLen++]=token;lastTokenEndIndex=tokenEndIndex}return result}function isControlCharacter(charCode){return charCode<32?9!==charCode:127===charCode||(charCode>=8234&&charCode<=8238||charCode>=8294&&charCode<=8297||charCode>=8206&&charCode<=8207||1564===charCode)}function extractControlCharacters(lineContent,tokens){const result=[];let lastLinePart=new LinePart(0,"",0,!1),charOffset=0;for(const token of tokens){const tokenEndIndex=token.endIndex;for(;charOffset<tokenEndIndex;charOffset++){isControlCharacter(lineContent.charCodeAt(charOffset))&&(charOffset>lastLinePart.endIndex&&(lastLinePart=new LinePart(charOffset,token.type,token.metadata,token.containsRTL),result.push(lastLinePart)),lastLinePart=new LinePart(charOffset+1,"mtkcontrol",token.metadata,!1),result.push(lastLinePart))}charOffset>lastLinePart.endIndex&&(lastLinePart=new LinePart(tokenEndIndex,token.type,token.metadata,token.containsRTL),result.push(lastLinePart))}return result}function _applyRenderWhitespace(input,lineContent,len,tokens){const continuesWithWrappedLine=input.continuesWithWrappedLine,fauxIndentLength=input.fauxIndentLength,tabSize=input.tabSize,startVisibleColumn=input.startVisibleColumn,useMonospaceOptimizations=input.useMonospaceOptimizations,selections=input.selectionsOnLine,onlyBoundary=1===input.renderWhitespace,onlyTrailing=3===input.renderWhitespace,generateLinePartForEachWhitespace=input.renderSpaceWidth!==input.spaceWidth,result=[];let resultLen=0,tokenIndex=0,tokenType=tokens[tokenIndex].type,tokenContainsRTL=tokens[tokenIndex].containsRTL,tokenEndIndex=tokens[tokenIndex].endIndex;const tokensLength=tokens.length;let lastNonWhitespaceIndex,lineIsEmptyOrWhitespace=!1,firstNonWhitespaceIndex=strings.firstNonWhitespaceIndex(lineContent);-1===firstNonWhitespaceIndex?(lineIsEmptyOrWhitespace=!0,firstNonWhitespaceIndex=len,lastNonWhitespaceIndex=len):lastNonWhitespaceIndex=strings.lastNonWhitespaceIndex(lineContent);let wasInWhitespace=!1,currentSelectionIndex=0,currentSelection=selections&&selections[currentSelectionIndex],tmpIndent=startVisibleColumn%tabSize;for(let charIndex=fauxIndentLength;charIndex<len;charIndex++){const chCode=lineContent.charCodeAt(charIndex);let isInWhitespace;if(currentSelection&&charIndex>=currentSelection.endOffset&&(currentSelectionIndex++,currentSelection=selections&&selections[currentSelectionIndex]),charIndex<firstNonWhitespaceIndex||charIndex>lastNonWhitespaceIndex)isInWhitespace=!0;else if(9===chCode)isInWhitespace=!0;else if(32===chCode)if(onlyBoundary)if(wasInWhitespace)isInWhitespace=!0;else{const nextChCode=charIndex+1<len?lineContent.charCodeAt(charIndex+1):0;isInWhitespace=32===nextChCode||9===nextChCode}else isInWhitespace=!0;else isInWhitespace=!1;if(isInWhitespace&&selections&&(isInWhitespace=!!currentSelection&&currentSelection.startOffset<=charIndex&&currentSelection.endOffset>charIndex),isInWhitespace&&onlyTrailing&&(isInWhitespace=lineIsEmptyOrWhitespace||charIndex>lastNonWhitespaceIndex),isInWhitespace&&tokenContainsRTL&&charIndex>=firstNonWhitespaceIndex&&charIndex<=lastNonWhitespaceIndex&&(isInWhitespace=!1),wasInWhitespace){if(!isInWhitespace||!useMonospaceOptimizations&&tmpIndent>=tabSize){if(generateLinePartForEachWhitespace){for(let i=(resultLen>0?result[resultLen-1].endIndex:fauxIndentLength)+1;i<=charIndex;i++)result[resultLen++]=new LinePart(i,"mtkw",1,!1)}else result[resultLen++]=new LinePart(charIndex,"mtkw",1,!1);tmpIndent%=tabSize}}else(charIndex===tokenEndIndex||isInWhitespace&&charIndex>fauxIndentLength)&&(result[resultLen++]=new LinePart(charIndex,tokenType,0,tokenContainsRTL),tmpIndent%=tabSize);for(9===chCode?tmpIndent=tabSize:strings.isFullWidthCharacter(chCode)?tmpIndent+=2:tmpIndent++,wasInWhitespace=isInWhitespace;charIndex===tokenEndIndex&&(tokenIndex++,tokenIndex<tokensLength);)tokenType=tokens[tokenIndex].type,tokenContainsRTL=tokens[tokenIndex].containsRTL,tokenEndIndex=tokens[tokenIndex].endIndex}let generateWhitespace=!1;if(wasInWhitespace)if(continuesWithWrappedLine&&onlyBoundary){const lastCharCode=len>0?lineContent.charCodeAt(len-1):0,prevCharCode=len>1?lineContent.charCodeAt(len-2):0;32===lastCharCode&&32!==prevCharCode&&9!==prevCharCode||(generateWhitespace=!0)}else generateWhitespace=!0;if(generateWhitespace)if(generateLinePartForEachWhitespace){for(let i=(resultLen>0?result[resultLen-1].endIndex:fauxIndentLength)+1;i<=len;i++)result[resultLen++]=new LinePart(i,"mtkw",1,!1)}else result[resultLen++]=new LinePart(len,"mtkw",1,!1);else result[resultLen++]=new LinePart(len,tokenType,0,tokenContainsRTL);return result}function _applyInlineDecorations(lineContent,len,tokens,_lineDecorations){_lineDecorations.sort(LineDecoration.compare);const lineDecorations=LineDecorationsNormalizer.normalize(lineContent,_lineDecorations),lineDecorationsLen=lineDecorations.length;let lineDecorationIndex=0;const result=[];let resultLen=0,lastResultEndIndex=0;for(let tokenIndex=0,len=tokens.length;tokenIndex<len;tokenIndex++){const token=tokens[tokenIndex],tokenEndIndex=token.endIndex,tokenType=token.type,tokenMetadata=token.metadata,tokenContainsRTL=token.containsRTL;for(;lineDecorationIndex<lineDecorationsLen&&lineDecorations[lineDecorationIndex].startOffset<tokenEndIndex;){const lineDecoration=lineDecorations[lineDecorationIndex];if(lineDecoration.startOffset>lastResultEndIndex&&(lastResultEndIndex=lineDecoration.startOffset,result[resultLen++]=new LinePart(lastResultEndIndex,tokenType,tokenMetadata,tokenContainsRTL)),!(lineDecoration.endOffset+1<=tokenEndIndex)){lastResultEndIndex=tokenEndIndex,result[resultLen++]=new LinePart(lastResultEndIndex,tokenType+" "+lineDecoration.className,tokenMetadata|lineDecoration.metadata,tokenContainsRTL);break}lastResultEndIndex=lineDecoration.endOffset+1,result[resultLen++]=new LinePart(lastResultEndIndex,tokenType+" "+lineDecoration.className,tokenMetadata|lineDecoration.metadata,tokenContainsRTL),lineDecorationIndex++}tokenEndIndex>lastResultEndIndex&&(lastResultEndIndex=tokenEndIndex,result[resultLen++]=new LinePart(lastResultEndIndex,tokenType,tokenMetadata,tokenContainsRTL))}const lastTokenEndIndex=tokens[tokens.length-1].endIndex;if(lineDecorationIndex<lineDecorationsLen&&lineDecorations[lineDecorationIndex].startOffset===lastTokenEndIndex)for(;lineDecorationIndex<lineDecorationsLen&&lineDecorations[lineDecorationIndex].startOffset===lastTokenEndIndex;){const lineDecoration=lineDecorations[lineDecorationIndex];result[resultLen++]=new LinePart(lastResultEndIndex,lineDecoration.className,lineDecoration.metadata,!1),lineDecorationIndex++}return result}function _renderLine(input,sb){const fontIsMonospace=input.fontIsMonospace,canUseHalfwidthRightwardsArrow=input.canUseHalfwidthRightwardsArrow,containsForeignElements=input.containsForeignElements,lineContent=input.lineContent,len=input.len,isOverflowing=input.isOverflowing,parts=input.parts,fauxIndentLength=input.fauxIndentLength,tabSize=input.tabSize,startVisibleColumn=input.startVisibleColumn,containsRTL=input.containsRTL,spaceWidth=input.spaceWidth,renderSpaceCharCode=input.renderSpaceCharCode,renderWhitespace=input.renderWhitespace,renderControlCharacters=input.renderControlCharacters,characterMapping=new CharacterMapping(len+1,parts.length);let lastCharacterMappingDefined=!1,charIndex=0,visibleColumn=startVisibleColumn,charOffsetInPart=0,charHorizontalOffset=0,partDisplacement=0;containsRTL?sb.appendASCIIString('<span dir="ltr">'):sb.appendASCIIString("<span>");for(let partIndex=0,tokensLen=parts.length;partIndex<tokensLen;partIndex++){const part=parts[partIndex],partEndIndex=part.endIndex,partType=part.type,partContainsRTL=part.containsRTL,partRendersWhitespace=0!==renderWhitespace&&part.isWhitespace(),partRendersWhitespaceWithWidth=partRendersWhitespace&&!fontIsMonospace&&("mtkw"===partType||!containsForeignElements),partIsEmptyAndHasPseudoAfter=charIndex===partEndIndex&&part.isPseudoAfter();if(charOffsetInPart=0,sb.appendASCIIString("<span "),partContainsRTL&&sb.appendASCIIString('style="unicode-bidi:isolate" '),sb.appendASCIIString('class="'),sb.appendASCIIString(partRendersWhitespaceWithWidth?"mtkz":partType),sb.appendASCII(34),partRendersWhitespace){let partWidth=0;{let _charIndex=charIndex,_visibleColumn=visibleColumn;for(;_charIndex<partEndIndex;_charIndex++){const charWidth=0|(9===lineContent.charCodeAt(_charIndex)?tabSize-_visibleColumn%tabSize:1);partWidth+=charWidth,_charIndex>=fauxIndentLength&&(_visibleColumn+=charWidth)}}for(partRendersWhitespaceWithWidth&&(sb.appendASCIIString(' style="width:'),sb.appendASCIIString(String(spaceWidth*partWidth)),sb.appendASCIIString('px"')),sb.appendASCII(62);charIndex<partEndIndex;charIndex++){characterMapping.setColumnInfo(charIndex+1,partIndex-partDisplacement,charOffsetInPart,charHorizontalOffset),partDisplacement=0;let producedCharacters,charWidth;if(9===lineContent.charCodeAt(charIndex)){producedCharacters=tabSize-visibleColumn%tabSize|0,charWidth=producedCharacters,!canUseHalfwidthRightwardsArrow||charWidth>1?sb.write1(8594):sb.write1(65515);for(let space=2;space<=charWidth;space++)sb.write1(160)}else producedCharacters=2,charWidth=1,sb.write1(renderSpaceCharCode),sb.write1(8204);charOffsetInPart+=producedCharacters,charHorizontalOffset+=charWidth,charIndex>=fauxIndentLength&&(visibleColumn+=charWidth)}}else for(sb.appendASCII(62);charIndex<partEndIndex;charIndex++){characterMapping.setColumnInfo(charIndex+1,partIndex-partDisplacement,charOffsetInPart,charHorizontalOffset),partDisplacement=0;const charCode=lineContent.charCodeAt(charIndex);let producedCharacters=1,charWidth=1;switch(charCode){case 9:producedCharacters=tabSize-visibleColumn%tabSize,charWidth=producedCharacters;for(let space=1;space<=producedCharacters;space++)sb.write1(160);break;case 32:sb.write1(160);break;case 60:sb.appendASCIIString("&lt;");break;case 62:sb.appendASCIIString("&gt;");break;case 38:sb.appendASCIIString("&amp;");break;case 0:renderControlCharacters?sb.write1(9216):sb.appendASCIIString("&#00;");break;case 65279:case 8232:case 8233:case 133:sb.write1(65533);break;default:strings.isFullWidthCharacter(charCode)&&charWidth++,renderControlCharacters&&charCode<32?sb.write1(9216+charCode):renderControlCharacters&&127===charCode?sb.write1(9249):renderControlCharacters&&isControlCharacter(charCode)?(sb.appendASCIIString("[U+"),sb.appendASCIIString(to4CharHex(charCode)),sb.appendASCIIString("]"),producedCharacters=8,charWidth=producedCharacters):sb.write1(charCode)}charOffsetInPart+=producedCharacters,charHorizontalOffset+=charWidth,charIndex>=fauxIndentLength&&(visibleColumn+=charWidth)}partIsEmptyAndHasPseudoAfter?partDisplacement++:partDisplacement=0,charIndex>=len&&!lastCharacterMappingDefined&&part.isPseudoAfter()&&(lastCharacterMappingDefined=!0,characterMapping.setColumnInfo(charIndex+1,partIndex,charOffsetInPart,charHorizontalOffset)),sb.appendASCIIString("</span>")}return lastCharacterMappingDefined||characterMapping.setColumnInfo(len+1,parts.length-1,charOffsetInPart,charHorizontalOffset),isOverflowing&&sb.appendASCIIString("<span>&hellip;</span>"),sb.appendASCIIString("</span>"),new RenderLineOutput(characterMapping,containsRTL,containsForeignElements)}function to4CharHex(n){return n.toString(16).toUpperCase().padStart(4,"0")}