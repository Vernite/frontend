var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import*as strings from"../../../base/common/strings.js";import{CursorColumns}from"../core/cursorColumns.js";import{Range}from"../core/range.js";import{Selection}from"../core/selection.js";import{getEnterAction}from"../languages/enterAction.js";import{ILanguageConfigurationService}from"../languages/languageConfigurationRegistry.js";const repeatCache=Object.create(null);export function cachedStringRepeat(str,count){if(count<=0)return"";repeatCache[str]||(repeatCache[str]=["",str]);const cache=repeatCache[str];for(let i=cache.length;i<=count;i++)cache[i]=cache[i-1]+str;return cache[count]}let ShiftCommand=class ShiftCommand{constructor(range,opts,_languageConfigurationService){this._languageConfigurationService=_languageConfigurationService,this._opts=opts,this._selection=range,this._selectionId=null,this._useLastEditRangeForCursorEndPosition=!1,this._selectionStartColumnStaysPut=!1}static unshiftIndent(line,column,tabSize,indentSize,insertSpaces){const contentStartVisibleColumn=CursorColumns.visibleColumnFromColumn(line,column,tabSize);if(insertSpaces){const indent=cachedStringRepeat(" ",indentSize);return cachedStringRepeat(indent,CursorColumns.prevIndentTabStop(contentStartVisibleColumn,indentSize)/indentSize)}return cachedStringRepeat("\t",CursorColumns.prevRenderTabStop(contentStartVisibleColumn,tabSize)/tabSize)}static shiftIndent(line,column,tabSize,indentSize,insertSpaces){const contentStartVisibleColumn=CursorColumns.visibleColumnFromColumn(line,column,tabSize);if(insertSpaces){const indent=cachedStringRepeat(" ",indentSize);return cachedStringRepeat(indent,CursorColumns.nextIndentTabStop(contentStartVisibleColumn,indentSize)/indentSize)}return cachedStringRepeat("\t",CursorColumns.nextRenderTabStop(contentStartVisibleColumn,tabSize)/tabSize)}_addEditOperation(builder,range,text){this._useLastEditRangeForCursorEndPosition?builder.addTrackedEditOperation(range,text):builder.addEditOperation(range,text)}getEditOperations(model,builder){const startLine=this._selection.startLineNumber;let endLine=this._selection.endLineNumber;1===this._selection.endColumn&&startLine!==endLine&&(endLine-=1);const{tabSize,indentSize,insertSpaces}=this._opts,shouldIndentEmptyLines=startLine===endLine;if(this._opts.useTabStops){this._selection.isEmpty()&&/^\s*$/.test(model.getLineContent(startLine))&&(this._useLastEditRangeForCursorEndPosition=!0);let previousLineExtraSpaces=0,extraSpaces=0;for(let lineNumber=startLine;lineNumber<=endLine;lineNumber++,previousLineExtraSpaces=extraSpaces){extraSpaces=0;const lineText=model.getLineContent(lineNumber);let desiredIndent,indentationEndIndex=strings.firstNonWhitespaceIndex(lineText);if((!this._opts.isUnshift||0!==lineText.length&&0!==indentationEndIndex)&&(shouldIndentEmptyLines||this._opts.isUnshift||0!==lineText.length)){if(-1===indentationEndIndex&&(indentationEndIndex=lineText.length),lineNumber>1){if(CursorColumns.visibleColumnFromColumn(lineText,indentationEndIndex+1,tabSize)%indentSize!=0&&model.tokenization.isCheapToTokenize(lineNumber-1)){const enterAction=getEnterAction(this._opts.autoIndent,model,new Range(lineNumber-1,model.getLineMaxColumn(lineNumber-1),lineNumber-1,model.getLineMaxColumn(lineNumber-1)),this._languageConfigurationService);if(enterAction){if(extraSpaces=previousLineExtraSpaces,enterAction.appendText)for(let j=0,lenJ=enterAction.appendText.length;j<lenJ&&extraSpaces<indentSize&&32===enterAction.appendText.charCodeAt(j);j++)extraSpaces++;enterAction.removeText&&(extraSpaces=Math.max(0,extraSpaces-enterAction.removeText));for(let j=0;j<extraSpaces&&(0!==indentationEndIndex&&32===lineText.charCodeAt(indentationEndIndex-1));j++)indentationEndIndex--}}}this._opts.isUnshift&&0===indentationEndIndex||(desiredIndent=this._opts.isUnshift?ShiftCommand.unshiftIndent(lineText,indentationEndIndex+1,tabSize,indentSize,insertSpaces):ShiftCommand.shiftIndent(lineText,indentationEndIndex+1,tabSize,indentSize,insertSpaces),this._addEditOperation(builder,new Range(lineNumber,1,lineNumber,indentationEndIndex+1),desiredIndent),lineNumber!==startLine||this._selection.isEmpty()||(this._selectionStartColumnStaysPut=this._selection.startColumn<=indentationEndIndex+1))}}}else{!this._opts.isUnshift&&this._selection.isEmpty()&&0===model.getLineLength(startLine)&&(this._useLastEditRangeForCursorEndPosition=!0);const oneIndent=insertSpaces?cachedStringRepeat(" ",indentSize):"\t";for(let lineNumber=startLine;lineNumber<=endLine;lineNumber++){const lineText=model.getLineContent(lineNumber);let indentationEndIndex=strings.firstNonWhitespaceIndex(lineText);if((!this._opts.isUnshift||0!==lineText.length&&0!==indentationEndIndex)&&((shouldIndentEmptyLines||this._opts.isUnshift||0!==lineText.length)&&(-1===indentationEndIndex&&(indentationEndIndex=lineText.length),!this._opts.isUnshift||0!==indentationEndIndex)))if(this._opts.isUnshift){indentationEndIndex=Math.min(indentationEndIndex,indentSize);for(let i=0;i<indentationEndIndex;i++){if(9===lineText.charCodeAt(i)){indentationEndIndex=i+1;break}}this._addEditOperation(builder,new Range(lineNumber,1,lineNumber,indentationEndIndex+1),"")}else this._addEditOperation(builder,new Range(lineNumber,1,lineNumber,1),oneIndent),lineNumber!==startLine||this._selection.isEmpty()||(this._selectionStartColumnStaysPut=1===this._selection.startColumn)}}this._selectionId=builder.trackSelection(this._selection)}computeCursorState(model,helper){if(this._useLastEditRangeForCursorEndPosition){const lastOp=helper.getInverseEditOperations()[0];return new Selection(lastOp.range.endLineNumber,lastOp.range.endColumn,lastOp.range.endLineNumber,lastOp.range.endColumn)}const result=helper.getTrackedSelection(this._selectionId);if(this._selectionStartColumnStaysPut){const initialStartColumn=this._selection.startColumn;return result.startColumn<=initialStartColumn?result:0===result.getDirection()?new Selection(result.startLineNumber,initialStartColumn,result.endLineNumber,result.endColumn):new Selection(result.endLineNumber,result.endColumn,result.startLineNumber,initialStartColumn)}return result}};ShiftCommand=__decorate([__param(2,ILanguageConfigurationService)],ShiftCommand);export{ShiftCommand};