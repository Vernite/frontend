var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{onUnexpectedError}from"../../../../base/common/errors.js";import{Emitter}from"../../../../base/common/event.js";import{defaultGenerator}from"../../../../base/common/idGenerator.js";import{dispose}from"../../../../base/common/lifecycle.js";import{ResourceMap}from"../../../../base/common/map.js";import{basename,extUri}from"../../../../base/common/resources.js";import*as strings from"../../../../base/common/strings.js";import{Range}from"../../../common/core/range.js";import{localize}from"../../../../nls.js";export class OneReference{constructor(isProviderFirst,parent,link,_rangeCallback){this.isProviderFirst=isProviderFirst,this.parent=parent,this.link=link,this._rangeCallback=_rangeCallback,this.id=defaultGenerator.nextId()}get uri(){return this.link.uri}get range(){var _a,_b;return null!==(_b=null!==(_a=this._range)&&void 0!==_a?_a:this.link.targetSelectionRange)&&void 0!==_b?_b:this.link.range}set range(value){this._range=value,this._rangeCallback(this)}get ariaMessage(){var _a;const preview=null===(_a=this.parent.getPreview(this))||void 0===_a?void 0:_a.preview(this.range);return preview?localize({key:"aria.oneReference.preview",comment:["Placeholders are: 0: filename, 1:line number, 2: column number, 3: preview snippet of source code"]},"symbol in {0} on line {1} at column {2}, {3}",basename(this.uri),this.range.startLineNumber,this.range.startColumn,preview.value):localize("aria.oneReference","symbol in {0} on line {1} at column {2}",basename(this.uri),this.range.startLineNumber,this.range.startColumn)}}export class FilePreview{constructor(_modelReference){this._modelReference=_modelReference}dispose(){this._modelReference.dispose()}preview(range,n=8){const model=this._modelReference.object.textEditorModel;if(!model)return;const{startLineNumber,startColumn,endLineNumber,endColumn}=range,word=model.getWordUntilPosition({lineNumber:startLineNumber,column:startColumn-n}),beforeRange=new Range(startLineNumber,word.startColumn,startLineNumber,startColumn),afterRange=new Range(endLineNumber,endColumn,endLineNumber,1073741824),before=model.getValueInRange(beforeRange).replace(/^\s+/,""),inside=model.getValueInRange(range);return{value:before+inside+model.getValueInRange(afterRange).replace(/\s+$/,""),highlight:{start:before.length,end:before.length+inside.length}}}}export class FileReferences{constructor(parent,uri){this.parent=parent,this.uri=uri,this.children=[],this._previews=new ResourceMap}dispose(){dispose(this._previews.values()),this._previews.clear()}getPreview(child){return this._previews.get(child.uri)}get ariaMessage(){const len=this.children.length;return 1===len?localize("aria.fileReferences.1","1 symbol in {0}, full path {1}",basename(this.uri),this.uri.fsPath):localize("aria.fileReferences.N","{0} symbols in {1}, full path {2}",len,basename(this.uri),this.uri.fsPath)}resolve(textModelResolverService){return __awaiter(this,void 0,void 0,(function*(){if(0!==this._previews.size)return this;for(const child of this.children)if(!this._previews.has(child.uri))try{const ref=yield textModelResolverService.createModelReference(child.uri);this._previews.set(child.uri,new FilePreview(ref))}catch(err){onUnexpectedError(err)}return this}))}}export class ReferencesModel{constructor(links,title){this.groups=[],this.references=[],this._onDidChangeReferenceRange=new Emitter,this.onDidChangeReferenceRange=this._onDidChangeReferenceRange.event,this._links=links,this._title=title;const[providersFirst]=links;let current;links.sort(ReferencesModel._compareReferences);for(const link of links)if(current&&extUri.isEqual(current.uri,link.uri,!0)||(current=new FileReferences(this,link.uri),this.groups.push(current)),0===current.children.length||0!==ReferencesModel._compareReferences(link,current.children[current.children.length-1])){const oneRef=new OneReference(providersFirst===link,current,link,(ref=>this._onDidChangeReferenceRange.fire(ref)));this.references.push(oneRef),current.children.push(oneRef)}}dispose(){dispose(this.groups),this._onDidChangeReferenceRange.dispose(),this.groups.length=0}clone(){return new ReferencesModel(this._links,this._title)}get title(){return this._title}get isEmpty(){return 0===this.groups.length}get ariaMessage(){return this.isEmpty?localize("aria.result.0","No results found"):1===this.references.length?localize("aria.result.1","Found 1 symbol in {0}",this.references[0].uri.fsPath):1===this.groups.length?localize("aria.result.n1","Found {0} symbols in {1}",this.references.length,this.groups[0].uri.fsPath):localize("aria.result.nm","Found {0} symbols in {1} files",this.references.length,this.groups.length)}nextOrPreviousReference(reference,next){const{parent}=reference;let idx=parent.children.indexOf(reference);const childCount=parent.children.length,groupCount=parent.parent.groups.length;return 1===groupCount||next&&idx+1<childCount||!next&&idx>0?(idx=next?(idx+1)%childCount:(idx+childCount-1)%childCount,parent.children[idx]):(idx=parent.parent.groups.indexOf(parent),next?(idx=(idx+1)%groupCount,parent.parent.groups[idx].children[0]):(idx=(idx+groupCount-1)%groupCount,parent.parent.groups[idx].children[parent.parent.groups[idx].children.length-1]))}nearestReference(resource,position){const nearest=this.references.map(((ref,idx)=>({idx,prefixLen:strings.commonPrefixLength(ref.uri.toString(),resource.toString()),offsetDist:100*Math.abs(ref.range.startLineNumber-position.lineNumber)+Math.abs(ref.range.startColumn-position.column)}))).sort(((a,b)=>a.prefixLen>b.prefixLen?-1:a.prefixLen<b.prefixLen?1:a.offsetDist<b.offsetDist?-1:a.offsetDist>b.offsetDist?1:0))[0];if(nearest)return this.references[nearest.idx]}referenceAt(resource,position){for(const ref of this.references)if(ref.uri.toString()===resource.toString()&&Range.containsPosition(ref.range,position))return ref}firstReference(){for(const ref of this.references)if(ref.isProviderFirst)return ref;return this.references[0]}static _compareReferences(a,b){return extUri.compare(a.uri,b.uri)||Range.compareRangesUsingStarts(a.range,b.range)}}