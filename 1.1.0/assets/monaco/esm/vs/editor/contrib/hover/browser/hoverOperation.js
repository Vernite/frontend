var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__asyncValues=this&&this.__asyncValues||function(o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,m=o[Symbol.asyncIterator];return m?m.call(o):(o="function"==typeof __values?__values(o):o[Symbol.iterator](),i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i);function verb(n){i[n]=o[n]&&function(v){return new Promise((function(resolve,reject){(function settle(resolve,reject,d,v){Promise.resolve(v).then((function(v){resolve({value:v,done:d})}),reject)})(resolve,reject,(v=o[n](v)).done,v.value)}))}}};import{createCancelableAsyncIterable,RunOnceScheduler}from"../../../../base/common/async.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Emitter}from"../../../../base/common/event.js";import{Disposable}from"../../../../base/common/lifecycle.js";export class HoverResult{constructor(value,isComplete,hasLoadingMessage){this.value=value,this.isComplete=isComplete,this.hasLoadingMessage=hasLoadingMessage}}export class HoverOperation extends Disposable{constructor(_editor,_computer){super(),this._editor=_editor,this._computer=_computer,this._onResult=this._register(new Emitter),this.onResult=this._onResult.event,this._firstWaitScheduler=this._register(new RunOnceScheduler((()=>this._triggerAsyncComputation()),0)),this._secondWaitScheduler=this._register(new RunOnceScheduler((()=>this._triggerSyncComputation()),0)),this._loadingMessageScheduler=this._register(new RunOnceScheduler((()=>this._triggerLoadingMessage()),0)),this._state=0,this._asyncIterable=null,this._asyncIterableDone=!1,this._result=[]}dispose(){this._asyncIterable&&(this._asyncIterable.cancel(),this._asyncIterable=null),super.dispose()}get _hoverTime(){return this._editor.getOption(55).delay}get _firstWaitTime(){return this._hoverTime/2}get _secondWaitTime(){return this._hoverTime-this._firstWaitTime}get _loadingMessageTime(){return 3*this._hoverTime}_setState(state,fireResult=!0){this._state=state,fireResult&&this._fireResult()}_triggerAsyncComputation(){this._setState(2),this._secondWaitScheduler.schedule(this._secondWaitTime),this._computer.computeAsync?(this._asyncIterableDone=!1,this._asyncIterable=createCancelableAsyncIterable((token=>this._computer.computeAsync(token))),(()=>{__awaiter(this,void 0,void 0,(function*(){var e_1,_a;try{try{for(var _c,_b=__asyncValues(this._asyncIterable);!(_c=yield _b.next()).done;){const item=_c.value;item&&(this._result.push(item),this._fireResult())}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&(yield _a.call(_b))}finally{if(e_1)throw e_1.error}}this._asyncIterableDone=!0,3!==this._state&&4!==this._state||this._setState(0)}catch(e){onUnexpectedError(e)}}))})()):this._asyncIterableDone=!0}_triggerSyncComputation(){this._computer.computeSync&&(this._result=this._result.concat(this._computer.computeSync())),this._setState(this._asyncIterableDone?0:3)}_triggerLoadingMessage(){3===this._state&&this._setState(4)}_fireResult(){if(1===this._state||2===this._state)return;const isComplete=0===this._state,hasLoadingMessage=4===this._state;this._onResult.fire(new HoverResult(this._result.slice(0),isComplete,hasLoadingMessage))}start(mode){if(0===mode)0===this._state&&(this._setState(1),this._firstWaitScheduler.schedule(this._firstWaitTime),this._loadingMessageScheduler.schedule(this._loadingMessageTime));else switch(this._state){case 0:this._triggerAsyncComputation(),this._secondWaitScheduler.cancel(),this._triggerSyncComputation();break;case 2:this._secondWaitScheduler.cancel(),this._triggerSyncComputation()}}cancel(){this._firstWaitScheduler.cancel(),this._secondWaitScheduler.cancel(),this._loadingMessageScheduler.cancel(),this._asyncIterable&&(this._asyncIterable.cancel(),this._asyncIterable=null),this._result=[],this._setState(0,!1)}}