var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{stringDiff}from"../../../base/common/diff/diff.js";import{globals}from"../../../base/common/platform.js";import{URI}from"../../../base/common/uri.js";import{Position}from"../core/position.js";import{Range}from"../core/range.js";import{DiffComputer}from"../diff/diffComputer.js";import{MirrorTextModel as BaseMirrorModel}from"../model/mirrorTextModel.js";import{ensureValidWordDefinition,getWordAtText}from"../core/wordHelper.js";import{computeLinks}from"../languages/linkComputer.js";import{BasicInplaceReplace}from"../languages/supports/inplaceReplaceSupport.js";import{createMonacoBaseAPI}from"./editorBaseApi.js";import*as types from"../../../base/common/types.js";import{StopWatch}from"../../../base/common/stopwatch.js";import{UnicodeTextModelHighlighter}from"./unicodeTextModelHighlighter.js";export class MirrorModel extends BaseMirrorModel{get uri(){return this._uri}get eol(){return this._eol}getValue(){return this.getText()}getLinesContent(){return this._lines.slice(0)}getLineCount(){return this._lines.length}getLineContent(lineNumber){return this._lines[lineNumber-1]}getWordAtPosition(position,wordDefinition){const wordAtText=getWordAtText(position.column,ensureValidWordDefinition(wordDefinition),this._lines[position.lineNumber-1],0);return wordAtText?new Range(position.lineNumber,wordAtText.startColumn,position.lineNumber,wordAtText.endColumn):null}words(wordDefinition){const lines=this._lines,wordenize=this._wordenize.bind(this);let lineNumber=0,lineText="",wordRangesIdx=0,wordRanges=[];return{*[Symbol.iterator](){for(;;)if(wordRangesIdx<wordRanges.length){const value=lineText.substring(wordRanges[wordRangesIdx].start,wordRanges[wordRangesIdx].end);wordRangesIdx+=1,yield value}else{if(!(lineNumber<lines.length))break;lineText=lines[lineNumber],wordRanges=wordenize(lineText,wordDefinition),wordRangesIdx=0,lineNumber+=1}}}}getLineWords(lineNumber,wordDefinition){const content=this._lines[lineNumber-1],ranges=this._wordenize(content,wordDefinition),words=[];for(const range of ranges)words.push({word:content.substring(range.start,range.end),startColumn:range.start+1,endColumn:range.end+1});return words}_wordenize(content,wordDefinition){const result=[];let match;for(wordDefinition.lastIndex=0;(match=wordDefinition.exec(content))&&0!==match[0].length;)result.push({start:match.index,end:match.index+match[0].length});return result}getValueInRange(range){if((range=this._validateRange(range)).startLineNumber===range.endLineNumber)return this._lines[range.startLineNumber-1].substring(range.startColumn-1,range.endColumn-1);const lineEnding=this._eol,startLineIndex=range.startLineNumber-1,endLineIndex=range.endLineNumber-1,resultLines=[];resultLines.push(this._lines[startLineIndex].substring(range.startColumn-1));for(let i=startLineIndex+1;i<endLineIndex;i++)resultLines.push(this._lines[i]);return resultLines.push(this._lines[endLineIndex].substring(0,range.endColumn-1)),resultLines.join(lineEnding)}offsetAt(position){return position=this._validatePosition(position),this._ensureLineStarts(),this._lineStarts.getPrefixSum(position.lineNumber-2)+(position.column-1)}positionAt(offset){offset=Math.floor(offset),offset=Math.max(0,offset),this._ensureLineStarts();const out=this._lineStarts.getIndexOf(offset),lineLength=this._lines[out.index].length;return{lineNumber:1+out.index,column:1+Math.min(out.remainder,lineLength)}}_validateRange(range){const start=this._validatePosition({lineNumber:range.startLineNumber,column:range.startColumn}),end=this._validatePosition({lineNumber:range.endLineNumber,column:range.endColumn});return start.lineNumber!==range.startLineNumber||start.column!==range.startColumn||end.lineNumber!==range.endLineNumber||end.column!==range.endColumn?{startLineNumber:start.lineNumber,startColumn:start.column,endLineNumber:end.lineNumber,endColumn:end.column}:range}_validatePosition(position){if(!Position.isIPosition(position))throw new Error("bad position");let{lineNumber,column}=position,hasChanged=!1;if(lineNumber<1)lineNumber=1,column=1,hasChanged=!0;else if(lineNumber>this._lines.length)lineNumber=this._lines.length,column=this._lines[lineNumber-1].length+1,hasChanged=!0;else{const maxCharacter=this._lines[lineNumber-1].length+1;column<1?(column=1,hasChanged=!0):column>maxCharacter&&(column=maxCharacter,hasChanged=!0)}return hasChanged?{lineNumber,column}:position}}export class EditorSimpleWorker{constructor(host,foreignModuleFactory){this._host=host,this._models=Object.create(null),this._foreignModuleFactory=foreignModuleFactory,this._foreignModule=null}dispose(){this._models=Object.create(null)}_getModel(uri){return this._models[uri]}_getModels(){const all=[];return Object.keys(this._models).forEach((key=>all.push(this._models[key]))),all}acceptNewModel(data){this._models[data.url]=new MirrorModel(URI.parse(data.url),data.lines,data.EOL,data.versionId)}acceptModelChanged(strURL,e){if(!this._models[strURL])return;this._models[strURL].onEvents(e)}acceptRemovedModel(strURL){this._models[strURL]&&delete this._models[strURL]}computeUnicodeHighlights(url,options,range){return __awaiter(this,void 0,void 0,(function*(){const model=this._getModel(url);return model?UnicodeTextModelHighlighter.computeUnicodeHighlights(model,options,range):{ranges:[],hasMore:!1,ambiguousCharacterCount:0,invisibleCharacterCount:0,nonBasicAsciiCharacterCount:0}}))}computeDiff(originalUrl,modifiedUrl,ignoreTrimWhitespace,maxComputationTime){return __awaiter(this,void 0,void 0,(function*(){const original=this._getModel(originalUrl),modified=this._getModel(modifiedUrl);return original&&modified?EditorSimpleWorker.computeDiff(original,modified,ignoreTrimWhitespace,maxComputationTime):null}))}static computeDiff(originalTextModel,modifiedTextModel,ignoreTrimWhitespace,maxComputationTime){const originalLines=originalTextModel.getLinesContent(),modifiedLines=modifiedTextModel.getLinesContent(),diffResult=new DiffComputer(originalLines,modifiedLines,{shouldComputeCharChanges:!0,shouldPostProcessCharChanges:!0,shouldIgnoreTrimWhitespace:ignoreTrimWhitespace,shouldMakePrettyDiff:!0,maxComputationTime}).computeDiff(),identical=!(diffResult.changes.length>0)&&this._modelsAreIdentical(originalTextModel,modifiedTextModel);return{quitEarly:diffResult.quitEarly,identical,changes:diffResult.changes}}static _modelsAreIdentical(original,modified){const originalLineCount=original.getLineCount();if(originalLineCount!==modified.getLineCount())return!1;for(let line=1;line<=originalLineCount;line++){if(original.getLineContent(line)!==modified.getLineContent(line))return!1}return!0}computeMoreMinimalEdits(modelUrl,edits){return __awaiter(this,void 0,void 0,(function*(){const model=this._getModel(modelUrl);if(!model)return edits;const result=[];let lastEol;edits=edits.slice(0).sort(((a,b)=>{if(a.range&&b.range)return Range.compareRangesUsingStarts(a.range,b.range);return(a.range?0:1)-(b.range?0:1)}));for(let{range,text,eol}of edits){if("number"==typeof eol&&(lastEol=eol),Range.isEmpty(range)&&!text)continue;const original=model.getValueInRange(range);if(text=text.replace(/\r\n|\n|\r/g,model.eol),original===text)continue;if(Math.max(text.length,original.length)>EditorSimpleWorker._diffLimit){result.push({range,text});continue}const changes=stringDiff(original,text,!1),editOffset=model.offsetAt(Range.lift(range).getStartPosition());for(const change of changes){const start=model.positionAt(editOffset+change.originalStart),end=model.positionAt(editOffset+change.originalStart+change.originalLength),newEdit={text:text.substr(change.modifiedStart,change.modifiedLength),range:{startLineNumber:start.lineNumber,startColumn:start.column,endLineNumber:end.lineNumber,endColumn:end.column}};model.getValueInRange(newEdit.range)!==newEdit.text&&result.push(newEdit)}}return"number"==typeof lastEol&&result.push({eol:lastEol,text:"",range:{startLineNumber:0,startColumn:0,endLineNumber:0,endColumn:0}}),result}))}computeLinks(modelUrl){return __awaiter(this,void 0,void 0,(function*(){const model=this._getModel(modelUrl);return model?computeLinks(model):null}))}textualSuggest(modelUrls,leadingWord,wordDef,wordDefFlags){return __awaiter(this,void 0,void 0,(function*(){const sw=new StopWatch(!0),wordDefRegExp=new RegExp(wordDef,wordDefFlags),seen=new Set;outer:for(const url of modelUrls){const model=this._getModel(url);if(model)for(const word of model.words(wordDefRegExp))if(word!==leadingWord&&isNaN(Number(word))&&(seen.add(word),seen.size>EditorSimpleWorker._suggestionsLimit))break outer}return{words:Array.from(seen),duration:sw.elapsed()}}))}computeWordRanges(modelUrl,range,wordDef,wordDefFlags){return __awaiter(this,void 0,void 0,(function*(){const model=this._getModel(modelUrl);if(!model)return Object.create(null);const wordDefRegExp=new RegExp(wordDef,wordDefFlags),result=Object.create(null);for(let line=range.startLineNumber;line<range.endLineNumber;line++){const words=model.getLineWords(line,wordDefRegExp);for(const word of words){if(!isNaN(Number(word.word)))continue;let array=result[word.word];array||(array=[],result[word.word]=array),array.push({startLineNumber:line,startColumn:word.startColumn,endLineNumber:line,endColumn:word.endColumn})}}return result}))}navigateValueSet(modelUrl,range,up,wordDef,wordDefFlags){return __awaiter(this,void 0,void 0,(function*(){const model=this._getModel(modelUrl);if(!model)return null;const wordDefRegExp=new RegExp(wordDef,wordDefFlags);range.startColumn===range.endColumn&&(range={startLineNumber:range.startLineNumber,startColumn:range.startColumn,endLineNumber:range.endLineNumber,endColumn:range.endColumn+1});const selectionText=model.getValueInRange(range),wordRange=model.getWordAtPosition({lineNumber:range.startLineNumber,column:range.startColumn},wordDefRegExp);if(!wordRange)return null;const word=model.getValueInRange(wordRange);return BasicInplaceReplace.INSTANCE.navigateValueSet(range,selectionText,wordRange,word,up)}))}loadForeignModule(moduleId,createData,foreignHostMethods){const ctx={host:types.createProxyObject(foreignHostMethods,((method,args)=>this._host.fhr(method,args))),getMirrorModels:()=>this._getModels()};return this._foreignModuleFactory?(this._foreignModule=this._foreignModuleFactory(ctx,createData),Promise.resolve(types.getAllMethodNames(this._foreignModule))):Promise.reject(new Error("Unexpected usage"))}fmr(method,args){if(!this._foreignModule||"function"!=typeof this._foreignModule[method])return Promise.reject(new Error("Missing requestHandler or method: "+method));try{return Promise.resolve(this._foreignModule[method].apply(this._foreignModule,args))}catch(e){return Promise.reject(e)}}}EditorSimpleWorker._diffLimit=1e5,EditorSimpleWorker._suggestionsLimit=1e4;export function create(host){return new EditorSimpleWorker(host,null)}"function"==typeof importScripts&&(globals.monaco=createMonacoBaseAPI());