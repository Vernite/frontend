var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{createCancelablePromise,RunOnceScheduler}from"../../../../base/common/async.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedError,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{Emitter}from"../../../../base/common/event.js";import{Disposable,MutableDisposable,toDisposable}from"../../../../base/common/lifecycle.js";import{CoreEditingCommands}from"../../../browser/coreCommands.js";import{EditOperation}from"../../../common/core/editOperation.js";import{Range}from"../../../common/core/range.js";import{InlineCompletionTriggerKind}from"../../../common/languages.js";import{BaseGhostTextWidgetModel,GhostTextReplacement}from"./ghostText.js";import{ICommandService}from"../../../../platform/commands/common/commands.js";import{inlineSuggestCommitId}from"./consts.js";import{inlineCompletionToGhostText}from"./inlineCompletionToGhostText.js";import{ILanguageConfigurationService}from"../../../common/languages/languageConfigurationRegistry.js";import{fixBracketsInLine}from"../../../common/model/bracketPairsTextModelPart/fixBrackets.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";import{SnippetParser}from"../../snippet/browser/snippetParser.js";import{SnippetController2}from"../../snippet/browser/snippetController2.js";import{assertNever}from"../../../../base/common/types.js";import{matchesSubString}from"../../../../base/common/filters.js";import{getReadonlyEmptyArray}from"./utils.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";let InlineCompletionsModel=class InlineCompletionsModel extends Disposable{constructor(editor,cache,commandService,languageConfigurationService,languageFeaturesService,debounceService,configurationService){super(),this.editor=editor,this.cache=cache,this.commandService=commandService,this.languageConfigurationService=languageConfigurationService,this.languageFeaturesService=languageFeaturesService,this.debounceService=debounceService,this.onDidChangeEmitter=new Emitter,this.onDidChange=this.onDidChangeEmitter.event,this.completionSession=this._register(new MutableDisposable),this.active=!1,this.disposed=!1,this.debounceValue=this.debounceService.for(this.languageFeaturesService.inlineCompletionsProvider,"InlineCompletionsDebounce",{min:50,max:50}),this._register(commandService.onDidExecuteCommand((e=>{new Set([CoreEditingCommands.Tab.id,CoreEditingCommands.DeleteLeft.id,CoreEditingCommands.DeleteRight.id,inlineSuggestCommitId,"acceptSelectedSuggestion"]).has(e.commandId)&&editor.hasTextFocus()&&this.handleUserInput()}))),this._register(this.editor.onDidType((e=>{this.handleUserInput()}))),this._register(this.editor.onDidChangeCursorPosition((e=>{(3===e.reason||this.session&&!this.session.isValid)&&this.hide()}))),this._register(toDisposable((()=>{this.disposed=!0}))),this._register(this.editor.onDidBlurEditorWidget((()=>{configurationService.getValue("editor.inlineSuggest.hideOnBlur")||this.hide()})))}handleUserInput(){this.session&&!this.session.isValid&&this.hide(),setTimeout((()=>{this.disposed||this.startSessionIfTriggered()}),0)}get session(){return this.completionSession.value}get ghostText(){var _a;return null===(_a=this.session)||void 0===_a?void 0:_a.ghostText}get minReservedLineCount(){return this.session?this.session.minReservedLineCount:0}setExpanded(expanded){var _a;null===(_a=this.session)||void 0===_a||_a.setExpanded(expanded)}setActive(active){var _a;this.active=active,active&&(null===(_a=this.session)||void 0===_a||_a.scheduleAutomaticUpdate())}startSessionIfTriggered(){this.editor.getOption(57).enabled&&(this.session&&this.session.isValid||this.trigger(InlineCompletionTriggerKind.Automatic))}trigger(triggerKind){this.completionSession.value?triggerKind===InlineCompletionTriggerKind.Explicit&&this.completionSession.value.ensureUpdateWithExplicitContext():(this.completionSession.value=new InlineCompletionsSession(this.editor,this.editor.getPosition(),(()=>this.active),this.commandService,this.cache,triggerKind,this.languageConfigurationService,this.languageFeaturesService.inlineCompletionsProvider,this.debounceValue),this.completionSession.value.takeOwnership(this.completionSession.value.onDidChange((()=>{this.onDidChangeEmitter.fire()}))))}hide(){this.completionSession.clear(),this.onDidChangeEmitter.fire()}commitCurrentSuggestion(){var _a;null===(_a=this.session)||void 0===_a||_a.commitCurrentCompletion()}showNext(){var _a;null===(_a=this.session)||void 0===_a||_a.showNextInlineCompletion()}showPrevious(){var _a;null===(_a=this.session)||void 0===_a||_a.showPreviousInlineCompletion()}hasMultipleInlineCompletions(){var _a;return __awaiter(this,void 0,void 0,(function*(){const result=yield null===(_a=this.session)||void 0===_a?void 0:_a.hasMultipleInlineCompletions();return void 0!==result&&result}))}};InlineCompletionsModel=__decorate([__param(2,ICommandService),__param(3,ILanguageConfigurationService),__param(4,ILanguageFeaturesService),__param(5,ILanguageFeatureDebounceService),__param(6,IConfigurationService)],InlineCompletionsModel);export{InlineCompletionsModel};export class InlineCompletionsSession extends BaseGhostTextWidgetModel{constructor(editor,triggerPosition,shouldUpdate,commandService,cache,initialTriggerKind,languageConfigurationService,registry,debounce){let lastCompletionItem;super(editor),this.triggerPosition=triggerPosition,this.shouldUpdate=shouldUpdate,this.commandService=commandService,this.cache=cache,this.initialTriggerKind=initialTriggerKind,this.languageConfigurationService=languageConfigurationService,this.registry=registry,this.debounce=debounce,this.minReservedLineCount=0,this.updateOperation=this._register(new MutableDisposable),this.updateSoon=this._register(new RunOnceScheduler((()=>{const triggerKind=this.initialTriggerKind;return this.initialTriggerKind=InlineCompletionTriggerKind.Automatic,this.update(triggerKind)}),50)),this.filteredCompletions=[],this.currentlySelectedCompletionId=void 0,this._register(this.onDidChange((()=>{var _a;const currentCompletion=this.currentCompletion;if(currentCompletion&&currentCompletion.sourceInlineCompletion!==lastCompletionItem){lastCompletionItem=currentCompletion.sourceInlineCompletion;const provider=currentCompletion.sourceProvider;null===(_a=provider.handleItemDidShow)||void 0===_a||_a.call(provider,currentCompletion.sourceInlineCompletions,lastCompletionItem)}}))),this._register(toDisposable((()=>{this.cache.clear()}))),this._register(this.editor.onDidChangeCursorPosition((e=>{var _a;3!==e.reason&&(null===(_a=this.cache.value)||void 0===_a||_a.updateRanges(),this.cache.value&&(this.updateFilteredInlineCompletions(),this.onDidChangeEmitter.fire()))}))),this._register(this.editor.onDidChangeModelContent((e=>{var _a;null===(_a=this.cache.value)||void 0===_a||_a.updateRanges(),this.updateFilteredInlineCompletions(),this.scheduleAutomaticUpdate()}))),this._register(this.registry.onDidChange((()=>{this.updateSoon.schedule(this.debounce.get(this.editor.getModel()))}))),this.scheduleAutomaticUpdate()}updateFilteredInlineCompletions(){if(!this.cache.value)return void(this.filteredCompletions=[]);const model=this.editor.getModel(),cursorPosition=model.validatePosition(this.editor.getPosition());this.filteredCompletions=this.cache.value.completions.filter((c=>{const originalValue=model.getValueInRange(c.synchronizedRange).toLowerCase(),filterText=c.inlineCompletion.filterText.toLowerCase(),indent=model.getLineIndentColumn(c.synchronizedRange.startLineNumber),cursorPosIndex=Math.max(0,cursorPosition.column-c.synchronizedRange.startColumn);let filterTextBefore=filterText.substring(0,cursorPosIndex),filterTextAfter=filterText.substring(cursorPosIndex),originalValueBefore=originalValue.substring(0,cursorPosIndex),originalValueAfter=originalValue.substring(cursorPosIndex);return c.synchronizedRange.startColumn<=indent&&(originalValueBefore=originalValueBefore.trimStart(),0===originalValueBefore.length&&(originalValueAfter=originalValueAfter.trimStart()),filterTextBefore=filterTextBefore.trimStart(),0===filterTextBefore.length&&(filterTextAfter=filterTextAfter.trimStart())),filterTextBefore.startsWith(originalValueBefore)&&matchesSubString(originalValueAfter,filterTextAfter)}))}fixAndGetIndexOfCurrentSelection(){if(!this.currentlySelectedCompletionId||!this.cache.value)return 0;if(0===this.cache.value.completions.length)return 0;const idx=this.filteredCompletions.findIndex((v=>v.semanticId===this.currentlySelectedCompletionId));return-1===idx?(this.currentlySelectedCompletionId=void 0,0):idx}get currentCachedCompletion(){if(this.cache.value)return this.filteredCompletions[this.fixAndGetIndexOfCurrentSelection()]}showNextInlineCompletion(){return __awaiter(this,void 0,void 0,(function*(){yield this.ensureUpdateWithExplicitContext();const completions=this.filteredCompletions||[];if(completions.length>0){const newIdx=(this.fixAndGetIndexOfCurrentSelection()+1)%completions.length;this.currentlySelectedCompletionId=completions[newIdx].semanticId}else this.currentlySelectedCompletionId=void 0;this.onDidChangeEmitter.fire()}))}showPreviousInlineCompletion(){return __awaiter(this,void 0,void 0,(function*(){yield this.ensureUpdateWithExplicitContext();const completions=this.filteredCompletions||[];if(completions.length>0){const newIdx=(this.fixAndGetIndexOfCurrentSelection()+completions.length-1)%completions.length;this.currentlySelectedCompletionId=completions[newIdx].semanticId}else this.currentlySelectedCompletionId=void 0;this.onDidChangeEmitter.fire()}))}ensureUpdateWithExplicitContext(){var _a;return __awaiter(this,void 0,void 0,(function*(){this.updateOperation.value?this.updateOperation.value.triggerKind===InlineCompletionTriggerKind.Explicit?yield this.updateOperation.value.promise:yield this.update(InlineCompletionTriggerKind.Explicit):(null===(_a=this.cache.value)||void 0===_a?void 0:_a.triggerKind)!==InlineCompletionTriggerKind.Explicit&&(yield this.update(InlineCompletionTriggerKind.Explicit))}))}hasMultipleInlineCompletions(){var _a;return __awaiter(this,void 0,void 0,(function*(){return yield this.ensureUpdateWithExplicitContext(),((null===(_a=this.cache.value)||void 0===_a?void 0:_a.completions.length)||0)>1}))}get ghostText(){const currentCompletion=this.currentCompletion;if(!currentCompletion)return;const cursorPosition=this.editor.getPosition();if(currentCompletion.range.getEndPosition().isBefore(cursorPosition))return;const mode=this.editor.getOptions().get(57).mode,ghostText=inlineCompletionToGhostText(currentCompletion,this.editor.getModel(),mode,cursorPosition);if(ghostText){if(ghostText.isEmpty())return;return ghostText}return new GhostTextReplacement(currentCompletion.range.startLineNumber,currentCompletion.range.startColumn,currentCompletion.range.endColumn-currentCompletion.range.startColumn,currentCompletion.insertText.split("\n"),0)}get currentCompletion(){const completion=this.currentCachedCompletion;if(completion)return completion.toLiveInlineCompletion()}get isValid(){return this.editor.getPosition().lineNumber===this.triggerPosition.lineNumber}scheduleAutomaticUpdate(){this.updateOperation.clear(),this.updateSoon.schedule(this.debounce.get(this.editor.getModel()))}update(triggerKind){return __awaiter(this,void 0,void 0,(function*(){if(!this.shouldUpdate())return;const position=this.editor.getPosition(),startTime=new Date,promise=createCancelablePromise((token=>__awaiter(this,void 0,void 0,(function*(){let result;try{result=yield provideInlineCompletions(this.registry,position,this.editor.getModel(),{triggerKind,selectedSuggestionInfo:void 0},token,this.languageConfigurationService);const endTime=new Date;this.debounce.update(this.editor.getModel(),endTime.getTime()-startTime.getTime())}catch(e){return void onUnexpectedError(e)}token.isCancellationRequested||(this.cache.setValue(this.editor,result,triggerKind),this.updateFilteredInlineCompletions(),this.onDidChangeEmitter.fire())})))),operation=new UpdateOperation(promise,triggerKind);this.updateOperation.value=operation,yield promise,this.updateOperation.value===operation&&this.updateOperation.clear()}))}takeOwnership(disposable){this._register(disposable)}commitCurrentCompletion(){if(!this.ghostText)return;const completion=this.currentCompletion;completion&&this.commit(completion)}commit(completion){var _a;const cache=this.cache.clearAndLeak();completion.snippetInfo?(this.editor.executeEdits("inlineSuggestion.accept",[EditOperation.replaceMove(completion.range,""),...completion.additionalTextEdits]),this.editor.setPosition(completion.snippetInfo.range.getStartPosition()),null===(_a=SnippetController2.get(this.editor))||void 0===_a||_a.insert(completion.snippetInfo.snippet)):this.editor.executeEdits("inlineSuggestion.accept",[EditOperation.replaceMove(completion.range,completion.insertText),...completion.additionalTextEdits]),completion.command?this.commandService.executeCommand(completion.command.id,...completion.command.arguments||[]).finally((()=>{null==cache||cache.dispose()})).then(void 0,onUnexpectedExternalError):null==cache||cache.dispose(),this.onDidChangeEmitter.fire()}get commands(){var _a;return[...new Set((null===(_a=this.cache.value)||void 0===_a?void 0:_a.completions.map((c=>c.inlineCompletion.sourceInlineCompletions)))||[])].flatMap((l=>l.commands||[]))}}export class UpdateOperation{constructor(promise,triggerKind){this.promise=promise,this.triggerKind=triggerKind}dispose(){this.promise.cancel()}}export class SynchronizedInlineCompletionsCache extends Disposable{constructor(completionsSource,editor,onChange,triggerKind){super(),this.editor=editor,this.onChange=onChange,this.triggerKind=triggerKind,this.isDisposing=!1;const decorationIds=editor.changeDecorations((changeAccessor=>changeAccessor.deltaDecorations([],completionsSource.items.map((i=>({range:i.range,options:{description:"inline-completion-tracking-range"}}))))));this._register(toDisposable((()=>{this.isDisposing=!0,editor.removeDecorations(decorationIds)}))),this.completions=completionsSource.items.map(((c,idx)=>new CachedInlineCompletion(c,decorationIds[idx]))),this._register(editor.onDidChangeModelContent((()=>{this.updateRanges()}))),this._register(completionsSource)}updateRanges(){if(this.isDisposing)return;let hasChanged=!1;const model=this.editor.getModel();for(const c of this.completions){const newRange=model.getDecorationRange(c.decorationId);newRange?c.synchronizedRange.equalsRange(newRange)||(hasChanged=!0,c.synchronizedRange=newRange):onUnexpectedError(new Error("Decoration has no range"))}hasChanged&&this.onChange()}}class CachedInlineCompletion{constructor(inlineCompletion,decorationId){this.inlineCompletion=inlineCompletion,this.decorationId=decorationId,this.semanticId=JSON.stringify({text:this.inlineCompletion.insertText,abbreviation:this.inlineCompletion.filterText,startLine:this.inlineCompletion.range.startLineNumber,startColumn:this.inlineCompletion.range.startColumn,command:this.inlineCompletion.command}),this.synchronizedRange=inlineCompletion.range}toLiveInlineCompletion(){return{insertText:this.inlineCompletion.insertText,range:this.synchronizedRange,command:this.inlineCompletion.command,sourceProvider:this.inlineCompletion.sourceProvider,sourceInlineCompletions:this.inlineCompletion.sourceInlineCompletions,sourceInlineCompletion:this.inlineCompletion.sourceInlineCompletion,snippetInfo:this.inlineCompletion.snippetInfo,filterText:this.inlineCompletion.filterText,additionalTextEdits:this.inlineCompletion.additionalTextEdits}}}export function provideInlineCompletions(registry,position,model,context,token=CancellationToken.None,languageConfigurationService){return __awaiter(this,void 0,void 0,(function*(){const defaultReplaceRange=getDefaultRange(position,model),providers=registry.all(model),results=yield Promise.all(providers.map((provider=>__awaiter(this,void 0,void 0,(function*(){const completions=yield Promise.resolve(provider.provideInlineCompletions(model,position,context,token)).catch(onUnexpectedExternalError);return{completions,provider,dispose:()=>{completions&&provider.freeInlineCompletions(completions)}}}))))),itemsByHash=new Map;for(const result of results){const completions=result.completions;if(completions)for(const item of completions.items){let insertText,snippetInfo,range=item.range?Range.lift(item.range):defaultReplaceRange;if(range.startLineNumber!==range.endLineNumber)continue;if("string"==typeof item.insertText){if(insertText=item.insertText,languageConfigurationService&&item.completeBracketPairs){insertText=closeBrackets(insertText,range.getStartPosition(),model,languageConfigurationService);const diff=insertText.length-item.insertText.length;0!==diff&&(range=new Range(range.startLineNumber,range.startColumn,range.endLineNumber,range.endColumn+diff))}snippetInfo=void 0}else if("snippet"in item.insertText){insertText=(new SnippetParser).parse(item.insertText.snippet).toString(),snippetInfo={snippet:item.insertText.snippet,range}}else assertNever(item.insertText);const trackedItem={insertText,snippetInfo,range,command:item.command,sourceProvider:result.provider,sourceInlineCompletions:completions,sourceInlineCompletion:item,filterText:item.filterText||insertText,additionalTextEdits:item.additionalTextEdits||getReadonlyEmptyArray()};itemsByHash.set(JSON.stringify({insertText,range:item.range}),trackedItem)}}return{items:[...itemsByHash.values()],dispose:()=>{for(const result of results)result.dispose()}}}))}function getDefaultRange(position,model){const word=model.getWordAtPosition(position),maxColumn=model.getLineMaxColumn(position.lineNumber);return word?new Range(position.lineNumber,word.startColumn,position.lineNumber,maxColumn):Range.fromPositions(position,position.with(void 0,maxColumn))}function closeBrackets(text,position,model,languageConfigurationService){const newLine=model.getLineContent(position.lineNumber).substring(0,position.column-1)+text,newTokens=model.tokenization.tokenizeLineWithEdit(position,newLine.length-(position.column-1),text),slicedTokens=null==newTokens?void 0:newTokens.sliceAndInflate(position.column-1,newLine.length,0);if(!slicedTokens)return text;return fixBracketsInLine(slicedTokens,languageConfigurationService)}