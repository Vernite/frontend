import{findFirstInSorted}from"../../../../base/common/arrays.js";import{RunOnceScheduler,TimeoutTimer}from"../../../../base/common/async.js";import{DisposableStore,dispose}from"../../../../base/common/lifecycle.js";import{ReplaceCommand,ReplaceCommandThatPreservesSelection}from"../../../common/commands/replaceCommand.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{SearchParams}from"../../../common/model/textModelSearch.js";import{FindDecorations}from"./findDecorations.js";import{ReplaceAllCommand}from"./replaceAllCommand.js";import{parseReplaceString,ReplacePattern}from"./replacePattern.js";import{RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";export const CONTEXT_FIND_WIDGET_VISIBLE=new RawContextKey("findWidgetVisible",!1);export const CONTEXT_FIND_WIDGET_NOT_VISIBLE=CONTEXT_FIND_WIDGET_VISIBLE.toNegated();export const CONTEXT_FIND_INPUT_FOCUSED=new RawContextKey("findInputFocussed",!1);export const CONTEXT_REPLACE_INPUT_FOCUSED=new RawContextKey("replaceInputFocussed",!1);export const ToggleCaseSensitiveKeybinding={primary:545,mac:{primary:2593}};export const ToggleWholeWordKeybinding={primary:565,mac:{primary:2613}};export const ToggleRegexKeybinding={primary:560,mac:{primary:2608}};export const ToggleSearchScopeKeybinding={primary:554,mac:{primary:2602}};export const TogglePreserveCaseKeybinding={primary:558,mac:{primary:2606}};export const FIND_IDS={StartFindAction:"actions.find",StartFindWithSelection:"actions.findWithSelection",StartFindWithArgs:"editor.actions.findWithArgs",NextMatchFindAction:"editor.action.nextMatchFindAction",PreviousMatchFindAction:"editor.action.previousMatchFindAction",NextSelectionMatchFindAction:"editor.action.nextSelectionMatchFindAction",PreviousSelectionMatchFindAction:"editor.action.previousSelectionMatchFindAction",StartFindReplaceAction:"editor.action.startFindReplaceAction",CloseFindWidgetCommand:"closeFindWidget",ToggleCaseSensitiveCommand:"toggleFindCaseSensitive",ToggleWholeWordCommand:"toggleFindWholeWord",ToggleRegexCommand:"toggleFindRegex",ToggleSearchScopeCommand:"toggleFindInSelection",TogglePreserveCaseCommand:"togglePreserveCase",ReplaceOneAction:"editor.action.replaceOne",ReplaceAllAction:"editor.action.replaceAll",SelectAllMatchesAction:"editor.action.selectAllMatches"};export const MATCHES_LIMIT=19999;const RESEARCH_DELAY=240;export class FindModelBoundToEditorModel{constructor(editor,state){this._toDispose=new DisposableStore,this._editor=editor,this._state=state,this._isDisposed=!1,this._startSearchingTimer=new TimeoutTimer,this._decorations=new FindDecorations(editor),this._toDispose.add(this._decorations),this._updateDecorationsScheduler=new RunOnceScheduler((()=>this.research(!1)),100),this._toDispose.add(this._updateDecorationsScheduler),this._toDispose.add(this._editor.onDidChangeCursorPosition((e=>{3!==e.reason&&5!==e.reason&&6!==e.reason||this._decorations.setStartPosition(this._editor.getPosition())}))),this._ignoreModelContentChanged=!1,this._toDispose.add(this._editor.onDidChangeModelContent((e=>{this._ignoreModelContentChanged||(e.isFlush&&this._decorations.reset(),this._decorations.setStartPosition(this._editor.getPosition()),this._updateDecorationsScheduler.schedule())}))),this._toDispose.add(this._state.onFindReplaceStateChange((e=>this._onStateChanged(e)))),this.research(!1,this._state.searchScope)}dispose(){this._isDisposed=!0,dispose(this._startSearchingTimer),this._toDispose.dispose()}_onStateChanged(e){if(!this._isDisposed&&this._editor.hasModel()&&(e.searchString||e.isReplaceRevealed||e.isRegex||e.wholeWord||e.matchCase||e.searchScope)){this._editor.getModel().isTooLargeForSyncing()?(this._startSearchingTimer.cancel(),this._startSearchingTimer.setIfNotSet((()=>{e.searchScope?this.research(e.moveCursor,this._state.searchScope):this.research(e.moveCursor)}),240)):e.searchScope?this.research(e.moveCursor,this._state.searchScope):this.research(e.moveCursor)}}static _getSearchRange(model,findScope){return findScope||model.getFullModelRange()}research(moveCursor,newFindScope){let findScopes=null;void 0!==newFindScope?null!==newFindScope&&(findScopes=Array.isArray(newFindScope)?newFindScope:[newFindScope]):findScopes=this._decorations.getFindScopes(),null!==findScopes&&(findScopes=findScopes.map((findScope=>{if(findScope.startLineNumber!==findScope.endLineNumber){let endLineNumber=findScope.endLineNumber;return 1===findScope.endColumn&&(endLineNumber-=1),new Range(findScope.startLineNumber,1,endLineNumber,this._editor.getModel().getLineMaxColumn(endLineNumber))}return findScope})));const findMatches=this._findMatches(findScopes,!1,19999);this._decorations.set(findMatches,findScopes);const editorSelection=this._editor.getSelection();let currentMatchesPosition=this._decorations.getCurrentMatchesPosition(editorSelection);if(0===currentMatchesPosition&&findMatches.length>0){const matchAfterSelection=findFirstInSorted(findMatches.map((match=>match.range)),(range=>Range.compareRangesUsingStarts(range,editorSelection)>=0));currentMatchesPosition=matchAfterSelection>0?matchAfterSelection-1+1:currentMatchesPosition}this._state.changeMatchInfo(currentMatchesPosition,this._decorations.getCount(),void 0),moveCursor&&this._editor.getOption(37).cursorMoveOnType&&this._moveToNextMatch(this._decorations.getStartPosition())}_hasMatches(){return this._state.matchesCount>0}_cannotFind(){if(!this._hasMatches()){const findScope=this._decorations.getFindScope();return findScope&&this._editor.revealRangeInCenterIfOutsideViewport(findScope,0),!0}return!1}_setCurrentFindMatch(match){const matchesPosition=this._decorations.setCurrentFindMatch(match);this._state.changeMatchInfo(matchesPosition,this._decorations.getCount(),match),this._editor.setSelection(match),this._editor.revealRangeInCenterIfOutsideViewport(match,0)}_prevSearchPosition(before){const isUsingLineStops=this._state.isRegex&&(this._state.searchString.indexOf("^")>=0||this._state.searchString.indexOf("$")>=0);let{lineNumber,column}=before;const model=this._editor.getModel();return isUsingLineStops||1===column?(1===lineNumber?lineNumber=model.getLineCount():lineNumber--,column=model.getLineMaxColumn(lineNumber)):column--,new Position(lineNumber,column)}_moveToPrevMatch(before,isRecursed=!1){if(!this._state.canNavigateBack()){const nextMatchRange=this._decorations.matchAfterPosition(before);return void(nextMatchRange&&this._setCurrentFindMatch(nextMatchRange))}if(this._decorations.getCount()<19999){let prevMatchRange=this._decorations.matchBeforePosition(before);return prevMatchRange&&prevMatchRange.isEmpty()&&prevMatchRange.getStartPosition().equals(before)&&(before=this._prevSearchPosition(before),prevMatchRange=this._decorations.matchBeforePosition(before)),void(prevMatchRange&&this._setCurrentFindMatch(prevMatchRange))}if(this._cannotFind())return;const findScope=this._decorations.getFindScope(),searchRange=FindModelBoundToEditorModel._getSearchRange(this._editor.getModel(),findScope);searchRange.getEndPosition().isBefore(before)&&(before=searchRange.getEndPosition()),before.isBefore(searchRange.getStartPosition())&&(before=searchRange.getEndPosition());const{lineNumber,column}=before,model=this._editor.getModel();let position=new Position(lineNumber,column),prevMatch=model.findPreviousMatch(this._state.searchString,position,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(119):null,!1);return prevMatch&&prevMatch.range.isEmpty()&&prevMatch.range.getStartPosition().equals(position)&&(position=this._prevSearchPosition(position),prevMatch=model.findPreviousMatch(this._state.searchString,position,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(119):null,!1)),prevMatch?isRecursed||searchRange.containsRange(prevMatch.range)?void this._setCurrentFindMatch(prevMatch.range):this._moveToPrevMatch(prevMatch.range.getStartPosition(),!0):void 0}moveToPrevMatch(){this._moveToPrevMatch(this._editor.getSelection().getStartPosition())}_nextSearchPosition(after){const isUsingLineStops=this._state.isRegex&&(this._state.searchString.indexOf("^")>=0||this._state.searchString.indexOf("$")>=0);let{lineNumber,column}=after;const model=this._editor.getModel();return isUsingLineStops||column===model.getLineMaxColumn(lineNumber)?(lineNumber===model.getLineCount()?lineNumber=1:lineNumber++,column=1):column++,new Position(lineNumber,column)}_moveToNextMatch(after){if(!this._state.canNavigateForward()){const prevMatchRange=this._decorations.matchBeforePosition(after);return void(prevMatchRange&&this._setCurrentFindMatch(prevMatchRange))}if(this._decorations.getCount()<19999){let nextMatchRange=this._decorations.matchAfterPosition(after);return nextMatchRange&&nextMatchRange.isEmpty()&&nextMatchRange.getStartPosition().equals(after)&&(after=this._nextSearchPosition(after),nextMatchRange=this._decorations.matchAfterPosition(after)),void(nextMatchRange&&this._setCurrentFindMatch(nextMatchRange))}const nextMatch=this._getNextMatch(after,!1,!0);nextMatch&&this._setCurrentFindMatch(nextMatch.range)}_getNextMatch(after,captureMatches,forceMove,isRecursed=!1){if(this._cannotFind())return null;const findScope=this._decorations.getFindScope(),searchRange=FindModelBoundToEditorModel._getSearchRange(this._editor.getModel(),findScope);searchRange.getEndPosition().isBefore(after)&&(after=searchRange.getStartPosition()),after.isBefore(searchRange.getStartPosition())&&(after=searchRange.getStartPosition());const{lineNumber,column}=after,model=this._editor.getModel();let position=new Position(lineNumber,column),nextMatch=model.findNextMatch(this._state.searchString,position,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(119):null,captureMatches);return forceMove&&nextMatch&&nextMatch.range.isEmpty()&&nextMatch.range.getStartPosition().equals(position)&&(position=this._nextSearchPosition(position),nextMatch=model.findNextMatch(this._state.searchString,position,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(119):null,captureMatches)),nextMatch?isRecursed||searchRange.containsRange(nextMatch.range)?nextMatch:this._getNextMatch(nextMatch.range.getEndPosition(),captureMatches,forceMove,!0):null}moveToNextMatch(){this._moveToNextMatch(this._editor.getSelection().getEndPosition())}_getReplacePattern(){return this._state.isRegex?parseReplaceString(this._state.replaceString):ReplacePattern.fromStaticValue(this._state.replaceString)}replace(){if(!this._hasMatches())return;const replacePattern=this._getReplacePattern(),selection=this._editor.getSelection(),nextMatch=this._getNextMatch(selection.getStartPosition(),!0,!1);if(nextMatch)if(selection.equalsRange(nextMatch.range)){const replaceString=replacePattern.buildReplaceString(nextMatch.matches,this._state.preserveCase),command=new ReplaceCommand(selection,replaceString);this._executeEditorCommand("replace",command),this._decorations.setStartPosition(new Position(selection.startLineNumber,selection.startColumn+replaceString.length)),this.research(!0)}else this._decorations.setStartPosition(this._editor.getPosition()),this._setCurrentFindMatch(nextMatch.range)}_findMatches(findScopes,captureMatches,limitResultCount){const searchRanges=(findScopes||[null]).map((scope=>FindModelBoundToEditorModel._getSearchRange(this._editor.getModel(),scope)));return this._editor.getModel().findMatches(this._state.searchString,searchRanges,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(119):null,captureMatches,limitResultCount)}replaceAll(){if(!this._hasMatches())return;const findScopes=this._decorations.getFindScopes();null===findScopes&&this._state.matchesCount>=19999?this._largeReplaceAll():this._regularReplaceAll(findScopes),this.research(!1)}_largeReplaceAll(){const searchData=new SearchParams(this._state.searchString,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(119):null).parseSearchRequest();if(!searchData)return;let searchRegex=searchData.regex;if(!searchRegex.multiline){let mod="mu";searchRegex.ignoreCase&&(mod+="i"),searchRegex.global&&(mod+="g"),searchRegex=new RegExp(searchRegex.source,mod)}const model=this._editor.getModel(),modelText=model.getValue(1),fullModelRange=model.getFullModelRange(),replacePattern=this._getReplacePattern();let resultText;const preserveCase=this._state.preserveCase;resultText=replacePattern.hasReplacementPatterns||preserveCase?modelText.replace(searchRegex,(function(){return replacePattern.buildReplaceString(arguments,preserveCase)})):modelText.replace(searchRegex,replacePattern.buildReplaceString(null,preserveCase));const command=new ReplaceCommandThatPreservesSelection(fullModelRange,resultText,this._editor.getSelection());this._executeEditorCommand("replaceAll",command)}_regularReplaceAll(findScopes){const replacePattern=this._getReplacePattern(),matches=this._findMatches(findScopes,replacePattern.hasReplacementPatterns||this._state.preserveCase,1073741824),replaceStrings=[];for(let i=0,len=matches.length;i<len;i++)replaceStrings[i]=replacePattern.buildReplaceString(matches[i].matches,this._state.preserveCase);const command=new ReplaceAllCommand(this._editor.getSelection(),matches.map((m=>m.range)),replaceStrings);this._executeEditorCommand("replaceAll",command)}selectAllMatches(){if(!this._hasMatches())return;const findScopes=this._decorations.getFindScopes();let selections=this._findMatches(findScopes,!1,1073741824).map((m=>new Selection(m.range.startLineNumber,m.range.startColumn,m.range.endLineNumber,m.range.endColumn)));const editorSelection=this._editor.getSelection();for(let i=0,len=selections.length;i<len;i++){if(selections[i].equalsRange(editorSelection)){selections=[editorSelection].concat(selections.slice(0,i)).concat(selections.slice(i+1));break}}this._editor.setSelections(selections)}_executeEditorCommand(source,command){try{this._ignoreModelContentChanged=!0,this._editor.pushUndoStop(),this._editor.executeCommand(source,command),this._editor.pushUndoStop()}finally{this._ignoreModelContentChanged=!1}}}