var IdentityHash,__decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import{doHash}from"../../../base/common/hash.js";import{LRUCache}from"../../../base/common/map.js";import{clamp,MovingAverage,SlidingWindowAverage}from"../../../base/common/numbers.js";import{registerSingleton}from"../../../platform/instantiation/common/extensions.js";import{createDecorator}from"../../../platform/instantiation/common/instantiation.js";import{ILogService}from"../../../platform/log/common/log.js";import{matchesScheme}from"../../../platform/opener/common/opener.js";export const ILanguageFeatureDebounceService=createDecorator("ILanguageFeatureDebounceService");!function(IdentityHash){const _hashes=new WeakMap;let pool=0;IdentityHash.of=function of(obj){let value=_hashes.get(obj);return void 0===value&&(value=++pool,_hashes.set(obj,value)),value}}(IdentityHash||(IdentityHash={}));class FeatureDebounceInformation{constructor(_logService,_name,_registry,_default,_min,_max){this._logService=_logService,this._name=_name,this._registry=_registry,this._default=_default,this._min=_min,this._max=_max,this._cache=new LRUCache(50,.7)}_key(model){return model.id+this._registry.all(model).reduce(((hashVal,obj)=>doHash(IdentityHash.of(obj),hashVal)),0)}get(model){const key=this._key(model),avg=this._cache.get(key);return avg?clamp(avg.value,this._min,this._max):this.default()}update(model,value){const key=this._key(model);let avg=this._cache.get(key);avg||(avg=new SlidingWindowAverage(6),this._cache.set(key,avg));const newValue=clamp(avg.update(value),this._min,this._max);return matchesScheme(model.uri,"output")||this._logService.trace(`[DEBOUNCE: ${this._name}] for ${model.uri.toString()} is ${newValue}ms`),newValue}_overall(){const result=new MovingAverage;for(const[,avg]of this._cache)result.update(avg.value);return result.value}default(){const value=0|this._overall()||this._default;return clamp(value,this._min,this._max)}}let LanguageFeatureDebounceService=class LanguageFeatureDebounceService{constructor(_logService){this._logService=_logService,this._data=new Map}for(feature,name,config){var _a,_b,_c;const min=null!==(_a=null==config?void 0:config.min)&&void 0!==_a?_a:50,max=null!==(_b=null==config?void 0:config.max)&&void 0!==_b?_b:Math.pow(min,2),extra=null!==(_c=null==config?void 0:config.key)&&void 0!==_c?_c:void 0,key=`${IdentityHash.of(feature)},${min}${extra?","+extra:""}`;let info=this._data.get(key);return info||(info=new FeatureDebounceInformation(this._logService,name,feature,0|this._overallAverage()||1.5*min,min,max),this._data.set(key,info)),info}_overallAverage(){const result=new MovingAverage;for(const info of this._data.values())result.update(info.default());return result.value}};LanguageFeatureDebounceService=__decorate([__param(0,ILogService)],LanguageFeatureDebounceService);export{LanguageFeatureDebounceService};registerSingleton(ILanguageFeatureDebounceService,LanguageFeatureDebounceService,!0);