var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{IntervalTimer,timeout}from"../../../base/common/async.js";import{Disposable,dispose,toDisposable,DisposableStore}from"../../../base/common/lifecycle.js";import{SimpleWorkerClient,logOnceWebWorkerWarning}from"../../../base/common/worker/simpleWorker.js";import{DefaultWorkerFactory}from"../../../base/browser/defaultWorkerFactory.js";import{Range}from"../../common/core/range.js";import{ILanguageConfigurationService}from"../../common/languages/languageConfigurationRegistry.js";import{EditorSimpleWorker}from"../../common/services/editorSimpleWorker.js";import{IModelService}from"../../common/services/model.js";import{ITextResourceConfigurationService}from"../../common/services/textResourceConfiguration.js";import{regExpFlags}from"../../../base/common/strings.js";import{isNonEmptyArray}from"../../../base/common/arrays.js";import{ILogService}from"../../../platform/log/common/log.js";import{StopWatch}from"../../../base/common/stopwatch.js";import{canceled}from"../../../base/common/errors.js";import{ILanguageFeaturesService}from"../../common/services/languageFeatures.js";const STOP_SYNC_MODEL_DELTA_TIME_MS=6e4,STOP_WORKER_DELTA_TIME_MS=3e5;function canSyncModel(modelService,resource){const model=modelService.getModel(resource);return!!model&&!model.isTooLargeForSyncing()}let EditorWorkerService=class EditorWorkerService extends Disposable{constructor(modelService,configurationService,logService,languageConfigurationService,languageFeaturesService){super(),this._modelService=modelService,this._workerManager=this._register(new WorkerManager(this._modelService,languageConfigurationService)),this._logService=logService,this._register(languageFeaturesService.linkProvider.register({language:"*",hasAccessToAllModels:!0},{provideLinks:(model,token)=>canSyncModel(this._modelService,model.uri)?this._workerManager.withWorker().then((client=>client.computeLinks(model.uri))).then((links=>links&&{links})):Promise.resolve({links:[]})})),this._register(languageFeaturesService.completionProvider.register("*",new WordBasedCompletionItemProvider(this._workerManager,configurationService,this._modelService,languageConfigurationService)))}dispose(){super.dispose()}canComputeUnicodeHighlights(uri){return canSyncModel(this._modelService,uri)}computedUnicodeHighlights(uri,options,range){return this._workerManager.withWorker().then((client=>client.computedUnicodeHighlights(uri,options,range)))}computeDiff(original,modified,ignoreTrimWhitespace,maxComputationTime){return this._workerManager.withWorker().then((client=>client.computeDiff(original,modified,ignoreTrimWhitespace,maxComputationTime)))}computeMoreMinimalEdits(resource,edits){if(isNonEmptyArray(edits)){if(!canSyncModel(this._modelService,resource))return Promise.resolve(edits);const sw=StopWatch.create(!0),result=this._workerManager.withWorker().then((client=>client.computeMoreMinimalEdits(resource,edits)));return result.finally((()=>this._logService.trace("FORMAT#computeMoreMinimalEdits",resource.toString(!0),sw.elapsed()))),Promise.race([result,timeout(1e3).then((()=>edits))])}return Promise.resolve(void 0)}canNavigateValueSet(resource){return canSyncModel(this._modelService,resource)}navigateValueSet(resource,range,up){return this._workerManager.withWorker().then((client=>client.navigateValueSet(resource,range,up)))}canComputeWordRanges(resource){return canSyncModel(this._modelService,resource)}computeWordRanges(resource,range){return this._workerManager.withWorker().then((client=>client.computeWordRanges(resource,range)))}};EditorWorkerService=__decorate([__param(0,IModelService),__param(1,ITextResourceConfigurationService),__param(2,ILogService),__param(3,ILanguageConfigurationService),__param(4,ILanguageFeaturesService)],EditorWorkerService);export{EditorWorkerService};class WordBasedCompletionItemProvider{constructor(workerManager,configurationService,modelService,languageConfigurationService){this.languageConfigurationService=languageConfigurationService,this._debugDisplayName="wordbasedCompletions",this._workerManager=workerManager,this._configurationService=configurationService,this._modelService=modelService}provideCompletionItems(model,position){return __awaiter(this,void 0,void 0,(function*(){const config=this._configurationService.getValue(model.uri,position,"editor");if(!config.wordBasedSuggestions)return;const models=[];if("currentDocument"===config.wordBasedSuggestionsMode)canSyncModel(this._modelService,model.uri)&&models.push(model.uri);else for(const candidate of this._modelService.getModels())canSyncModel(this._modelService,candidate.uri)&&(candidate===model?models.unshift(candidate.uri):"allDocuments"!==config.wordBasedSuggestionsMode&&candidate.getLanguageId()!==model.getLanguageId()||models.push(candidate.uri));if(0===models.length)return;const wordDefRegExp=this.languageConfigurationService.getLanguageConfiguration(model.getLanguageId()).getWordDefinition(),word=model.getWordAtPosition(position),replace=word?new Range(position.lineNumber,word.startColumn,position.lineNumber,word.endColumn):Range.fromPositions(position),insert=replace.setEndPosition(position.lineNumber,position.column),client=yield this._workerManager.withWorker(),data=yield client.textualSuggest(models,null==word?void 0:word.word,wordDefRegExp);return data?{duration:data.duration,suggestions:data.words.map((word=>({kind:18,label:word,insertText:word,range:{insert,replace}})))}:void 0}))}}class WorkerManager extends Disposable{constructor(modelService,languageConfigurationService){super(),this.languageConfigurationService=languageConfigurationService,this._modelService=modelService,this._editorWorkerClient=null,this._lastWorkerUsedTime=(new Date).getTime();this._register(new IntervalTimer).cancelAndSet((()=>this._checkStopIdleWorker()),Math.round(15e4)),this._register(this._modelService.onModelRemoved((_=>this._checkStopEmptyWorker())))}dispose(){this._editorWorkerClient&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null),super.dispose()}_checkStopEmptyWorker(){if(!this._editorWorkerClient)return;0===this._modelService.getModels().length&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null)}_checkStopIdleWorker(){if(!this._editorWorkerClient)return;(new Date).getTime()-this._lastWorkerUsedTime>3e5&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null)}withWorker(){return this._lastWorkerUsedTime=(new Date).getTime(),this._editorWorkerClient||(this._editorWorkerClient=new EditorWorkerClient(this._modelService,!1,"editorWorkerService",this.languageConfigurationService)),Promise.resolve(this._editorWorkerClient)}}class EditorModelManager extends Disposable{constructor(proxy,modelService,keepIdleModels){if(super(),this._syncedModels=Object.create(null),this._syncedModelsLastUsedTime=Object.create(null),this._proxy=proxy,this._modelService=modelService,!keepIdleModels){const timer=new IntervalTimer;timer.cancelAndSet((()=>this._checkStopModelSync()),Math.round(3e4)),this._register(timer)}}dispose(){for(const modelUrl in this._syncedModels)dispose(this._syncedModels[modelUrl]);this._syncedModels=Object.create(null),this._syncedModelsLastUsedTime=Object.create(null),super.dispose()}ensureSyncedResources(resources,forceLargeModels){for(const resource of resources){const resourceStr=resource.toString();this._syncedModels[resourceStr]||this._beginModelSync(resource,forceLargeModels),this._syncedModels[resourceStr]&&(this._syncedModelsLastUsedTime[resourceStr]=(new Date).getTime())}}_checkStopModelSync(){const currentTime=(new Date).getTime(),toRemove=[];for(const modelUrl in this._syncedModelsLastUsedTime){currentTime-this._syncedModelsLastUsedTime[modelUrl]>6e4&&toRemove.push(modelUrl)}for(const e of toRemove)this._stopModelSync(e)}_beginModelSync(resource,forceLargeModels){const model=this._modelService.getModel(resource);if(!model)return;if(!forceLargeModels&&model.isTooLargeForSyncing())return;const modelUrl=resource.toString();this._proxy.acceptNewModel({url:model.uri.toString(),lines:model.getLinesContent(),EOL:model.getEOL(),versionId:model.getVersionId()});const toDispose=new DisposableStore;toDispose.add(model.onDidChangeContent((e=>{this._proxy.acceptModelChanged(modelUrl.toString(),e)}))),toDispose.add(model.onWillDispose((()=>{this._stopModelSync(modelUrl)}))),toDispose.add(toDisposable((()=>{this._proxy.acceptRemovedModel(modelUrl)}))),this._syncedModels[modelUrl]=toDispose}_stopModelSync(modelUrl){const toDispose=this._syncedModels[modelUrl];delete this._syncedModels[modelUrl],delete this._syncedModelsLastUsedTime[modelUrl],dispose(toDispose)}}class SynchronousWorkerClient{constructor(instance){this._instance=instance,this._proxyObj=Promise.resolve(this._instance)}dispose(){this._instance.dispose()}getProxyObject(){return this._proxyObj}}export class EditorWorkerHost{constructor(workerClient){this._workerClient=workerClient}fhr(method,args){return this._workerClient.fhr(method,args)}}export class EditorWorkerClient extends Disposable{constructor(modelService,keepIdleModels,label,languageConfigurationService){super(),this.languageConfigurationService=languageConfigurationService,this._disposed=!1,this._modelService=modelService,this._keepIdleModels=keepIdleModels,this._workerFactory=new DefaultWorkerFactory(label),this._worker=null,this._modelManager=null}fhr(method,args){throw new Error("Not implemented!")}_getOrCreateWorker(){if(!this._worker)try{this._worker=this._register(new SimpleWorkerClient(this._workerFactory,"vs/editor/common/services/editorSimpleWorker",new EditorWorkerHost(this)))}catch(err){logOnceWebWorkerWarning(err),this._worker=new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this),null))}return this._worker}_getProxy(){return this._getOrCreateWorker().getProxyObject().then(void 0,(err=>(logOnceWebWorkerWarning(err),this._worker=new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this),null)),this._getOrCreateWorker().getProxyObject())))}_getOrCreateModelManager(proxy){return this._modelManager||(this._modelManager=this._register(new EditorModelManager(proxy,this._modelService,this._keepIdleModels))),this._modelManager}_withSyncedResources(resources,forceLargeModels=!1){return __awaiter(this,void 0,void 0,(function*(){return this._disposed?Promise.reject(canceled()):this._getProxy().then((proxy=>(this._getOrCreateModelManager(proxy).ensureSyncedResources(resources,forceLargeModels),proxy)))}))}computedUnicodeHighlights(uri,options,range){return this._withSyncedResources([uri]).then((proxy=>proxy.computeUnicodeHighlights(uri.toString(),options,range)))}computeDiff(original,modified,ignoreTrimWhitespace,maxComputationTime){return this._withSyncedResources([original,modified],!0).then((proxy=>proxy.computeDiff(original.toString(),modified.toString(),ignoreTrimWhitespace,maxComputationTime)))}computeMoreMinimalEdits(resource,edits){return this._withSyncedResources([resource]).then((proxy=>proxy.computeMoreMinimalEdits(resource.toString(),edits)))}computeLinks(resource){return this._withSyncedResources([resource]).then((proxy=>proxy.computeLinks(resource.toString())))}textualSuggest(resources,leadingWord,wordDefRegExp){return __awaiter(this,void 0,void 0,(function*(){const proxy=yield this._withSyncedResources(resources),wordDef=wordDefRegExp.source,wordDefFlags=regExpFlags(wordDefRegExp);return proxy.textualSuggest(resources.map((r=>r.toString())),leadingWord,wordDef,wordDefFlags)}))}computeWordRanges(resource,range){return this._withSyncedResources([resource]).then((proxy=>{const model=this._modelService.getModel(resource);if(!model)return Promise.resolve(null);const wordDefRegExp=this.languageConfigurationService.getLanguageConfiguration(model.getLanguageId()).getWordDefinition(),wordDef=wordDefRegExp.source,wordDefFlags=regExpFlags(wordDefRegExp);return proxy.computeWordRanges(resource.toString(),range,wordDef,wordDefFlags)}))}navigateValueSet(resource,range,up){return this._withSyncedResources([resource]).then((proxy=>{const model=this._modelService.getModel(resource);if(!model)return null;const wordDefRegExp=this.languageConfigurationService.getLanguageConfiguration(model.getLanguageId()).getWordDefinition(),wordDef=wordDefRegExp.source,wordDefFlags=regExpFlags(wordDefRegExp);return proxy.navigateValueSet(resource.toString(),range,up,wordDef,wordDefFlags)}))}dispose(){super.dispose(),this._disposed=!0}}