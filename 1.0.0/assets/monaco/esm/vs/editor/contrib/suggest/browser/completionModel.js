import{quickSelect}from"../../../../base/common/arrays.js";import{anyScore,fuzzyScore,FuzzyScore,fuzzyScoreGracefulAggressive,FuzzyScoreOptions}from"../../../../base/common/filters.js";import{compareIgnoreCase}from"../../../../base/common/strings.js";export class LineContext{constructor(leadingLineContent,characterCountDelta){this.leadingLineContent=leadingLineContent,this.characterCountDelta=characterCountDelta}}export class CompletionModel{constructor(items,column,lineContext,wordDistance,options,snippetSuggestions,fuzzyScoreOptions=FuzzyScoreOptions.default,clipboardText){this.clipboardText=clipboardText,this._snippetCompareFn=CompletionModel._compareCompletionItems,this._items=items,this._column=column,this._wordDistance=wordDistance,this._options=options,this._refilterKind=1,this._lineContext=lineContext,this._fuzzyScoreOptions=fuzzyScoreOptions,"top"===snippetSuggestions?this._snippetCompareFn=CompletionModel._compareCompletionItemsSnippetsUp:"bottom"===snippetSuggestions&&(this._snippetCompareFn=CompletionModel._compareCompletionItemsSnippetsDown)}get lineContext(){return this._lineContext}set lineContext(value){this._lineContext.leadingLineContent===value.leadingLineContent&&this._lineContext.characterCountDelta===value.characterCountDelta||(this._refilterKind=this._lineContext.characterCountDelta<value.characterCountDelta&&this._filteredItems?2:1,this._lineContext=value)}get items(){return this._ensureCachedState(),this._filteredItems}get allProvider(){return this._ensureCachedState(),this._providerInfo.keys()}get incomplete(){this._ensureCachedState();const result=new Set;for(const[provider,incomplete]of this._providerInfo)incomplete&&result.add(provider);return result}adopt(except){const res=[];for(let i=0;i<this._items.length;)except.has(this._items[i].provider)?i++:(res.push(this._items[i]),this._items[i]=this._items[this._items.length-1],this._items.pop());return this._refilterKind=1,res}get stats(){return this._ensureCachedState(),this._stats}_ensureCachedState(){0!==this._refilterKind&&this._createCachedState()}_createCachedState(){this._providerInfo=new Map;const labelLengths=[],{leadingLineContent,characterCountDelta}=this._lineContext;let word="",wordLow="";const source=1===this._refilterKind?this._items:this._filteredItems,target=[],scoreFn=!this._options.filterGraceful||source.length>2e3?fuzzyScore:fuzzyScoreGracefulAggressive;for(let i=0;i<source.length;i++){const item=source[i];if(item.isInvalid)continue;this._providerInfo.set(item.provider,Boolean(item.container.incomplete));const overwriteBefore=item.position.column-item.editStart.column,wordLen=overwriteBefore+characterCountDelta-(item.position.column-this._column);if(word.length!==wordLen&&(word=0===wordLen?"":leadingLineContent.slice(-wordLen),wordLow=word.toLowerCase()),item.word=word,0===wordLen)item.score=FuzzyScore.Default;else{let wordPos=0;for(;wordPos<overwriteBefore;){const ch=word.charCodeAt(wordPos);if(32!==ch&&9!==ch)break;wordPos+=1}if(wordPos>=wordLen)item.score=FuzzyScore.Default;else if("string"==typeof item.completion.filterText){const match=scoreFn(word,wordLow,wordPos,item.completion.filterText,item.filterTextLow,0,this._fuzzyScoreOptions);if(!match)continue;0===compareIgnoreCase(item.completion.filterText,item.textLabel)?item.score=match:(item.score=anyScore(word,wordLow,wordPos,item.textLabel,item.labelLow,0),item.score[0]=match[0])}else{const match=scoreFn(word,wordLow,wordPos,item.textLabel,item.labelLow,0,this._fuzzyScoreOptions);if(!match)continue;item.score=match}}item.idx=i,item.distance=this._wordDistance.distance(item.position,item.completion),target.push(item),labelLengths.push(item.textLabel.length)}this._filteredItems=target.sort(this._snippetCompareFn),this._refilterKind=0,this._stats={pLabelLen:labelLengths.length?quickSelect(labelLengths.length-.85,labelLengths,((a,b)=>a-b)):0}}static _compareCompletionItems(a,b){return a.score[0]>b.score[0]?-1:a.score[0]<b.score[0]?1:a.distance<b.distance?-1:a.distance>b.distance?1:a.idx<b.idx?-1:a.idx>b.idx?1:0}static _compareCompletionItemsSnippetsDown(a,b){if(a.completion.kind!==b.completion.kind){if(27===a.completion.kind)return 1;if(27===b.completion.kind)return-1}return CompletionModel._compareCompletionItems(a,b)}static _compareCompletionItemsSnippetsUp(a,b){if(a.completion.kind!==b.completion.kind){if(27===a.completion.kind)return-1;if(27===b.completion.kind)return 1}return CompletionModel._compareCompletionItems(a,b)}}