var ParameterHintState,__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{createCancelablePromise,Delayer}from"../../../../base/common/async.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Emitter}from"../../../../base/common/event.js";import{Disposable,MutableDisposable}from"../../../../base/common/lifecycle.js";import{CharacterSet}from"../../../common/core/characterClassifier.js";import*as languages from"../../../common/languages.js";import{provideSignatureHelp}from"./provideSignatureHelp.js";!function(ParameterHintState){ParameterHintState.Default={type:0};ParameterHintState.Pending=class Pending{constructor(request,previouslyActiveHints){this.request=request,this.previouslyActiveHints=previouslyActiveHints,this.type=2}};ParameterHintState.Active=class Active{constructor(hints){this.hints=hints,this.type=1}}}(ParameterHintState||(ParameterHintState={}));export class ParameterHintsModel extends Disposable{constructor(editor,providers,delay=ParameterHintsModel.DEFAULT_DELAY){super(),this._onChangedHints=this._register(new Emitter),this.onChangedHints=this._onChangedHints.event,this.triggerOnType=!1,this._state=ParameterHintState.Default,this._pendingTriggers=[],this._lastSignatureHelpResult=this._register(new MutableDisposable),this.triggerChars=new CharacterSet,this.retriggerChars=new CharacterSet,this.triggerId=0,this.editor=editor,this.providers=providers,this.throttledDelayer=new Delayer(delay),this._register(this.editor.onDidBlurEditorWidget((()=>this.cancel()))),this._register(this.editor.onDidChangeConfiguration((()=>this.onEditorConfigurationChange()))),this._register(this.editor.onDidChangeModel((e=>this.onModelChanged()))),this._register(this.editor.onDidChangeModelLanguage((_=>this.onModelChanged()))),this._register(this.editor.onDidChangeCursorSelection((e=>this.onCursorChange(e)))),this._register(this.editor.onDidChangeModelContent((e=>this.onModelContentChange()))),this._register(this.providers.onDidChange(this.onModelChanged,this)),this._register(this.editor.onDidType((text=>this.onDidType(text)))),this.onEditorConfigurationChange(),this.onModelChanged()}get state(){return this._state}set state(value){2===this._state.type&&this._state.request.cancel(),this._state=value}cancel(silent=!1){this.state=ParameterHintState.Default,this.throttledDelayer.cancel(),silent||this._onChangedHints.fire(void 0)}trigger(context,delay){const model=this.editor.getModel();if(!model||!this.providers.has(model))return;const triggerId=++this.triggerId;this._pendingTriggers.push(context),this.throttledDelayer.trigger((()=>this.doTrigger(triggerId)),delay).catch(onUnexpectedError)}next(){if(1!==this.state.type)return;const length=this.state.hints.signatures.length,activeSignature=this.state.hints.activeSignature,last=activeSignature%length==length-1,cycle=this.editor.getOption(78).cycle;!(length<2||last)||cycle?this.updateActiveSignature(last&&cycle?0:activeSignature+1):this.cancel()}previous(){if(1!==this.state.type)return;const length=this.state.hints.signatures.length,activeSignature=this.state.hints.activeSignature,first=0===activeSignature,cycle=this.editor.getOption(78).cycle;!(length<2||first)||cycle?this.updateActiveSignature(first&&cycle?length-1:activeSignature-1):this.cancel()}updateActiveSignature(activeSignature){1===this.state.type&&(this.state=new ParameterHintState.Active(Object.assign(Object.assign({},this.state.hints),{activeSignature})),this._onChangedHints.fire(this.state.hints))}doTrigger(triggerId){return __awaiter(this,void 0,void 0,(function*(){const isRetrigger=1===this.state.type||2===this.state.type,activeSignatureHelp=this.getLastActiveHints();if(this.cancel(!0),0===this._pendingTriggers.length)return!1;const context=this._pendingTriggers.reduce(mergeTriggerContexts);this._pendingTriggers=[];const triggerContext={triggerKind:context.triggerKind,triggerCharacter:context.triggerCharacter,isRetrigger,activeSignatureHelp};if(!this.editor.hasModel())return!1;const model=this.editor.getModel(),position=this.editor.getPosition();this.state=new ParameterHintState.Pending(createCancelablePromise((token=>provideSignatureHelp(this.providers,model,position,triggerContext,token))),activeSignatureHelp);try{const result=yield this.state.request;return triggerId!==this.triggerId?(null==result||result.dispose(),!1):result&&result.value.signatures&&0!==result.value.signatures.length?(this.state=new ParameterHintState.Active(result.value),this._lastSignatureHelpResult.value=result,this._onChangedHints.fire(this.state.hints),!0):(null==result||result.dispose(),this._lastSignatureHelpResult.clear(),this.cancel(),!1)}catch(error){return triggerId===this.triggerId&&(this.state=ParameterHintState.Default),onUnexpectedError(error),!1}}))}getLastActiveHints(){switch(this.state.type){case 1:return this.state.hints;case 2:return this.state.previouslyActiveHints;default:return}}get isTriggered(){return 1===this.state.type||2===this.state.type||this.throttledDelayer.isTriggered()}onModelChanged(){this.cancel(),this.triggerChars=new CharacterSet,this.retriggerChars=new CharacterSet;const model=this.editor.getModel();if(model)for(const support of this.providers.ordered(model)){for(const ch of support.signatureHelpTriggerCharacters||[])this.triggerChars.add(ch.charCodeAt(0)),this.retriggerChars.add(ch.charCodeAt(0));for(const ch of support.signatureHelpRetriggerCharacters||[])this.retriggerChars.add(ch.charCodeAt(0))}}onDidType(text){if(!this.triggerOnType)return;const lastCharIndex=text.length-1,triggerCharCode=text.charCodeAt(lastCharIndex);(this.triggerChars.has(triggerCharCode)||this.isTriggered&&this.retriggerChars.has(triggerCharCode))&&this.trigger({triggerKind:languages.SignatureHelpTriggerKind.TriggerCharacter,triggerCharacter:text.charAt(lastCharIndex)})}onCursorChange(e){"mouse"===e.source?this.cancel():this.isTriggered&&this.trigger({triggerKind:languages.SignatureHelpTriggerKind.ContentChange})}onModelContentChange(){this.isTriggered&&this.trigger({triggerKind:languages.SignatureHelpTriggerKind.ContentChange})}onEditorConfigurationChange(){this.triggerOnType=this.editor.getOption(78).enabled,this.triggerOnType||this.cancel()}dispose(){this.cancel(!0),super.dispose()}}function mergeTriggerContexts(previous,current){switch(current.triggerKind){case languages.SignatureHelpTriggerKind.Invoke:return current;case languages.SignatureHelpTriggerKind.ContentChange:return previous;case languages.SignatureHelpTriggerKind.TriggerCharacter:default:return current}}ParameterHintsModel.DEFAULT_DELAY=120;