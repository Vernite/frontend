var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}};import{Emitter}from"../../../../base/common/event.js";import{combinedDisposable,DisposableStore,dispose}from"../../../../base/common/lifecycle.js";import{isEqual}from"../../../../base/common/resources.js";import{EditorCommand,registerEditorCommand}from"../../../browser/editorExtensions.js";import{ICodeEditorService}from"../../../browser/services/codeEditorService.js";import{Range}from"../../../common/core/range.js";import{localize}from"../../../../nls.js";import{IContextKeyService,RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";import{registerSingleton}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService}from"../../../../platform/keybinding/common/keybinding.js";import{KeybindingsRegistry}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{INotificationService}from"../../../../platform/notification/common/notification.js";export const ctxHasSymbols=new RawContextKey("hasSymbols",!1,localize("hasSymbols","Whether there are symbol locations that can be navigated via keyboard-only."));export const ISymbolNavigationService=createDecorator("ISymbolNavigationService");let SymbolNavigationService=class SymbolNavigationService{constructor(contextKeyService,_editorService,_notificationService,_keybindingService){this._editorService=_editorService,this._notificationService=_notificationService,this._keybindingService=_keybindingService,this._currentModel=void 0,this._currentIdx=-1,this._ignoreEditorChange=!1,this._ctxHasSymbols=ctxHasSymbols.bindTo(contextKeyService)}reset(){var _a,_b;this._ctxHasSymbols.reset(),null===(_a=this._currentState)||void 0===_a||_a.dispose(),null===(_b=this._currentMessage)||void 0===_b||_b.dispose(),this._currentModel=void 0,this._currentIdx=-1}put(anchor){const refModel=anchor.parent.parent;if(refModel.references.length<=1)return void this.reset();this._currentModel=refModel,this._currentIdx=refModel.references.indexOf(anchor),this._ctxHasSymbols.set(!0),this._showMessage();const editorState=new EditorState(this._editorService),listener=editorState.onDidChange((_=>{if(this._ignoreEditorChange)return;const editor=this._editorService.getActiveCodeEditor();if(!editor)return;const model=editor.getModel(),position=editor.getPosition();if(!model||!position)return;let seenUri=!1,seenPosition=!1;for(const reference of refModel.references)if(isEqual(reference.uri,model.uri))seenUri=!0,seenPosition=seenPosition||Range.containsPosition(reference.range,position);else if(seenUri)break;seenUri&&seenPosition||this.reset()}));this._currentState=combinedDisposable(editorState,listener)}revealNext(source){if(!this._currentModel)return Promise.resolve();this._currentIdx+=1,this._currentIdx%=this._currentModel.references.length;const reference=this._currentModel.references[this._currentIdx];return this._showMessage(),this._ignoreEditorChange=!0,this._editorService.openCodeEditor({resource:reference.uri,options:{selection:Range.collapseToStart(reference.range),selectionRevealType:3}},source).finally((()=>{this._ignoreEditorChange=!1}))}_showMessage(){var _a;null===(_a=this._currentMessage)||void 0===_a||_a.dispose();const kb=this._keybindingService.lookupKeybinding("editor.gotoNextSymbolFromResult"),message=kb?localize("location.kb","Symbol {0} of {1}, {2} for next",this._currentIdx+1,this._currentModel.references.length,kb.getLabel()):localize("location","Symbol {0} of {1}",this._currentIdx+1,this._currentModel.references.length);this._currentMessage=this._notificationService.status(message)}};SymbolNavigationService=__decorate([__param(0,IContextKeyService),__param(1,ICodeEditorService),__param(2,INotificationService),__param(3,IKeybindingService)],SymbolNavigationService),registerSingleton(ISymbolNavigationService,SymbolNavigationService,!0),registerEditorCommand(new class extends EditorCommand{constructor(){super({id:"editor.gotoNextSymbolFromResult",precondition:ctxHasSymbols,kbOpts:{weight:100,primary:70}})}runEditorCommand(accessor,editor){return accessor.get(ISymbolNavigationService).revealNext(editor)}}),KeybindingsRegistry.registerCommandAndKeybindingRule({id:"editor.gotoNextSymbolFromResult.cancel",weight:100,when:ctxHasSymbols,primary:9,handler(accessor){accessor.get(ISymbolNavigationService).reset()}});let EditorState=class EditorState{constructor(editorService){this._listener=new Map,this._disposables=new DisposableStore,this._onDidChange=new Emitter,this.onDidChange=this._onDidChange.event,this._disposables.add(editorService.onCodeEditorRemove(this._onDidRemoveEditor,this)),this._disposables.add(editorService.onCodeEditorAdd(this._onDidAddEditor,this)),editorService.listCodeEditors().forEach(this._onDidAddEditor,this)}dispose(){this._disposables.dispose(),this._onDidChange.dispose(),dispose(this._listener.values())}_onDidAddEditor(editor){this._listener.set(editor,combinedDisposable(editor.onDidChangeCursorPosition((_=>this._onDidChange.fire({editor}))),editor.onDidChangeModelContent((_=>this._onDidChange.fire({editor})))))}_onDidRemoveEditor(editor){var _a;null===(_a=this._listener.get(editor))||void 0===_a||_a.dispose(),this._listener.delete(editor)}};EditorState=__decorate([__param(0,ICodeEditorService)],EditorState);