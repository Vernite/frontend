import{arrayInsert}from"../../../base/common/arrays.js";import{toUint32}from"../../../base/common/uint.js";export class PrefixSumComputer{constructor(values){this.values=values,this.prefixSum=new Uint32Array(values.length),this.prefixSumValidIndex=new Int32Array(1),this.prefixSumValidIndex[0]=-1}insertValues(insertIndex,insertValues){insertIndex=toUint32(insertIndex);const oldValues=this.values,oldPrefixSum=this.prefixSum,insertValuesLen=insertValues.length;return 0!==insertValuesLen&&(this.values=new Uint32Array(oldValues.length+insertValuesLen),this.values.set(oldValues.subarray(0,insertIndex),0),this.values.set(oldValues.subarray(insertIndex),insertIndex+insertValuesLen),this.values.set(insertValues,insertIndex),insertIndex-1<this.prefixSumValidIndex[0]&&(this.prefixSumValidIndex[0]=insertIndex-1),this.prefixSum=new Uint32Array(this.values.length),this.prefixSumValidIndex[0]>=0&&this.prefixSum.set(oldPrefixSum.subarray(0,this.prefixSumValidIndex[0]+1)),!0)}setValue(index,value){return index=toUint32(index),value=toUint32(value),this.values[index]!==value&&(this.values[index]=value,index-1<this.prefixSumValidIndex[0]&&(this.prefixSumValidIndex[0]=index-1),!0)}removeValues(startIndex,count){startIndex=toUint32(startIndex),count=toUint32(count);const oldValues=this.values,oldPrefixSum=this.prefixSum;if(startIndex>=oldValues.length)return!1;const maxCount=oldValues.length-startIndex;return count>=maxCount&&(count=maxCount),0!==count&&(this.values=new Uint32Array(oldValues.length-count),this.values.set(oldValues.subarray(0,startIndex),0),this.values.set(oldValues.subarray(startIndex+count),startIndex),this.prefixSum=new Uint32Array(this.values.length),startIndex-1<this.prefixSumValidIndex[0]&&(this.prefixSumValidIndex[0]=startIndex-1),this.prefixSumValidIndex[0]>=0&&this.prefixSum.set(oldPrefixSum.subarray(0,this.prefixSumValidIndex[0]+1)),!0)}getTotalSum(){return 0===this.values.length?0:this._getPrefixSum(this.values.length-1)}getPrefixSum(index){return index<0?0:(index=toUint32(index),this._getPrefixSum(index))}_getPrefixSum(index){if(index<=this.prefixSumValidIndex[0])return this.prefixSum[index];let startIndex=this.prefixSumValidIndex[0]+1;0===startIndex&&(this.prefixSum[0]=this.values[0],startIndex++),index>=this.values.length&&(index=this.values.length-1);for(let i=startIndex;i<=index;i++)this.prefixSum[i]=this.prefixSum[i-1]+this.values[i];return this.prefixSumValidIndex[0]=Math.max(this.prefixSumValidIndex[0],index),this.prefixSum[index]}getIndexOf(sum){sum=Math.floor(sum),this.getTotalSum();let low=0,high=this.values.length-1,mid=0,midStop=0,midStart=0;for(;low<=high;)if(mid=low+(high-low)/2|0,midStop=this.prefixSum[mid],midStart=midStop-this.values[mid],sum<midStart)high=mid-1;else{if(!(sum>=midStop))break;low=mid+1}return new PrefixSumIndexOfResult(mid,sum-midStart)}}export class ConstantTimePrefixSumComputer{constructor(values){this._values=values,this._isValid=!1,this._validEndIndex=-1,this._prefixSum=[],this._indexBySum=[]}getTotalSum(){return this._ensureValid(),this._indexBySum.length}getPrefixSum(count){return this._ensureValid(),0===count?0:this._prefixSum[count-1]}getIndexOf(sum){this._ensureValid();const idx=this._indexBySum[sum],viewLinesAbove=idx>0?this._prefixSum[idx-1]:0;return new PrefixSumIndexOfResult(idx,sum-viewLinesAbove)}removeValues(start,deleteCount){this._values.splice(start,deleteCount),this._invalidate(start)}insertValues(insertIndex,insertArr){this._values=arrayInsert(this._values,insertIndex,insertArr),this._invalidate(insertIndex)}_invalidate(index){this._isValid=!1,this._validEndIndex=Math.min(this._validEndIndex,index-1)}_ensureValid(){if(!this._isValid){for(let i=this._validEndIndex+1,len=this._values.length;i<len;i++){const value=this._values[i],sumAbove=i>0?this._prefixSum[i-1]:0;this._prefixSum[i]=sumAbove+value;for(let j=0;j<value;j++)this._indexBySum[sumAbove+j]=i}this._prefixSum.length=this._values.length,this._indexBySum.length=this._prefixSum[this._prefixSum.length-1],this._isValid=!0,this._validEndIndex=this._values.length-1}}setValue(index,value){this._values[index]!==value&&(this._values[index]=value,this._invalidate(index))}}export class PrefixSumIndexOfResult{constructor(index,remainder){this.index=index,this.remainder=remainder,this._prefixSumIndexOfResultBrand=void 0,this.index=index,this.remainder=remainder}}