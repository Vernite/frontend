import*as dom from"../../dom.js";import{createFastDomNode}from"../../fastDomNode.js";import{GlobalPointerMoveMonitor}from"../../globalPointerMoveMonitor.js";import{ScrollbarArrow}from"./scrollbarArrow.js";import{ScrollbarVisibilityController}from"./scrollbarVisibilityController.js";import{Widget}from"../widget.js";import*as platform from"../../../common/platform.js";const POINTER_DRAG_RESET_DISTANCE=140;export class AbstractScrollbar extends Widget{constructor(opts){super(),this._lazyRender=opts.lazyRender,this._host=opts.host,this._scrollable=opts.scrollable,this._scrollByPage=opts.scrollByPage,this._scrollbarState=opts.scrollbarState,this._visibilityController=this._register(new ScrollbarVisibilityController(opts.visibility,"visible scrollbar "+opts.extraScrollbarClassName,"invisible scrollbar "+opts.extraScrollbarClassName)),this._visibilityController.setIsNeeded(this._scrollbarState.isNeeded()),this._pointerMoveMonitor=this._register(new GlobalPointerMoveMonitor),this._shouldRender=!0,this.domNode=createFastDomNode(document.createElement("div")),this.domNode.setAttribute("role","presentation"),this.domNode.setAttribute("aria-hidden","true"),this._visibilityController.setDomNode(this.domNode),this.domNode.setPosition("absolute"),this._register(dom.addDisposableListener(this.domNode.domNode,dom.EventType.POINTER_DOWN,(e=>this._domNodePointerDown(e))))}_createArrow(opts){const arrow=this._register(new ScrollbarArrow(opts));this.domNode.domNode.appendChild(arrow.bgDomNode),this.domNode.domNode.appendChild(arrow.domNode)}_createSlider(top,left,width,height){this.slider=createFastDomNode(document.createElement("div")),this.slider.setClassName("slider"),this.slider.setPosition("absolute"),this.slider.setTop(top),this.slider.setLeft(left),"number"==typeof width&&this.slider.setWidth(width),"number"==typeof height&&this.slider.setHeight(height),this.slider.setLayerHinting(!0),this.slider.setContain("strict"),this.domNode.domNode.appendChild(this.slider.domNode),this._register(dom.addDisposableListener(this.slider.domNode,dom.EventType.POINTER_DOWN,(e=>{0===e.button&&(e.preventDefault(),this._sliderPointerDown(e))}))),this.onclick(this.slider.domNode,(e=>{e.leftButton&&e.stopPropagation()}))}_onElementSize(visibleSize){return this._scrollbarState.setVisibleSize(visibleSize)&&(this._visibilityController.setIsNeeded(this._scrollbarState.isNeeded()),this._shouldRender=!0,this._lazyRender||this.render()),this._shouldRender}_onElementScrollSize(elementScrollSize){return this._scrollbarState.setScrollSize(elementScrollSize)&&(this._visibilityController.setIsNeeded(this._scrollbarState.isNeeded()),this._shouldRender=!0,this._lazyRender||this.render()),this._shouldRender}_onElementScrollPosition(elementScrollPosition){return this._scrollbarState.setScrollPosition(elementScrollPosition)&&(this._visibilityController.setIsNeeded(this._scrollbarState.isNeeded()),this._shouldRender=!0,this._lazyRender||this.render()),this._shouldRender}beginReveal(){this._visibilityController.setShouldBeVisible(!0)}beginHide(){this._visibilityController.setShouldBeVisible(!1)}render(){this._shouldRender&&(this._shouldRender=!1,this._renderDomNode(this._scrollbarState.getRectangleLargeSize(),this._scrollbarState.getRectangleSmallSize()),this._updateSlider(this._scrollbarState.getSliderSize(),this._scrollbarState.getArrowSize()+this._scrollbarState.getSliderPosition()))}_domNodePointerDown(e){e.target===this.domNode.domNode&&this._onPointerDown(e)}delegatePointerDown(e){const domTop=this.domNode.domNode.getClientRects()[0].top,sliderStart=domTop+this._scrollbarState.getSliderPosition(),sliderStop=domTop+this._scrollbarState.getSliderPosition()+this._scrollbarState.getSliderSize(),pointerPos=this._sliderPointerPosition(e);sliderStart<=pointerPos&&pointerPos<=sliderStop?0===e.button&&(e.preventDefault(),this._sliderPointerDown(e)):this._onPointerDown(e)}_onPointerDown(e){let offsetX,offsetY;if(e.target===this.domNode.domNode&&"number"==typeof e.offsetX&&"number"==typeof e.offsetY)offsetX=e.offsetX,offsetY=e.offsetY;else{const domNodePosition=dom.getDomNodePagePosition(this.domNode.domNode);offsetX=e.pageX-domNodePosition.left,offsetY=e.pageY-domNodePosition.top}const offset=this._pointerDownRelativePosition(offsetX,offsetY);this._setDesiredScrollPositionNow(this._scrollByPage?this._scrollbarState.getDesiredScrollPositionFromOffsetPaged(offset):this._scrollbarState.getDesiredScrollPositionFromOffset(offset)),0===e.button&&(e.preventDefault(),this._sliderPointerDown(e))}_sliderPointerDown(e){if(!(e.target&&e.target instanceof Element))return;const initialPointerPosition=this._sliderPointerPosition(e),initialPointerOrthogonalPosition=this._sliderOrthogonalPointerPosition(e),initialScrollbarState=this._scrollbarState.clone();this.slider.toggleClassName("active",!0),this._pointerMoveMonitor.startMonitoring(e.target,e.pointerId,e.buttons,(pointerMoveData=>{const pointerOrthogonalPosition=this._sliderOrthogonalPointerPosition(pointerMoveData),pointerOrthogonalDelta=Math.abs(pointerOrthogonalPosition-initialPointerOrthogonalPosition);if(platform.isWindows&&pointerOrthogonalDelta>140)return void this._setDesiredScrollPositionNow(initialScrollbarState.getScrollPosition());const pointerDelta=this._sliderPointerPosition(pointerMoveData)-initialPointerPosition;this._setDesiredScrollPositionNow(initialScrollbarState.getDesiredScrollPositionFromDelta(pointerDelta))}),(()=>{this.slider.toggleClassName("active",!1),this._host.onDragEnd()})),this._host.onDragStart()}_setDesiredScrollPositionNow(_desiredScrollPosition){const desiredScrollPosition={};this.writeScrollPosition(desiredScrollPosition,_desiredScrollPosition),this._scrollable.setScrollPositionNow(desiredScrollPosition)}updateScrollbarSize(scrollbarSize){this._updateScrollbarSize(scrollbarSize),this._scrollbarState.setScrollbarSize(scrollbarSize),this._shouldRender=!0,this._lazyRender||this.render()}isNeeded(){return this._scrollbarState.isNeeded()}}