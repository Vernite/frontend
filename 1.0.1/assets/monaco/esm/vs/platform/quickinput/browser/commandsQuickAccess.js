var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{toErrorMessage}from"../../../base/common/errorMessage.js";import{isCancellationError}from"../../../base/common/errors.js";import{matchesContiguousSubString,matchesPrefix,matchesWords,or}from"../../../base/common/filters.js";import{Disposable}from"../../../base/common/lifecycle.js";import{LRUCache}from"../../../base/common/map.js";import Severity from"../../../base/common/severity.js";import{withNullAsUndefined}from"../../../base/common/types.js";import{localize}from"../../../nls.js";import{ICommandService}from"../../commands/common/commands.js";import{IConfigurationService}from"../../configuration/common/configuration.js";import{IDialogService}from"../../dialogs/common/dialogs.js";import{IInstantiationService}from"../../instantiation/common/instantiation.js";import{IKeybindingService}from"../../keybinding/common/keybinding.js";import{PickerQuickAccessProvider}from"./pickerQuickAccess.js";import{IStorageService}from"../../storage/common/storage.js";import{ITelemetryService}from"../../telemetry/common/telemetry.js";let AbstractCommandsQuickAccessProvider=class AbstractCommandsQuickAccessProvider extends PickerQuickAccessProvider{constructor(options,instantiationService,keybindingService,commandService,telemetryService,dialogService){super(AbstractCommandsQuickAccessProvider.PREFIX,options),this.instantiationService=instantiationService,this.keybindingService=keybindingService,this.commandService=commandService,this.telemetryService=telemetryService,this.dialogService=dialogService,this.commandsHistory=this._register(this.instantiationService.createInstance(CommandsHistory)),this.options=options}_getPicks(filter,disposables,token){return __awaiter(this,void 0,void 0,(function*(){const allCommandPicks=yield this.getCommandPicks(disposables,token);if(token.isCancellationRequested)return[];const filteredCommandPicks=[];for(const commandPick of allCommandPicks){const labelHighlights=withNullAsUndefined(AbstractCommandsQuickAccessProvider.WORD_FILTER(filter,commandPick.label)),aliasHighlights=commandPick.commandAlias?withNullAsUndefined(AbstractCommandsQuickAccessProvider.WORD_FILTER(filter,commandPick.commandAlias)):void 0;labelHighlights||aliasHighlights?(commandPick.highlights={label:labelHighlights,detail:this.options.showAlias?aliasHighlights:void 0},filteredCommandPicks.push(commandPick)):filter===commandPick.commandId&&filteredCommandPicks.push(commandPick)}const mapLabelToCommand=new Map;for(const commandPick of filteredCommandPicks){const existingCommandForLabel=mapLabelToCommand.get(commandPick.label);existingCommandForLabel?(commandPick.description=commandPick.commandId,existingCommandForLabel.description=existingCommandForLabel.commandId):mapLabelToCommand.set(commandPick.label,commandPick)}filteredCommandPicks.sort(((commandPickA,commandPickB)=>{const commandACounter=this.commandsHistory.peek(commandPickA.commandId),commandBCounter=this.commandsHistory.peek(commandPickB.commandId);return commandACounter&&commandBCounter?commandACounter>commandBCounter?-1:1:commandACounter?-1:commandBCounter?1:commandPickA.label.localeCompare(commandPickB.label)}));const commandPicks=[];let addSeparator=!1;for(let i=0;i<filteredCommandPicks.length;i++){const commandPick=filteredCommandPicks[i],keybinding=this.keybindingService.lookupKeybinding(commandPick.commandId),ariaLabel=keybinding?localize("commandPickAriaLabelWithKeybinding","{0}, {1}",commandPick.label,keybinding.getAriaLabel()):commandPick.label;0===i&&this.commandsHistory.peek(commandPick.commandId)&&(commandPicks.push({type:"separator",label:localize("recentlyUsed","recently used")}),addSeparator=!0),0!==i&&addSeparator&&!this.commandsHistory.peek(commandPick.commandId)&&(commandPicks.push({type:"separator",label:localize("morecCommands","other commands")}),addSeparator=!1),commandPicks.push(Object.assign(Object.assign({},commandPick),{ariaLabel,detail:this.options.showAlias&&commandPick.commandAlias!==commandPick.label?commandPick.commandAlias:void 0,keybinding,accept:()=>__awaiter(this,void 0,void 0,(function*(){this.commandsHistory.push(commandPick.commandId),this.telemetryService.publicLog2("workbenchActionExecuted",{id:commandPick.commandId,from:"quick open"});try{yield this.commandService.executeCommand(commandPick.commandId)}catch(error){isCancellationError(error)||this.dialogService.show(Severity.Error,localize("canNotRun","Command '{0}' resulted in an error ({1})",commandPick.label,toErrorMessage(error)))}}))}))}return commandPicks}))}};AbstractCommandsQuickAccessProvider.PREFIX=">",AbstractCommandsQuickAccessProvider.WORD_FILTER=or(matchesPrefix,matchesWords,matchesContiguousSubString),AbstractCommandsQuickAccessProvider=__decorate([__param(1,IInstantiationService),__param(2,IKeybindingService),__param(3,ICommandService),__param(4,ITelemetryService),__param(5,IDialogService)],AbstractCommandsQuickAccessProvider);export{AbstractCommandsQuickAccessProvider};let CommandsHistory=class CommandsHistory extends Disposable{constructor(storageService,configurationService){super(),this.storageService=storageService,this.configurationService=configurationService,this.configuredCommandsHistoryLength=0,this.updateConfiguration(),this.load(),this.registerListeners()}registerListeners(){this._register(this.configurationService.onDidChangeConfiguration((()=>this.updateConfiguration())))}updateConfiguration(){this.configuredCommandsHistoryLength=CommandsHistory.getConfiguredCommandHistoryLength(this.configurationService),CommandsHistory.cache&&CommandsHistory.cache.limit!==this.configuredCommandsHistoryLength&&(CommandsHistory.cache.limit=this.configuredCommandsHistoryLength,CommandsHistory.saveState(this.storageService))}load(){const raw=this.storageService.get(CommandsHistory.PREF_KEY_CACHE,0);let serializedCache;if(raw)try{serializedCache=JSON.parse(raw)}catch(error){}const cache=CommandsHistory.cache=new LRUCache(this.configuredCommandsHistoryLength,1);if(serializedCache){let entries;entries=serializedCache.usesLRU?serializedCache.entries:serializedCache.entries.sort(((a,b)=>a.value-b.value)),entries.forEach((entry=>cache.set(entry.key,entry.value)))}CommandsHistory.counter=this.storageService.getNumber(CommandsHistory.PREF_KEY_COUNTER,0,CommandsHistory.counter)}push(commandId){CommandsHistory.cache&&(CommandsHistory.cache.set(commandId,CommandsHistory.counter++),CommandsHistory.saveState(this.storageService))}peek(commandId){var _a;return null===(_a=CommandsHistory.cache)||void 0===_a?void 0:_a.peek(commandId)}static saveState(storageService){if(!CommandsHistory.cache)return;const serializedCache={usesLRU:!0,entries:[]};CommandsHistory.cache.forEach(((value,key)=>serializedCache.entries.push({key,value}))),storageService.store(CommandsHistory.PREF_KEY_CACHE,JSON.stringify(serializedCache),0,0),storageService.store(CommandsHistory.PREF_KEY_COUNTER,CommandsHistory.counter,0,0)}static getConfiguredCommandHistoryLength(configurationService){var _a,_b;const configuredCommandHistoryLength=null===(_b=null===(_a=configurationService.getValue().workbench)||void 0===_a?void 0:_a.commandPalette)||void 0===_b?void 0:_b.history;return"number"==typeof configuredCommandHistoryLength?configuredCommandHistoryLength:CommandsHistory.DEFAULT_COMMANDS_HISTORY_LENGTH}};CommandsHistory.DEFAULT_COMMANDS_HISTORY_LENGTH=50,CommandsHistory.PREF_KEY_CACHE="commandPalette.mru.cache",CommandsHistory.PREF_KEY_COUNTER="commandPalette.mru.counter",CommandsHistory.counter=1,CommandsHistory=__decorate([__param(0,IStorageService),__param(1,IConfigurationService)],CommandsHistory);export{CommandsHistory};