import{createFastDomNode}from"../../../../base/browser/fastDomNode.js";import{Color}from"../../../../base/common/color.js";import{ViewPart}from"../../view/viewPart.js";import{Position}from"../../../common/core/position.js";import{TokenizationRegistry}from"../../../common/languages.js";import{editorCursorForeground,editorOverviewRulerBorder,editorOverviewRulerBackground}from"../../../common/core/editorColorRegistry.js";import{OverviewRulerDecorationsGroup}from"../../../common/viewModel.js";class Settings{constructor(config,theme){const options=config.options;this.lineHeight=options.get(61),this.pixelRatio=options.get(131),this.overviewRulerLanes=options.get(76),this.renderBorder=options.get(75);const borderColor=theme.getColor(editorOverviewRulerBorder);this.borderColor=borderColor?borderColor.toString():null,this.hideCursor=options.get(54);const cursorColor=theme.getColor(editorCursorForeground);this.cursorColor=cursorColor?cursorColor.transparent(.7).toString():null,this.themeType=theme.type;const minimapOpts=options.get(67),minimapEnabled=minimapOpts.enabled,minimapSide=minimapOpts.side,themeColor=theme.getColor(editorOverviewRulerBackground),defaultBackground=TokenizationRegistry.getDefaultBackground();let backgroundColor=null;void 0!==themeColor?backgroundColor=themeColor:minimapEnabled&&(backgroundColor=defaultBackground),this.backgroundColor=null===backgroundColor||"left"===minimapSide?null:Color.Format.CSS.formatHex(backgroundColor);const position=options.get(133).overviewRuler;this.top=position.top,this.right=position.right,this.domWidth=position.width,this.domHeight=position.height,0===this.overviewRulerLanes?(this.canvasWidth=0,this.canvasHeight=0):(this.canvasWidth=this.domWidth*this.pixelRatio|0,this.canvasHeight=this.domHeight*this.pixelRatio|0);const[x,w]=this._initLanes(1,this.canvasWidth,this.overviewRulerLanes);this.x=x,this.w=w}_initLanes(canvasLeftOffset,canvasWidth,laneCount){const remainingWidth=canvasWidth-canvasLeftOffset;if(laneCount>=3){const leftWidth=Math.floor(remainingWidth/3),rightWidth=Math.floor(remainingWidth/3),centerWidth=remainingWidth-leftWidth-rightWidth,centerOffset=canvasLeftOffset+leftWidth;return[[0,canvasLeftOffset,centerOffset,canvasLeftOffset,canvasLeftOffset+leftWidth+centerWidth,canvasLeftOffset,centerOffset,canvasLeftOffset],[0,leftWidth,centerWidth,leftWidth+centerWidth,rightWidth,leftWidth+centerWidth+rightWidth,centerWidth+rightWidth,leftWidth+centerWidth+rightWidth]]}if(2===laneCount){const leftWidth=Math.floor(remainingWidth/2),rightWidth=remainingWidth-leftWidth;return[[0,canvasLeftOffset,canvasLeftOffset,canvasLeftOffset,canvasLeftOffset+leftWidth,canvasLeftOffset,canvasLeftOffset,canvasLeftOffset],[0,leftWidth,leftWidth,leftWidth,rightWidth,leftWidth+rightWidth,leftWidth+rightWidth,leftWidth+rightWidth]]}return[[0,canvasLeftOffset,canvasLeftOffset,canvasLeftOffset,canvasLeftOffset,canvasLeftOffset,canvasLeftOffset,canvasLeftOffset],[0,remainingWidth,remainingWidth,remainingWidth,remainingWidth,remainingWidth,remainingWidth,remainingWidth]]}equals(other){return this.lineHeight===other.lineHeight&&this.pixelRatio===other.pixelRatio&&this.overviewRulerLanes===other.overviewRulerLanes&&this.renderBorder===other.renderBorder&&this.borderColor===other.borderColor&&this.hideCursor===other.hideCursor&&this.cursorColor===other.cursorColor&&this.themeType===other.themeType&&this.backgroundColor===other.backgroundColor&&this.top===other.top&&this.right===other.right&&this.domWidth===other.domWidth&&this.domHeight===other.domHeight&&this.canvasWidth===other.canvasWidth&&this.canvasHeight===other.canvasHeight}}export class DecorationsOverviewRuler extends ViewPart{constructor(context){super(context),this._domNode=createFastDomNode(document.createElement("canvas")),this._domNode.setClassName("decorationsOverviewRuler"),this._domNode.setPosition("absolute"),this._domNode.setLayerHinting(!0),this._domNode.setContain("strict"),this._domNode.setAttribute("aria-hidden","true"),this._updateSettings(!1),this._tokensColorTrackerListener=TokenizationRegistry.onDidChange((e=>{e.changedColorMap&&this._updateSettings(!0)})),this._cursorPositions=[]}dispose(){super.dispose(),this._tokensColorTrackerListener.dispose()}_updateSettings(renderNow){const newSettings=new Settings(this._context.configuration,this._context.theme);return(!this._settings||!this._settings.equals(newSettings))&&(this._settings=newSettings,this._domNode.setTop(this._settings.top),this._domNode.setRight(this._settings.right),this._domNode.setWidth(this._settings.domWidth),this._domNode.setHeight(this._settings.domHeight),this._domNode.domNode.width=this._settings.canvasWidth,this._domNode.domNode.height=this._settings.canvasHeight,renderNow&&this._render(),!0)}onConfigurationChanged(e){return this._updateSettings(!1)}onCursorStateChanged(e){this._cursorPositions=[];for(let i=0,len=e.selections.length;i<len;i++)this._cursorPositions[i]=e.selections[i].getPosition();return this._cursorPositions.sort(Position.compare),!0}onDecorationsChanged(e){return!!e.affectsOverviewRuler}onFlushed(e){return!0}onScrollChanged(e){return e.scrollHeightChanged}onZonesChanged(e){return!0}onThemeChanged(e){return this._updateSettings(!1)}getDomNode(){return this._domNode.domNode}prepareRender(ctx){}render(editorCtx){this._render()}_render(){if(0===this._settings.overviewRulerLanes)return this._domNode.setBackgroundColor(this._settings.backgroundColor?this._settings.backgroundColor:""),void this._domNode.setDisplay("none");this._domNode.setDisplay("block");const canvasWidth=this._settings.canvasWidth,canvasHeight=this._settings.canvasHeight,lineHeight=this._settings.lineHeight,viewLayout=this._context.viewLayout,heightRatio=canvasHeight/this._context.viewLayout.getScrollHeight(),decorations=this._context.viewModel.getAllOverviewRulerDecorations(this._context.theme),minDecorationHeight=6*this._settings.pixelRatio|0,halfMinDecorationHeight=minDecorationHeight/2|0,canvasCtx=this._domNode.domNode.getContext("2d");null===this._settings.backgroundColor?canvasCtx.clearRect(0,0,canvasWidth,canvasHeight):(canvasCtx.fillStyle=this._settings.backgroundColor,canvasCtx.fillRect(0,0,canvasWidth,canvasHeight));const x=this._settings.x,w=this._settings.w;decorations.sort(OverviewRulerDecorationsGroup.cmp);for(const decorationGroup of decorations){const color=decorationGroup.color,decorationGroupData=decorationGroup.data;canvasCtx.fillStyle=color;let prevLane=0,prevY1=0,prevY2=0;for(let i=0,len=decorationGroupData.length/3;i<len;i++){const lane=decorationGroupData[3*i],startLineNumber=decorationGroupData[3*i+1],endLineNumber=decorationGroupData[3*i+2];let y1=viewLayout.getVerticalOffsetForLineNumber(startLineNumber)*heightRatio|0,y2=(viewLayout.getVerticalOffsetForLineNumber(endLineNumber)+lineHeight)*heightRatio|0;if(y2-y1<minDecorationHeight){let yCenter=(y1+y2)/2|0;yCenter<halfMinDecorationHeight?yCenter=halfMinDecorationHeight:yCenter+halfMinDecorationHeight>canvasHeight&&(yCenter=canvasHeight-halfMinDecorationHeight),y1=yCenter-halfMinDecorationHeight,y2=yCenter+halfMinDecorationHeight}y1>prevY2+1||lane!==prevLane?(0!==i&&canvasCtx.fillRect(x[prevLane],prevY1,w[prevLane],prevY2-prevY1),prevLane=lane,prevY1=y1,prevY2=y2):y2>prevY2&&(prevY2=y2)}canvasCtx.fillRect(x[prevLane],prevY1,w[prevLane],prevY2-prevY1)}if(!this._settings.hideCursor&&this._settings.cursorColor){const cursorHeight=2*this._settings.pixelRatio|0,halfCursorHeight=cursorHeight/2|0,cursorX=this._settings.x[7],cursorW=this._settings.w[7];canvasCtx.fillStyle=this._settings.cursorColor;let prevY1=-100,prevY2=-100;for(let i=0,len=this._cursorPositions.length;i<len;i++){const cursor=this._cursorPositions[i];let yCenter=viewLayout.getVerticalOffsetForLineNumber(cursor.lineNumber)*heightRatio|0;yCenter<halfCursorHeight?yCenter=halfCursorHeight:yCenter+halfCursorHeight>canvasHeight&&(yCenter=canvasHeight-halfCursorHeight);const y1=yCenter-halfCursorHeight,y2=y1+cursorHeight;y1>prevY2+1?(0!==i&&canvasCtx.fillRect(cursorX,prevY1,cursorW,prevY2-prevY1),prevY1=y1,prevY2=y2):y2>prevY2&&(prevY2=y2)}canvasCtx.fillRect(cursorX,prevY1,cursorW,prevY2-prevY1)}this._settings.renderBorder&&this._settings.borderColor&&this._settings.overviewRulerLanes>0&&(canvasCtx.beginPath(),canvasCtx.lineWidth=1,canvasCtx.strokeStyle=this._settings.borderColor,canvasCtx.moveTo(0,0),canvasCtx.lineTo(0,canvasHeight),canvasCtx.stroke(),canvasCtx.moveTo(0,0),canvasCtx.lineTo(canvasWidth,0),canvasCtx.stroke())}}