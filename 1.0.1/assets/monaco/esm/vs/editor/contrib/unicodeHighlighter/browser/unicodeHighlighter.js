var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{RunOnceScheduler}from"../../../../base/common/async.js";import{Codicon}from"../../../../base/common/codicons.js";import{MarkdownString}from"../../../../base/common/htmlContent.js";import{Disposable}from"../../../../base/common/lifecycle.js";import*as platform from"../../../../base/common/platform.js";import{InvisibleCharacters}from"../../../../base/common/strings.js";import"./unicodeHighlighter.css";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{inUntrustedWorkspace,unicodeHighlightConfigKeys}from"../../../common/config/editorOptions.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{UnicodeTextModelHighlighter}from"../../../common/services/unicodeTextModelHighlighter.js";import{IEditorWorkerService}from"../../../common/services/editorWorker.js";import{ILanguageService}from"../../../common/languages/language.js";import{isModelDecorationInComment,isModelDecorationInString,isModelDecorationVisible}from"../../../common/viewModel/viewModelDecorations.js";import{HoverParticipantRegistry}from"../../hover/browser/hoverTypes.js";import{MarkdownHover,renderMarkdownHovers}from"../../hover/browser/markdownHoverParticipant.js";import{BannerController}from"./bannerController.js";import*as nls from"../../../../nls.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{IQuickInputService}from"../../../../platform/quickinput/common/quickInput.js";import{registerIcon}from"../../../../platform/theme/common/iconRegistry.js";import{IWorkspaceTrustManagementService}from"../../../../platform/workspace/common/workspaceTrust.js";export const warningIcon=registerIcon("extensions-warning-message",Codicon.warning,nls.localize("warningIcon","Icon shown with a warning message in the extensions editor."));let UnicodeHighlighter=class UnicodeHighlighter extends Disposable{constructor(_editor,_editorWorkerService,_workspaceTrustService,instantiationService){super(),this._editor=_editor,this._editorWorkerService=_editorWorkerService,this._workspaceTrustService=_workspaceTrustService,this._highlighter=null,this._bannerClosed=!1,this._updateState=state=>{if(state&&state.hasMore){if(this._bannerClosed)return;const max=Math.max(state.ambiguousCharacterCount,state.nonBasicAsciiCharacterCount,state.invisibleCharacterCount);let data;if(state.nonBasicAsciiCharacterCount>=max)data={message:nls.localize("unicodeHighlighting.thisDocumentHasManyNonBasicAsciiUnicodeCharacters","This document contains many non-basic ASCII unicode characters"),command:new DisableHighlightingOfNonBasicAsciiCharactersAction};else if(state.ambiguousCharacterCount>=max)data={message:nls.localize("unicodeHighlighting.thisDocumentHasManyAmbiguousUnicodeCharacters","This document contains many ambiguous unicode characters"),command:new DisableHighlightingOfAmbiguousCharactersAction};else{if(!(state.invisibleCharacterCount>=max))throw new Error("Unreachable");data={message:nls.localize("unicodeHighlighting.thisDocumentHasManyInvisibleUnicodeCharacters","This document contains many invisible unicode characters"),command:new DisableHighlightingOfInvisibleCharactersAction}}this._bannerController.show({id:"unicodeHighlightBanner",message:data.message,icon:warningIcon,actions:[{label:data.command.shortLabel,href:`command:${data.command.id}`}],onClose:()=>{this._bannerClosed=!0}})}else this._bannerController.hide()},this._bannerController=this._register(instantiationService.createInstance(BannerController,_editor)),this._register(this._editor.onDidChangeModel((()=>{this._bannerClosed=!1,this._updateHighlighter()}))),this._options=_editor.getOption(115),this._register(_workspaceTrustService.onDidChangeTrust((e=>{this._updateHighlighter()}))),this._register(_editor.onDidChangeConfiguration((e=>{e.hasChanged(115)&&(this._options=_editor.getOption(115),this._updateHighlighter())}))),this._updateHighlighter()}dispose(){this._highlighter&&(this._highlighter.dispose(),this._highlighter=null),super.dispose()}_updateHighlighter(){if(this._updateState(null),this._highlighter&&(this._highlighter.dispose(),this._highlighter=null),!this._editor.hasModel())return;const options=resolveOptions(this._workspaceTrustService.isWorkspaceTrusted(),this._options);if([options.nonBasicASCII,options.ambiguousCharacters,options.invisibleCharacters].every((option=>!1===option)))return;const highlightOptions={nonBasicASCII:options.nonBasicASCII,ambiguousCharacters:options.ambiguousCharacters,invisibleCharacters:options.invisibleCharacters,includeComments:options.includeComments,includeStrings:options.includeStrings,allowedCodePoints:Object.keys(options.allowedCharacters).map((c=>c.codePointAt(0))),allowedLocales:Object.keys(options.allowedLocales).map((locale=>{if("_os"===locale){return(new Intl.NumberFormat).resolvedOptions().locale}return"_vscode"===locale?platform.language:locale}))};this._editorWorkerService.canComputeUnicodeHighlights(this._editor.getModel().uri)?this._highlighter=new DocumentUnicodeHighlighter(this._editor,highlightOptions,this._updateState,this._editorWorkerService):this._highlighter=new ViewportUnicodeHighlighter(this._editor,highlightOptions,this._updateState)}getDecorationInfo(decoration){return this._highlighter?this._highlighter.getDecorationInfo(decoration):null}};UnicodeHighlighter.ID="editor.contrib.unicodeHighlighter",UnicodeHighlighter=__decorate([__param(1,IEditorWorkerService),__param(2,IWorkspaceTrustManagementService),__param(3,IInstantiationService)],UnicodeHighlighter);export{UnicodeHighlighter};function resolveOptions(trusted,options){return{nonBasicASCII:options.nonBasicASCII===inUntrustedWorkspace?!trusted:options.nonBasicASCII,ambiguousCharacters:options.ambiguousCharacters,invisibleCharacters:options.invisibleCharacters,includeComments:options.includeComments===inUntrustedWorkspace?!trusted:options.includeComments,includeStrings:options.includeStrings===inUntrustedWorkspace?!trusted:options.includeStrings,allowedCharacters:options.allowedCharacters,allowedLocales:options.allowedLocales}}let DocumentUnicodeHighlighter=class DocumentUnicodeHighlighter extends Disposable{constructor(_editor,_options,_updateState,_editorWorkerService){super(),this._editor=_editor,this._options=_options,this._updateState=_updateState,this._editorWorkerService=_editorWorkerService,this._model=this._editor.getModel(),this._decorations=this._editor.createDecorationsCollection(),this._updateSoon=this._register(new RunOnceScheduler((()=>this._update()),250)),this._register(this._editor.onDidChangeModelContent((()=>{this._updateSoon.schedule()}))),this._updateSoon.schedule()}dispose(){this._decorations.clear(),super.dispose()}_update(){if(this._model.isDisposed())return;if(!this._model.mightContainNonBasicASCII())return void this._decorations.clear();const modelVersionId=this._model.getVersionId();this._editorWorkerService.computedUnicodeHighlights(this._model.uri,this._options).then((info=>{if(this._model.isDisposed())return;if(this._model.getVersionId()!==modelVersionId)return;this._updateState(info);const decorations=[];if(!info.hasMore)for(const range of info.ranges)decorations.push({range,options:Decorations.instance.getDecorationFromOptions(this._options)});this._decorations.set(decorations)}))}getDecorationInfo(decoration){if(!this._decorations.has(decoration))return null;const model=this._editor.getModel();if(!isModelDecorationVisible(model,decoration))return null;return{reason:computeReason(model.getValueInRange(decoration.range),this._options),inComment:isModelDecorationInComment(model,decoration),inString:isModelDecorationInString(model,decoration)}}};DocumentUnicodeHighlighter=__decorate([__param(3,IEditorWorkerService)],DocumentUnicodeHighlighter);class ViewportUnicodeHighlighter extends Disposable{constructor(_editor,_options,_updateState){super(),this._editor=_editor,this._options=_options,this._updateState=_updateState,this._model=this._editor.getModel(),this._decorations=this._editor.createDecorationsCollection(),this._updateSoon=this._register(new RunOnceScheduler((()=>this._update()),250)),this._register(this._editor.onDidLayoutChange((()=>{this._updateSoon.schedule()}))),this._register(this._editor.onDidScrollChange((()=>{this._updateSoon.schedule()}))),this._register(this._editor.onDidChangeHiddenAreas((()=>{this._updateSoon.schedule()}))),this._register(this._editor.onDidChangeModelContent((()=>{this._updateSoon.schedule()}))),this._updateSoon.schedule()}dispose(){this._decorations.clear(),super.dispose()}_update(){if(this._model.isDisposed())return;if(!this._model.mightContainNonBasicASCII())return void this._decorations.clear();const ranges=this._editor.getVisibleRanges(),decorations=[],totalResult={ranges:[],ambiguousCharacterCount:0,invisibleCharacterCount:0,nonBasicAsciiCharacterCount:0,hasMore:!1};for(const range of ranges){const result=UnicodeTextModelHighlighter.computeUnicodeHighlights(this._model,this._options,range);for(const r of result.ranges)totalResult.ranges.push(r);totalResult.ambiguousCharacterCount+=totalResult.ambiguousCharacterCount,totalResult.invisibleCharacterCount+=totalResult.invisibleCharacterCount,totalResult.nonBasicAsciiCharacterCount+=totalResult.nonBasicAsciiCharacterCount,totalResult.hasMore=totalResult.hasMore||result.hasMore}if(!totalResult.hasMore)for(const range of totalResult.ranges)decorations.push({range,options:Decorations.instance.getDecorationFromOptions(this._options)});this._updateState(totalResult),this._decorations.set(decorations)}getDecorationInfo(decoration){if(!this._decorations.has(decoration))return null;const model=this._editor.getModel(),text=model.getValueInRange(decoration.range);return isModelDecorationVisible(model,decoration)?{reason:computeReason(text,this._options),inComment:isModelDecorationInComment(model,decoration),inString:isModelDecorationInString(model,decoration)}:null}}let UnicodeHighlighterHoverParticipant=class UnicodeHighlighterHoverParticipant{constructor(_editor,_languageService,_openerService){this._editor=_editor,this._languageService=_languageService,this._openerService=_openerService,this.hoverOrdinal=4}computeSync(anchor,lineDecorations){if(!this._editor.hasModel()||1!==anchor.type)return[];const model=this._editor.getModel(),unicodeHighlighter=this._editor.getContribution(UnicodeHighlighter.ID);if(!unicodeHighlighter)return[];const result=[];let index=300;for(const d of lineDecorations){const highlightInfo=unicodeHighlighter.getDecorationInfo(d);if(!highlightInfo)continue;const codePoint=model.getValueInRange(d.range).codePointAt(0),codePointStr=formatCodePointMarkdown(codePoint);let reason;switch(highlightInfo.reason.kind){case 0:reason=nls.localize("unicodeHighlight.characterIsAmbiguous","The character {0} could be confused with the character {1}, which is more common in source code.",codePointStr,formatCodePointMarkdown(highlightInfo.reason.confusableWith.codePointAt(0)));break;case 1:reason=nls.localize("unicodeHighlight.characterIsInvisible","The character {0} is invisible.",codePointStr);break;case 2:reason=nls.localize("unicodeHighlight.characterIsNonBasicAscii","The character {0} is not a basic ASCII character.",codePointStr)}const adjustSettingsArgs={codePoint,reason:highlightInfo.reason,inComment:highlightInfo.inComment,inString:highlightInfo.inString},adjustSettings=nls.localize("unicodeHighlight.adjustSettings","Adjust settings"),uri=`command:${ShowExcludeOptions.ID}?${encodeURIComponent(JSON.stringify(adjustSettingsArgs))}`,markdown=new MarkdownString("",!0).appendMarkdown(reason).appendText(" ").appendLink(uri,adjustSettings);result.push(new MarkdownHover(this,d.range,[markdown],index++))}return result}renderHoverParts(context,hoverParts){return renderMarkdownHovers(context,hoverParts,this._editor,this._languageService,this._openerService)}};UnicodeHighlighterHoverParticipant=__decorate([__param(1,ILanguageService),__param(2,IOpenerService)],UnicodeHighlighterHoverParticipant);export{UnicodeHighlighterHoverParticipant};function codePointToHex(codePoint){return`U+${codePoint.toString(16).padStart(4,"0")}`}function formatCodePointMarkdown(codePoint){let value=`\`${codePointToHex(codePoint)}\``;return InvisibleCharacters.isInvisibleCharacter(codePoint)||(value+=` "${renderCodePointAsInlineCode(codePoint)}"`),value}function renderCodePointAsInlineCode(codePoint){return 96===codePoint?"`` ` ``":"`"+String.fromCodePoint(codePoint)+"`"}function computeReason(char,options){return UnicodeTextModelHighlighter.computeUnicodeHighlightReason(char,options)}class Decorations{constructor(){this.map=new Map}getDecorationFromOptions(options){return this.getDecoration(!options.includeComments,!options.includeStrings)}getDecoration(hideInComments,hideInStrings){const key=`${hideInComments}${hideInStrings}`;let options=this.map.get(key);return options||(options=ModelDecorationOptions.createDynamic({description:"unicode-highlight",stickiness:1,className:"unicode-highlight",showIfCollapsed:!0,overviewRuler:null,minimap:null,hideInCommentTokens:hideInComments,hideInStringTokens:hideInStrings}),this.map.set(key,options)),options}}Decorations.instance=new Decorations;export class DisableHighlightingInCommentsAction extends EditorAction{constructor(){super({id:DisableHighlightingOfAmbiguousCharactersAction.ID,label:nls.localize("action.unicodeHighlight.disableHighlightingInComments","Disable highlighting of characters in comments"),alias:"Disable highlighting of characters in comments",precondition:void 0}),this.shortLabel=nls.localize("unicodeHighlight.disableHighlightingInComments.shortLabel","Disable Highlight In Comments")}run(accessor,editor,args){return __awaiter(this,void 0,void 0,(function*(){const configurationService=null==accessor?void 0:accessor.get(IConfigurationService);configurationService&&this.runAction(configurationService)}))}runAction(configurationService){return __awaiter(this,void 0,void 0,(function*(){yield configurationService.updateValue(unicodeHighlightConfigKeys.includeComments,!1,2)}))}}export class DisableHighlightingInStringsAction extends EditorAction{constructor(){super({id:DisableHighlightingOfAmbiguousCharactersAction.ID,label:nls.localize("action.unicodeHighlight.disableHighlightingInStrings","Disable highlighting of characters in strings"),alias:"Disable highlighting of characters in strings",precondition:void 0}),this.shortLabel=nls.localize("unicodeHighlight.disableHighlightingInStrings.shortLabel","Disable Highlight In Strings")}run(accessor,editor,args){return __awaiter(this,void 0,void 0,(function*(){const configurationService=null==accessor?void 0:accessor.get(IConfigurationService);configurationService&&this.runAction(configurationService)}))}runAction(configurationService){return __awaiter(this,void 0,void 0,(function*(){yield configurationService.updateValue(unicodeHighlightConfigKeys.includeStrings,!1,2)}))}}export class DisableHighlightingOfAmbiguousCharactersAction extends EditorAction{constructor(){super({id:DisableHighlightingOfAmbiguousCharactersAction.ID,label:nls.localize("action.unicodeHighlight.disableHighlightingOfAmbiguousCharacters","Disable highlighting of ambiguous characters"),alias:"Disable highlighting of ambiguous characters",precondition:void 0}),this.shortLabel=nls.localize("unicodeHighlight.disableHighlightingOfAmbiguousCharacters.shortLabel","Disable Ambiguous Highlight")}run(accessor,editor,args){return __awaiter(this,void 0,void 0,(function*(){const configurationService=null==accessor?void 0:accessor.get(IConfigurationService);configurationService&&this.runAction(configurationService)}))}runAction(configurationService){return __awaiter(this,void 0,void 0,(function*(){yield configurationService.updateValue(unicodeHighlightConfigKeys.ambiguousCharacters,!1,2)}))}}DisableHighlightingOfAmbiguousCharactersAction.ID="editor.action.unicodeHighlight.disableHighlightingOfAmbiguousCharacters";export class DisableHighlightingOfInvisibleCharactersAction extends EditorAction{constructor(){super({id:DisableHighlightingOfInvisibleCharactersAction.ID,label:nls.localize("action.unicodeHighlight.disableHighlightingOfInvisibleCharacters","Disable highlighting of invisible characters"),alias:"Disable highlighting of invisible characters",precondition:void 0}),this.shortLabel=nls.localize("unicodeHighlight.disableHighlightingOfInvisibleCharacters.shortLabel","Disable Invisible Highlight")}run(accessor,editor,args){return __awaiter(this,void 0,void 0,(function*(){const configurationService=null==accessor?void 0:accessor.get(IConfigurationService);configurationService&&this.runAction(configurationService)}))}runAction(configurationService){return __awaiter(this,void 0,void 0,(function*(){yield configurationService.updateValue(unicodeHighlightConfigKeys.invisibleCharacters,!1,2)}))}}DisableHighlightingOfInvisibleCharactersAction.ID="editor.action.unicodeHighlight.disableHighlightingOfInvisibleCharacters";export class DisableHighlightingOfNonBasicAsciiCharactersAction extends EditorAction{constructor(){super({id:DisableHighlightingOfNonBasicAsciiCharactersAction.ID,label:nls.localize("action.unicodeHighlight.disableHighlightingOfNonBasicAsciiCharacters","Disable highlighting of non basic ASCII characters"),alias:"Disable highlighting of non basic ASCII characters",precondition:void 0}),this.shortLabel=nls.localize("unicodeHighlight.disableHighlightingOfNonBasicAsciiCharacters.shortLabel","Disable Non ASCII Highlight")}run(accessor,editor,args){return __awaiter(this,void 0,void 0,(function*(){const configurationService=null==accessor?void 0:accessor.get(IConfigurationService);configurationService&&this.runAction(configurationService)}))}runAction(configurationService){return __awaiter(this,void 0,void 0,(function*(){yield configurationService.updateValue(unicodeHighlightConfigKeys.nonBasicASCII,!1,2)}))}}DisableHighlightingOfNonBasicAsciiCharactersAction.ID="editor.action.unicodeHighlight.disableHighlightingOfNonBasicAsciiCharacters";export class ShowExcludeOptions extends EditorAction{constructor(){super({id:ShowExcludeOptions.ID,label:nls.localize("action.unicodeHighlight.showExcludeOptions","Show Exclude Options"),alias:"Show Exclude Options",precondition:void 0})}run(accessor,editor,args){return __awaiter(this,void 0,void 0,(function*(){const{codePoint,reason,inString,inComment}=args,char=String.fromCodePoint(codePoint),quickPickService=accessor.get(IQuickInputService),configurationService=accessor.get(IConfigurationService);const options=[];if(0===reason.kind)for(const locale of reason.notAmbiguousInLocales)options.push({label:nls.localize("unicodeHighlight.allowCommonCharactersInLanguage",'Allow unicode characters that are more common in the language "{0}".',locale),run:()=>__awaiter(this,void 0,void 0,(function*(){excludeLocaleFromBeingHighlighted(configurationService,[locale])}))});if(options.push({label:function getExcludeCharFromBeingHighlightedLabel(codePoint){return InvisibleCharacters.isInvisibleCharacter(codePoint)?nls.localize("unicodeHighlight.excludeInvisibleCharFromBeingHighlighted","Exclude {0} (invisible character) from being highlighted",codePointToHex(codePoint)):nls.localize("unicodeHighlight.excludeCharFromBeingHighlighted","Exclude {0} from being highlighted",`${codePointToHex(codePoint)} "${char}"`)}(codePoint),run:()=>excludeCharFromBeingHighlighted(configurationService,[codePoint])}),inComment){const action=new DisableHighlightingInCommentsAction;options.push({label:action.label,run:()=>__awaiter(this,void 0,void 0,(function*(){return action.runAction(configurationService)}))})}else if(inString){const action=new DisableHighlightingInStringsAction;options.push({label:action.label,run:()=>__awaiter(this,void 0,void 0,(function*(){return action.runAction(configurationService)}))})}if(0===reason.kind){const action=new DisableHighlightingOfAmbiguousCharactersAction;options.push({label:action.label,run:()=>__awaiter(this,void 0,void 0,(function*(){return action.runAction(configurationService)}))})}else if(1===reason.kind){const action=new DisableHighlightingOfInvisibleCharactersAction;options.push({label:action.label,run:()=>__awaiter(this,void 0,void 0,(function*(){return action.runAction(configurationService)}))})}else if(2===reason.kind){const action=new DisableHighlightingOfNonBasicAsciiCharactersAction;options.push({label:action.label,run:()=>__awaiter(this,void 0,void 0,(function*(){return action.runAction(configurationService)}))})}else expectNever(reason);const result=yield quickPickService.pick(options,{title:nls.localize("unicodeHighlight.configureUnicodeHighlightOptions","Configure Unicode Highlight Options")});result&&(yield result.run())}))}}function excludeCharFromBeingHighlighted(configurationService,charCodes){return __awaiter(this,void 0,void 0,(function*(){const existingValue=configurationService.getValue(unicodeHighlightConfigKeys.allowedCharacters);let value;value="object"==typeof existingValue&&existingValue?existingValue:{};for(const charCode of charCodes)value[String.fromCodePoint(charCode)]=!0;yield configurationService.updateValue(unicodeHighlightConfigKeys.allowedCharacters,value,2)}))}function excludeLocaleFromBeingHighlighted(configurationService,locales){var _a;return __awaiter(this,void 0,void 0,(function*(){const existingValue=null===(_a=configurationService.inspect(unicodeHighlightConfigKeys.allowedLocales).user)||void 0===_a?void 0:_a.value;let value;value="object"==typeof existingValue&&existingValue?Object.assign({},existingValue):{};for(const locale of locales)value[locale]=!0;yield configurationService.updateValue(unicodeHighlightConfigKeys.allowedLocales,value,2)}))}function expectNever(value){throw new Error(`Unexpected value: ${value}`)}ShowExcludeOptions.ID="editor.action.unicodeHighlight.showExcludeOptions",registerEditorAction(DisableHighlightingOfAmbiguousCharactersAction),registerEditorAction(DisableHighlightingOfInvisibleCharactersAction),registerEditorAction(DisableHighlightingOfNonBasicAsciiCharactersAction),registerEditorAction(ShowExcludeOptions),registerEditorContribution(UnicodeHighlighter.ID,UnicodeHighlighter),HoverParticipantRegistry.register(UnicodeHighlighterHoverParticipant);