import{Emitter}from"../../base/common/event.js";import{toDisposable}from"../../base/common/lifecycle.js";import{shouldSynchronizeModel}from"./model.js";import{score}from"./languageSelector.js";function isExclusive(selector){return"string"!=typeof selector&&(Array.isArray(selector)?selector.every(isExclusive):!!selector.exclusive)}class MatchCandidate{constructor(uri,languageId,notebookUri,notebookType){this.uri=uri,this.languageId=languageId,this.notebookUri=notebookUri,this.notebookType=notebookType}equals(other){var _a,_b;return this.notebookType===other.notebookType&&this.languageId===other.languageId&&this.uri.toString()===other.uri.toString()&&(null===(_a=this.notebookUri)||void 0===_a?void 0:_a.toString())===(null===(_b=other.notebookUri)||void 0===_b?void 0:_b.toString())}}export class LanguageFeatureRegistry{constructor(_notebookInfoResolver){this._notebookInfoResolver=_notebookInfoResolver,this._clock=0,this._entries=[],this._onDidChange=new Emitter,this.onDidChange=this._onDidChange.event}register(selector,provider){let entry={selector,provider,_score:-1,_time:this._clock++};return this._entries.push(entry),this._lastCandidate=void 0,this._onDidChange.fire(this._entries.length),toDisposable((()=>{if(entry){const idx=this._entries.indexOf(entry);idx>=0&&(this._entries.splice(idx,1),this._lastCandidate=void 0,this._onDidChange.fire(this._entries.length),entry=void 0)}}))}has(model){return this.all(model).length>0}all(model){if(!model)return[];this._updateScores(model);const result=[];for(const entry of this._entries)entry._score>0&&result.push(entry.provider);return result}ordered(model){const result=[];return this._orderedForEach(model,(entry=>result.push(entry.provider))),result}orderedGroups(model){const result=[];let lastBucket,lastBucketScore;return this._orderedForEach(model,(entry=>{lastBucket&&lastBucketScore===entry._score?lastBucket.push(entry.provider):(lastBucketScore=entry._score,lastBucket=[entry.provider],result.push(lastBucket))})),result}_orderedForEach(model,callback){this._updateScores(model);for(const entry of this._entries)entry._score>0&&callback(entry)}_updateScores(model){var _a,_b;const notebookInfo=null===(_a=this._notebookInfoResolver)||void 0===_a?void 0:_a.call(this,model.uri),candidate=notebookInfo?new MatchCandidate(model.uri,model.getLanguageId(),notebookInfo.uri,notebookInfo.type):new MatchCandidate(model.uri,model.getLanguageId(),void 0,void 0);if(!(null===(_b=this._lastCandidate)||void 0===_b?void 0:_b.equals(candidate))){this._lastCandidate=candidate;for(const entry of this._entries)if(entry._score=score(entry.selector,candidate.uri,candidate.languageId,shouldSynchronizeModel(model),candidate.notebookUri,candidate.notebookType),isExclusive(entry.selector)&&entry._score>0){for(const entry of this._entries)entry._score=0;entry._score=1e3;break}this._entries.sort(LanguageFeatureRegistry._compareByScoreAndTime)}}static _compareByScoreAndTime(a,b){return a._score<b._score?1:a._score>b._score?-1:a._time<b._time?1:a._time>b._time?-1:0}}