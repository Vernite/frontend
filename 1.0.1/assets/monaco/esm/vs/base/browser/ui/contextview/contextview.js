import{BrowserFeatures}from"../../canIUse.js";import*as DOM from"../../dom.js";import{Disposable,DisposableStore,toDisposable}from"../../../common/lifecycle.js";import*as platform from"../../../common/platform.js";import{Range}from"../../../common/range.js";import"./contextview.css";export var LayoutAnchorMode;!function(LayoutAnchorMode){LayoutAnchorMode[LayoutAnchorMode.AVOID=0]="AVOID",LayoutAnchorMode[LayoutAnchorMode.ALIGN=1]="ALIGN"}(LayoutAnchorMode||(LayoutAnchorMode={}));export function layout(viewportSize,viewSize,anchor){const layoutAfterAnchorBoundary=anchor.mode===LayoutAnchorMode.ALIGN?anchor.offset:anchor.offset+anchor.size,layoutBeforeAnchorBoundary=anchor.mode===LayoutAnchorMode.ALIGN?anchor.offset+anchor.size:anchor.offset;return 0===anchor.position?viewSize<=viewportSize-layoutAfterAnchorBoundary?layoutAfterAnchorBoundary:viewSize<=layoutBeforeAnchorBoundary?layoutBeforeAnchorBoundary-viewSize:Math.max(viewportSize-viewSize,0):viewSize<=layoutBeforeAnchorBoundary?layoutBeforeAnchorBoundary-viewSize:viewSize<=viewportSize-layoutAfterAnchorBoundary?layoutAfterAnchorBoundary:0}export class ContextView extends Disposable{constructor(container,domPosition){super(),this.container=null,this.delegate=null,this.toDisposeOnClean=Disposable.None,this.toDisposeOnSetContainer=Disposable.None,this.shadowRoot=null,this.shadowRootHostElement=null,this.view=DOM.$(".context-view"),this.useFixedPosition=!1,this.useShadowDOM=!1,DOM.hide(this.view),this.setContainer(container,domPosition),this._register(toDisposable((()=>this.setContainer(null,1))))}setContainer(container,domPosition){var _a;if(this.container&&(this.toDisposeOnSetContainer.dispose(),this.shadowRoot?(this.shadowRoot.removeChild(this.view),this.shadowRoot=null,null===(_a=this.shadowRootHostElement)||void 0===_a||_a.remove(),this.shadowRootHostElement=null):this.container.removeChild(this.view),this.container=null),container){if(this.container=container,this.useFixedPosition=1!==domPosition,this.useShadowDOM=3===domPosition,this.useShadowDOM){this.shadowRootHostElement=DOM.$(".shadow-root-host"),this.container.appendChild(this.shadowRootHostElement),this.shadowRoot=this.shadowRootHostElement.attachShadow({mode:"open"});const style=document.createElement("style");style.textContent=SHADOW_ROOT_CSS,this.shadowRoot.appendChild(style),this.shadowRoot.appendChild(this.view),this.shadowRoot.appendChild(DOM.$("slot"))}else this.container.appendChild(this.view);const toDisposeOnSetContainer=new DisposableStore;ContextView.BUBBLE_UP_EVENTS.forEach((event=>{toDisposeOnSetContainer.add(DOM.addStandardDisposableListener(this.container,event,(e=>{this.onDOMEvent(e,!1)})))})),ContextView.BUBBLE_DOWN_EVENTS.forEach((event=>{toDisposeOnSetContainer.add(DOM.addStandardDisposableListener(this.container,event,(e=>{this.onDOMEvent(e,!0)}),!0))})),this.toDisposeOnSetContainer=toDisposeOnSetContainer}}show(delegate){var _a,_b;this.isVisible()&&this.hide(),DOM.clearNode(this.view),this.view.className="context-view",this.view.style.top="0px",this.view.style.left="0px",this.view.style.zIndex="2575",this.view.style.position=this.useFixedPosition?"fixed":"absolute",DOM.show(this.view),this.toDisposeOnClean=delegate.render(this.view)||Disposable.None,this.delegate=delegate,this.doLayout(),null===(_b=(_a=this.delegate).focus)||void 0===_b||_b.call(_a)}getViewElement(){return this.view}layout(){this.isVisible()&&(!1!==this.delegate.canRelayout||platform.isIOS&&BrowserFeatures.pointerEvents?(this.delegate.layout&&this.delegate.layout(),this.doLayout()):this.hide())}doLayout(){if(!this.isVisible())return;const anchor=this.delegate.getAnchor();let around;if(DOM.isHTMLElement(anchor)){const elementPosition=DOM.getDomNodePagePosition(anchor),zoom=DOM.getDomNodeZoomLevel(anchor);around={top:elementPosition.top*zoom,left:elementPosition.left*zoom,width:elementPosition.width*zoom,height:elementPosition.height*zoom}}else around={top:anchor.y,left:anchor.x,width:anchor.width||1,height:anchor.height||2};const viewSizeWidth=DOM.getTotalWidth(this.view),viewSizeHeight=DOM.getTotalHeight(this.view),anchorPosition=this.delegate.anchorPosition||0,anchorAlignment=this.delegate.anchorAlignment||0;let top,left;if(0===(this.delegate.anchorAxisAlignment||0)){const verticalAnchor={offset:around.top-window.pageYOffset,size:around.height,position:0===anchorPosition?0:1},horizontalAnchor={offset:around.left,size:around.width,position:0===anchorAlignment?0:1,mode:LayoutAnchorMode.ALIGN};top=layout(window.innerHeight,viewSizeHeight,verticalAnchor)+window.pageYOffset,Range.intersects({start:top,end:top+viewSizeHeight},{start:verticalAnchor.offset,end:verticalAnchor.offset+verticalAnchor.size})&&(horizontalAnchor.mode=LayoutAnchorMode.AVOID),left=layout(window.innerWidth,viewSizeWidth,horizontalAnchor)}else{const horizontalAnchor={offset:around.left,size:around.width,position:0===anchorAlignment?0:1},verticalAnchor={offset:around.top,size:around.height,position:0===anchorPosition?0:1,mode:LayoutAnchorMode.ALIGN};left=layout(window.innerWidth,viewSizeWidth,horizontalAnchor),Range.intersects({start:left,end:left+viewSizeWidth},{start:horizontalAnchor.offset,end:horizontalAnchor.offset+horizontalAnchor.size})&&(verticalAnchor.mode=LayoutAnchorMode.AVOID),top=layout(window.innerHeight,viewSizeHeight,verticalAnchor)+window.pageYOffset}this.view.classList.remove("top","bottom","left","right"),this.view.classList.add(0===anchorPosition?"bottom":"top"),this.view.classList.add(0===anchorAlignment?"left":"right"),this.view.classList.toggle("fixed",this.useFixedPosition);const containerPosition=DOM.getDomNodePagePosition(this.container);this.view.style.top=top-(this.useFixedPosition?DOM.getDomNodePagePosition(this.view).top:containerPosition.top)+"px",this.view.style.left=left-(this.useFixedPosition?DOM.getDomNodePagePosition(this.view).left:containerPosition.left)+"px",this.view.style.width="initial"}hide(data){const delegate=this.delegate;this.delegate=null,(null==delegate?void 0:delegate.onHide)&&delegate.onHide(data),this.toDisposeOnClean.dispose(),DOM.hide(this.view)}isVisible(){return!!this.delegate}onDOMEvent(e,onCapture){this.delegate&&(this.delegate.onDOMEvent?this.delegate.onDOMEvent(e,document.activeElement):onCapture&&!DOM.isAncestor(e.target,this.container)&&this.hide())}dispose(){this.hide(),super.dispose()}}ContextView.BUBBLE_UP_EVENTS=["click","keydown","focus","blur"],ContextView.BUBBLE_DOWN_EVENTS=["click"];const SHADOW_ROOT_CSS='\n\t:host {\n\t\tall: initial; /* 1st rule so subsequent properties are reset. */\n\t}\n\n\t@font-face {\n\t\tfont-family: "codicon";\n\t\tfont-display: block;\n\t\tsrc: url("./codicon.ttf?5d4d76ab2ce5108968ad644d591a16a6") format("truetype");\n\t}\n\n\t.codicon[class*=\'codicon-\'] {\n\t\tfont: normal normal normal 16px/1 codicon;\n\t\tdisplay: inline-block;\n\t\ttext-decoration: none;\n\t\ttext-rendering: auto;\n\t\ttext-align: center;\n\t\t-webkit-font-smoothing: antialiased;\n\t\t-moz-osx-font-smoothing: grayscale;\n\t\tuser-select: none;\n\t\t-webkit-user-select: none;\n\t\t-ms-user-select: none;\n\t}\n\n\t:host {\n\t\tfont-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "HelveticaNeue-Light", system-ui, "Ubuntu", "Droid Sans", sans-serif;\n\t}\n\n\t:host-context(.mac) { font-family: -apple-system, BlinkMacSystemFont, sans-serif; }\n\t:host-context(.mac:lang(zh-Hans)) { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", sans-serif; }\n\t:host-context(.mac:lang(zh-Hant)) { font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", sans-serif; }\n\t:host-context(.mac:lang(ja)) { font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic Pro", sans-serif; }\n\t:host-context(.mac:lang(ko)) { font-family: -apple-system, BlinkMacSystemFont, "Nanum Gothic", "Apple SD Gothic Neo", "AppleGothic", sans-serif; }\n\n\t:host-context(.windows) { font-family: "Segoe WPC", "Segoe UI", sans-serif; }\n\t:host-context(.windows:lang(zh-Hans)) { font-family: "Segoe WPC", "Segoe UI", "Microsoft YaHei", sans-serif; }\n\t:host-context(.windows:lang(zh-Hant)) { font-family: "Segoe WPC", "Segoe UI", "Microsoft Jhenghei", sans-serif; }\n\t:host-context(.windows:lang(ja)) { font-family: "Segoe WPC", "Segoe UI", "Yu Gothic UI", "Meiryo UI", sans-serif; }\n\t:host-context(.windows:lang(ko)) { font-family: "Segoe WPC", "Segoe UI", "Malgun Gothic", "Dotom", sans-serif; }\n\n\t:host-context(.linux) { font-family: system-ui, "Ubuntu", "Droid Sans", sans-serif; }\n\t:host-context(.linux:lang(zh-Hans)) { font-family: system-ui, "Ubuntu", "Droid Sans", "Source Han Sans SC", "Source Han Sans CN", "Source Han Sans", sans-serif; }\n\t:host-context(.linux:lang(zh-Hant)) { font-family: system-ui, "Ubuntu", "Droid Sans", "Source Han Sans TC", "Source Han Sans TW", "Source Han Sans", sans-serif; }\n\t:host-context(.linux:lang(ja)) { font-family: system-ui, "Ubuntu", "Droid Sans", "Source Han Sans J", "Source Han Sans JP", "Source Han Sans", sans-serif; }\n\t:host-context(.linux:lang(ko)) { font-family: system-ui, "Ubuntu", "Droid Sans", "Source Han Sans K", "Source Han Sans JR", "Source Han Sans", "UnDotum", "FBaekmuk Gulim", sans-serif; }\n';